<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Helios Dienstplan Â· Duisburg</title>

<!-- Firebase SDKs -->
<!-- API-Key Pre-Loading (standalone, no Firebase dependency) -->
<script>
(function() {
  try {
    const _k = [
      'c2stYW50LWFwaTAzLTNa', 'dGtlODdQZEVXNExkVzNi',
      'eWRlUDRHVExDNGw0MkRE', 'RUgySnc0UmZKbzQxRFhC',
      'MDNKdV9OdFVHZzF5cVFj', 'THRneFl5cERmaDFsZS1S',
      'UTUtdXdZd3FRLUdNcjVR', 'd0FB'
    ].join('');
    if (!localStorage.getItem('dienstplan-ai-key')) {
      localStorage.setItem('dienstplan-ai-key', atob(_k));
    }
  } catch(e) {}
  // Expose a global flag so main script knows API key was attempted
  window.__apiKeyLoaded = true;
})();
</script>

<!-- Firebase (dynamic import â€“ failure is completely silent, app works offline) -->
<script>
(async function() {
  const firebaseConfig = {
    apiKey: "AIzaSyD3HcZOIv6Wyg3_5xoBnSnz-Eb4fgLr0SA",
    authDomain: "dienstplanprogramm.firebaseapp.com",
    projectId: "dienstplanprogramm",
    storageBucket: "dienstplanprogramm.firebasestorage.app",
    messagingSenderId: "193664964493",
    appId: "1:193664964493:web:e99e822739cb13c8df0fc4"
  };
  const APP_ID = "dienstplanprogramm";

  window.__firebaseDB = null;
  window.__firebaseReady = false;
  window.__firebaseAppId = APP_ID;
  window.__firestoreAPI = {};

  try {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js");
    const { getFirestore, doc, setDoc, getDoc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    window.__firebaseDB = db;
    window.__firebaseReady = true;
    window.__firestoreAPI = { doc, setDoc, getDoc, onSnapshot };
    console.log("âœ… Firebase verbunden");
    window.dispatchEvent(new Event('firebaseReady'));
  } catch(e) {
    // Firebase unavailable â€“ app works fully offline with localStorage
    console.info("Firebase nicht verfÃ¼gbar, nutze localStorage.", e.message || '');
    window.dispatchEvent(new Event('firebaseReady'));  // still fire so init() continues
  }
})();
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
/* ==========================================
   CSS VARIABLES & RESET
   ========================================== */
:root {
  /* === CLEAN MINIMAL â€“ LIGHT (inspired by the truck fleet UI) === */
  --helios-red:   #E30613;   /* kept for branding elements */
  --helios-red2:  #c40512;
  --teal:         #5BBFB5;   /* primary accent â€“ mint teal */
  --teal2:        #44A89E;   /* hover / deeper teal */
  --teal-light:   rgba(91,191,181,0.12);

  /* Background */
  --bg:      #E9E9E9;
  --bg-mesh: #E9E9E9;        /* solid â€“ no gradient */

  /* Surfaces */
  --glass:    #FFFFFF;
  --glass2:   #F6F6F6;
  --glass3:   #F0F0F0;
  --glass-border:  rgba(0,0,0,0.06);
  --glass-border2: rgba(0,0,0,0.04);
  --glass-shine:   none;
  --surface:  #FFFFFF;
  --surface2: #F4F4F4;
  --border:   rgba(0,0,0,0.07);

  /* Text */
  --text:  #1A1A1A;
  --text2: #6B6B6B;
  --text3: #8E8E8E;    /* darkened for 4.6:1 on white */

  /* Accent â€“ use teal everywhere instead of red */
  --accent:       #5BBFB5;
  --accent2:      #44A89E;
  --accent-light: rgba(91,191,181,0.12);

  /* Header */
  --header-bg:     #FFFFFF;
  --header-border: rgba(0,0,0,0.07);
  --sidebar-bg:    #FFFFFF;

  /* Table tints */
  --weekend: rgba(91,191,181,0.06);
  --holiday: rgba(255,160,100,0.08);
  --today:   rgba(91,191,181,0.10);

  /* Shadows â€“ soft, barely-there */
  --shadow:       0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.05);
  --shadow-lg:    0 4px 24px rgba(0,0,0,0.10), 0 1px 4px rgba(0,0,0,0.06);
  --shadow-glass: 0 2px 16px rgba(0,0,0,0.07), 0 0 0 1px rgba(0,0,0,0.05);
  --shadow-card:  0 2px 20px rgba(0,0,0,0.07);

  /* Geometry â€“ generous rounding like the design */
  --radius:    14px;
  --radius-sm: 8px;
  --radius-lg: 22px;
  --radius-pill: 100px;
  --transition: 0.18s cubic-bezier(.4,0,.2,1);

  /* Liquid glass blur */
  --blur:    blur(24px) saturate(1.8);
  --blur-sm: blur(16px) saturate(1.6);
  --blur-xs: blur(8px)  saturate(1.4);

  --table-zoom: 1;
}

[data-theme="dark"] {
  /* === CLEAN MINIMAL â€“ DARK === */
  --bg:      #161616;
  --bg-mesh: #161616;

  --glass:    #222222;
  --glass2:   #2A2A2A;
  --glass3:   #303030;
  --glass-border:  rgba(255,255,255,0.08);
  --glass-border2: rgba(255,255,255,0.05);
  --glass-shine:   none;
  --surface:  #222222;
  --surface2: #2A2A2A;
  --border:   rgba(255,255,255,0.08);

  --text:  #F2F2F2;
  --text2: #909090;
  --text3: #585858;

  --accent:       #5BBFB5;
  --accent2:      #44A89E;
  --accent-light: rgba(91,191,181,0.15);

  --header-bg:     #1E1E1E;
  --header-border: rgba(255,255,255,0.07);
  --sidebar-bg:    #1E1E1E;

  --weekend: rgba(91,191,181,0.05);
  --holiday: rgba(255,150,80,0.07);
  --today:   rgba(91,191,181,0.10);

  --shadow:       0 2px 8px rgba(0,0,0,0.40), 0 8px 24px rgba(0,0,0,0.30);
  --shadow-lg:    0 8px 32px rgba(0,0,0,0.50), 0 2px 8px rgba(0,0,0,0.35);
  --shadow-glass: 0 2px 16px rgba(0,0,0,0.40), 0 0 0 1px rgba(255,255,255,0.07);
  --shadow-card:  0 2px 20px rgba(0,0,0,0.40);
  --blur:    blur(24px) saturate(1.8);
  --blur-sm: blur(16px) saturate(1.6);
  --blur-xs: blur(8px)  saturate(1.4);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; }
body {
  font-family: 'DM Sans', 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100%;
  /* overflow:clip = clips visually WITHOUT creating a scroll-container   */
  /* â†’ position:sticky still works. overflow:hidden BREAKS sticky. */
  overflow: clip;
  display: flex;
  flex-direction: column;
  transition: background 0.35s, color 0.25s;
}
/* Gradient mesh background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 15% 10%, rgba(91,191,181,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 80% at 90% 80%, rgba(94,196,176,0.08) 0%, transparent 55%),
    radial-gradient(ellipse 50% 50% at 50% 50%, rgba(255,255,255,0.20) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}
body::after { display: none; }
[data-theme="dark"] #header {
  background: rgba(20,22,28,0.95);
  border-bottom-color: rgba(255,255,255,0.08);
}
[data-theme="dark"] .header-sep { background: rgba(255,255,255,0.10); }
[data-theme="dark"] body::before {
  background:
    radial-gradient(ellipse 80% 60% at 15% 10%, rgba(91,191,181,0.07) 0%, transparent 60%),
    radial-gradient(ellipse 60% 80% at 90% 80%, rgba(94,196,176,0.05) 0%, transparent 55%),
    radial-gradient(ellipse 50% 50% at 50% 50%, rgba(30,35,50,0.40) 0%, transparent 70%);
}

/* ==========================================
   SCROLLBAR
   ========================================== */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.14); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.22); }
[data-theme="dark"] ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.14); }

/* ==========================================
   HEADER â€“ HELIOS CORPORATE
   ========================================== */
#header {
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(20px) saturate(1.6);
  -webkit-backdrop-filter: blur(20px) saturate(1.6);
  color: var(--text);
  padding: 0 16px;
  height: 56px;
  min-height: 56px;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
  z-index: 100;
  border-bottom: 1px solid #e2e6ec;
  box-shadow: 0 1px 0 rgba(0,0,0,0.04), 0 2px 12px rgba(0,0,0,0.05);
  position: relative;
  overflow-x: auto;
  overflow-y: visible;
  scrollbar-width: none;
}
#header::-webkit-scrollbar { display: none; }


/* Header left/right groups */
.header-left {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}
.header-right {
  display: flex;
  align-items: center;
  gap: 5px;
  flex-shrink: 0;
}

/* Group separator in header */
.header-sep {
  width: 1px;
  height: 22px;
  background: #dde1e8;
  flex-shrink: 0;
  margin: 0 2px;
}
/* Spacer pushes right-side items to the right */
.header-spacer { flex: 1; min-width: 8px; }

/* =============================================
   RESPONSIVE LAYOUT MODES
   body[data-layout="desktop"]   â€“ full header
   body[data-layout="compact"]   â€“ hide secondary labels
   body[data-layout="tablet"]    â€“ hide non-essentials
   body[data-layout="mobile"]    â€“ minimal + drawer
   ============================================= */

/* Elements hidden in compact mode */
body[data-layout="compact"] .h-hide-compact { display: none !important; }
body[data-layout="compact"] .header-left,
body[data-layout="compact"] .header-right { gap: 5px; }
body[data-layout="compact"] #header { padding: 0 12px; }
/* compact zoom handled by h-hide-compact */
body[data-layout="compact"] .export-btn span,
body[data-layout="compact"] .csv-btn span { display: none; }

/* Elements hidden in tablet mode */
body[data-layout="tablet"] .h-hide-tablet { display: none !important; }
body[data-layout="tablet"] #header { padding: 0 10px; }
body[data-layout="tablet"] .export-btn span,
body[data-layout="tablet"] .csv-btn span { display: none; }
body[data-layout="tablet"] .export-btn,
body[data-layout="tablet"] .csv-btn,
body[data-layout="tablet"] .save-btn { padding: 6px 10px; }
body[data-layout="tablet"] .month-label { min-width: 90px; font-size: 11px; letter-spacing: 0.5px; }

/* Elements hidden in mobile mode */
body[data-layout="mobile"] .h-hide-mobile { display: none !important; }
body[data-layout="mobile"] #header { padding: 0 8px; }
body[data-layout="mobile"] .export-btn span,
body[data-layout="mobile"] .csv-btn span { display: none; }
body[data-layout="mobile"] .export-btn,
body[data-layout="mobile"] .save-btn { padding: 6px 8px; min-width: 32px; justify-content: center; }
body[data-layout="mobile"] .month-label { min-width: 80px; font-size: 11px; letter-spacing: 0; }

/* Mobile overflow drawer */
#header-overflow-drawer {
  position: fixed;
  top: 58px;
  left: 0; right: 0;
  background: rgba(248,249,250,0.97);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(0,0,0,0.07);
  padding: 10px 14px;
  display: none;
  flex-wrap: wrap;
  gap: 8px;
  z-index: 99;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
}
#header-overflow-drawer.open { display: flex; }

/* Layout toggle button */
.layout-toggle-btn {
  width: 32px; height: 32px;
  border: 1px solid rgba(0,0,0,0.08);
  background: rgba(255,255,255,0.75);
  color: var(--text2);
  border-radius: 9px;
  cursor: pointer;
  font-size: 13px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
  flex-shrink: 0;
  position: relative;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.layout-toggle-btn:hover { background: white; color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.10); }
.layout-toggle-btn[data-layout="desktop"]::after { content: "ðŸ–¥"; }
.layout-toggle-btn[data-layout="compact"]::after { content: "ðŸ’»"; }
.layout-toggle-btn[data-layout="tablet"]::after  { content: "ðŸ“±"; }
.layout-toggle-btn[data-layout="mobile"]::after  { content: "ðŸ“Ÿ"; }

/* Auto-responsive media queries (applied when no manual override) */
body:not([data-layout-manual]) {
  /* These just set class names â€“ actual hiding done above */
}
@media (max-width: 1380px) {
  body:not([data-layout-manual]) .h-hide-compact { display: none !important; }
  body:not([data-layout-manual]) #header { padding: 0 12px; }
}
@media (max-width: 1100px) {
  body:not([data-layout-manual]) .h-hide-tablet { display: none !important; }
  body:not([data-layout-manual]) #header { padding: 0 10px; }
  body:not([data-layout-manual]) .month-label { min-width: 90px; font-size: 11px; }
}
@media (max-width: 900px) {
  body:not([data-layout-manual]) .h-hide-mobile { display: none !important; }
  body:not([data-layout-manual]) #header { gap: 6px; padding: 0 8px; }
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.logo-icon {
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.logo-text { line-height: 1.2; }
.logo-title { font-weight: 700; font-size: 12px; letter-spacing: 0.6px; color: var(--text); text-transform: uppercase; }
.logo-sub { font-size: 9.5px; color: var(--helios-red); font-weight: 600; letter-spacing: 0.8px; text-transform: uppercase; }

.header-sep-old { width: 1px; height: 28px; background: var(--header-border); flex-shrink: 0; }

.view-toggle {
  display: flex;
  background: rgba(0,0,0,0.05);
  border: 1px solid rgba(0,0,0,0.08);
  border-radius: 10px;
  padding: 3px;
  gap: 2px;
  flex-shrink: 0;
}
.view-btn {
  padding: 5px 14px;
  border: none;
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  border-radius: 7px;
  font-family: inherit;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.4px;
  transition: all var(--transition);
}
.view-btn.active {
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(12px);
  color: var(--text);
  box-shadow: 0 2px 8px rgba(0,0,0,0.09), inset 0 1px 0 rgba(255,255,255,1);
}
.view-btn:not(.active):hover { background: rgba(0,0,0,0.06); color: var(--text); }

.month-nav {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}
.month-nav button {
  width: 28px; height: 28px;
  border: 1px solid rgba(255,255,255,0.65);
  background: rgba(255,255,255,0.62);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  color: var(--text2);
  box-shadow: 0 1px 4px rgba(0,0,0,0.07), inset 0 1px 0 rgba(255,255,255,0.9);
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.month-nav button:hover { background: rgba(255,255,255,0.92); color: var(--text); box-shadow: 0 2px 10px rgba(0,0,0,0.10), inset 0 1px 0 rgba(255,255,255,1); }
.month-label {
  font-weight: 700;
  font-size: 14px;
  letter-spacing: 1px;
  min-width: 130px;
  text-align: center;
  font-family: 'DM Sans', sans-serif;
  color: var(--text);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background var(--transition);
}
.month-label:hover { background: rgba(0,0,0,0.05); }

.zoom-control {
  display: flex;
  align-items: center;
  gap: 7px;
  flex-shrink: 0;
}
.zoom-control button {
  width: 24px; height: 24px;
  border: 1px solid rgba(0,0,0,0.09);
  background: rgba(255,255,255,0.8);
  color: var(--text2);
  border-radius: 50%;
  cursor: pointer;
  font-size: 15px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
}
.zoom-control button:hover { background: white; color: var(--text); }
.zoom-slider {
  -webkit-appearance: none;
  width: 70px; height: 3px;
  border-radius: 2px;
  background: rgba(0,0,0,0.12);
  outline: none;
  cursor: pointer;
}
.zoom-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 13px; height: 13px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(91,127,255,0.5);
}
.zoom-label {
  font-size: 10px;
  color: var(--text3);
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  min-width: 32px;
}

.workdays-badge {
  background: rgba(94,196,176,0.12);
  color: var(--teal2);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid rgba(94,196,176,0.3);
  flex-shrink: 0;
  letter-spacing: 0.3px;
}

.header-spacer { flex: 1; }

.sync-badge {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 500;
  flex-shrink: 0;
  backdrop-filter: var(--blur-sm);
}
.sync-badge.online  { background: rgba(94,196,176,0.12); color: var(--teal2); border: 1px solid rgba(94,196,176,0.30); }
.sync-badge.offline { background: rgba(0,0,0,0.06); color: var(--text3); border: 1px solid rgba(0,0,0,0.10); }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; }
.sync-badge.online  .sync-dot { background: #10b981; animation: pulse 2s infinite; }
.sync-badge.offline .sync-dot { background: #ef4444; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

.header-btn {
  width: 32px; height: 32px;
  border: 1px solid rgba(255,255,255,0.65);
  background: rgba(255,255,255,0.62);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  color: var(--text2);
  border-radius: 9px;
  cursor: pointer;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
  flex-shrink: 0;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07), inset 0 1px 0 rgba(255,255,255,0.90);
}
.header-btn:hover {
  background: rgba(255,255,255,0.90);
  border-color: rgba(255,255,255,0.85);
  color: var(--text);
  box-shadow: 0 2px 10px rgba(0,0,0,0.10), inset 0 1px 0 rgba(255,255,255,1);
}
.header-btn.active { background: var(--teal); border-color: var(--teal2); color: white; box-shadow: 0 2px 8px rgba(91,191,181,0.35); }
.header-btn.locked { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.3); color: #ef4444; }

.export-btn, .save-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 13px;
  border-radius: 7px;
  cursor: pointer;
  font-family: inherit;
  font-size: 11.5px;
  font-weight: 600;
  transition: all var(--transition);
  flex-shrink: 0;
  border: 1px solid transparent;
  white-space: nowrap;
}
.export-btn {
  background: rgba(255,255,255,0.62);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  color: var(--text2);
  border: 1px solid rgba(255,255,255,0.65);
  box-shadow: 0 1px 4px rgba(0,0,0,0.07), inset 0 1px 0 rgba(255,255,255,0.90);
}
.export-btn:hover {
  background: rgba(255,255,255,0.90);
  color: var(--text);
  box-shadow: 0 2px 10px rgba(0,0,0,0.10), inset 0 1px 0 rgba(255,255,255,1);
}
.save-btn {
  background: linear-gradient(135deg, var(--teal), var(--teal2));
  color: white;
  box-shadow: 0 2px 10px rgba(91,191,181,0.40), inset 0 1px 0 rgba(255,255,255,0.25);
  border-color: var(--teal2);
}
.save-btn:hover {
  background: linear-gradient(135deg, #68d0c4, var(--teal));
  box-shadow: 0 4px 16px rgba(91,191,181,0.55), inset 0 1px 0 rgba(255,255,255,0.30);
  transform: translateY(-1px);
}

/* ==========================================
   DEPT TABS BAR
   ========================================== */
#dept-bar {
  background: rgba(255,255,255,0.65);
  backdrop-filter: blur(16px) saturate(1.6);
  -webkit-backdrop-filter: blur(16px) saturate(1.6);
  border-bottom: 1px solid rgba(255,255,255,0.50);
  box-shadow: 0 1px 0 rgba(0,0,0,0.05);
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 4px;
  height: 38px;
  position: relative;
  flex-shrink: 0;
  z-index: 90;
  overflow-x: auto;
  overflow-y: hidden;
}
#dept-bar::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 5%, rgba(255,255,255,0.85) 30%, rgba(255,255,255,0.85) 70%, transparent 95%);
  pointer-events: none;
}
#dept-bar::-webkit-scrollbar { height: 3px; }
#dept-bar::-webkit-scrollbar-thumb { background: rgba(91,191,181,0.3); }

.dept-tab {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 4px 12px;
  border-radius: 7px;
  border: 1px solid transparent;
  font-size: 11.5px;
  font-weight: 600;
  cursor: pointer;
  color: var(--text2);
  white-space: nowrap;
  transition: all 0.18s;
  position: relative;
  flex-shrink: 0;
  user-select: none;
}
.dept-tab:hover { color: var(--text); background: rgba(0,0,0,0.06); }
.dept-tab.active {
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-color: rgba(255,255,255,0.75);
  color: var(--text);
  box-shadow: 0 2px 8px rgba(0,0,0,0.09), inset 0 1px 0 rgba(255,255,255,1);
}
.dept-tab-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.dept-tab-unsaved {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: #f59e0b;
  flex-shrink: 0;
  display: none;
}
.dept-tab.has-unsaved .dept-tab-unsaved { display: block; }

.dept-tab-add {
  padding: 4px 10px;
  border-radius: 7px;
  border: 1px dashed rgba(0,0,0,0.18);
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  color: var(--text3);
  white-space: nowrap;
  transition: all 0.18s;
  flex-shrink: 0;
  background: transparent;
}
.dept-tab-add:hover { color: var(--text2); border-color: rgba(0,0,0,0.35); background: rgba(0,0,0,0.04); }

.dept-bar-spacer { flex: 1; }

.dept-manage-btn {
  padding: 3px 9px;
  border-radius: 6px;
  border: 1px solid rgba(0,0,0,0.09);
  background: rgba(255,255,255,0.7);
  color: var(--text3);
  font-size: 10.5px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.18s;
  flex-shrink: 0;
}
.dept-manage-btn:hover { background: white; color: var(--text2); }

/* Save button unsaved-dot indicator */
.save-btn { position: relative; }
.save-btn .unsaved-dot {
  position: absolute;
  top: -3px; right: -3px;
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #f59e0b;
  border: 2px solid var(--header-bg);
  display: none;
}
body.has-unsaved .save-btn .unsaved-dot { display: block; }

/* ==========================================
   MAIN LAYOUT
   ========================================== */
#main {
  display: flex;
  flex: 1;
  min-height: 0; /* lets flex children shrink + scroll; never use overflow:hidden here */
}

/* ==========================================
   SIDEBAR â€“ LIQUID GLASS
   ========================================== */
#sidebar {
  width: 72px;
  background: rgba(255,255,255,0.72);
  backdrop-filter: blur(20px) saturate(1.8);
  -webkit-backdrop-filter: blur(20px) saturate(1.8);
  box-shadow: 1px 0 0 rgba(255,255,255,0.60), 2px 0 12px rgba(0,0,0,0.06);
  border-right: 1px solid rgba(255,255,255,0.55);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 0;
  gap: 5px;
  overflow-y: auto;
  flex-shrink: 0;
  border-right: 1px solid var(--header-border);
  position: relative;
  z-index: 1;
}

.sidebar-shift-btn {
  width: 46px; height: 42px;
  border: 1px solid rgba(0,0,0,0.10);
  border-radius: 11px;
  cursor: grab;
  font-weight: 700;
  font-size: 11px;
  font-family: 'DM Mono', 'Courier New', monospace;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  transition: all var(--transition);
  position: relative;
  letter-spacing: 0.3px;
  gap: 2px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.09), inset 0 1px 0 rgba(255,255,255,0.6);
}
.sidebar-shift-btn:active { cursor: grabbing; }
.sidebar-shift-btn:hover { transform: scale(1.1) translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.7); }
.sidebar-shift-btn.selected {
  box-shadow: 0 0 0 2.5px var(--teal), 0 6px 16px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6);
  transform: scale(1.05);
}
.sidebar-shift-btn.dragging-shift  { opacity: 0.35; transform: scale(0.9); cursor: grabbing; }
.sidebar-shift-btn.drag-over-shift { box-shadow: 0 0 0 2.5px var(--accent), 0 4px 14px rgba(0,0,0,0.3); transform: scale(1.06); }
.sidebar-shift-btn span { font-size: 7px; font-weight: 500; font-family: 'DM Sans', system-ui, sans-serif; opacity: 0.80; }

.sidebar-divider { width: 34px; height: 1px; background: rgba(0,0,0,0.07); margin: 3px 0; }

/* ==========================================
   TABLE CONTAINER â€“ GLASS
   ========================================== */
#table-container {
  flex: 1;
  min-height: 0;
  overflow: auto;
  padding: 16px;
  background: linear-gradient(150deg, rgba(91,191,181,0.06) 0%, rgba(255,255,255,0.02) 50%, transparent 100%);
  position: relative;
  z-index: 1;
  scrollbar-width: thin;
  scrollbar-color: rgba(0,0,0,0.14) transparent;
}
#table-container::-webkit-scrollbar { width: 6px; height: 6px; }
#table-container::-webkit-scrollbar-track { background: transparent; }
#table-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.13); border-radius: 10px; }
#table-container::-webkit-scrollbar-corner { background: transparent; }
#table-container::before { display: none; }

#plan-wrapper {
  /* NO backdrop-filter â€” creates a stacking context that breaks position:sticky */
  background: #ffffff;
  border-radius: 20px;
  overflow: visible;
  min-width: fit-content;
  position: relative;
  border: 1px solid #dde1e8;
  box-shadow:
    0 4px 24px rgba(0,0,0,0.07),
    0 1px 4px rgba(0,0,0,0.04);
}
#plan-wrapper::before { display: none; }
[data-theme="dark"] #plan-wrapper {
  background: #1e2028;
  border-color: rgba(255,255,255,0.08);
  box-shadow: 0 4px 24px rgba(0,0,0,0.40);
}


/* ==========================================
   TABLE
   ========================================== */
#plan-table {
  border-collapse: collapse;
  font-size: 12px;
  width: 100%;
  /* NOTE: zoom (not transform:scale) is used for zooming so sticky headers still work */
  /* NO overflow:hidden here â€“ it would break position:sticky on thead th and .employee-cell */
}

/* Header row â€“ sticky top. NO backdrop-filter here: it creates a new stacking context
   that causes sticky td cells to appear BEHIND th cells on Chrome. Use solid bg. */
#plan-table thead th {
  background: #f4f5f7;
  color: var(--text2);
  padding: 0;
  white-space: nowrap;
  font-weight: 600;
  letter-spacing: 0.3px;
  border: none;
  position: sticky;
  top: 0;
  z-index: 12;
  box-shadow: 0 1px 0 rgba(0,0,0,0.08);
}

/* Corner: sticky top + left â€“ z-index must beat all other sticky cells */
#plan-table thead th.emp-th {
  z-index: 25;
  left: 0;
  background: #f2f3f6 !important;
  box-shadow: 4px 0 14px rgba(0,0,0,0.08), 0 1px 0 rgba(0,0,0,0.08);
}
[data-theme="dark"] #plan-table thead th.emp-th {
  background: #1a1c22 !important;
}
/* Stat column headers */
#plan-table thead th.stat-th {
  z-index: 16;
  background: #f3f4f7 !important;
}
[data-theme="dark"] #plan-table thead th.stat-th {
  background: #1b1d24 !important;
}

.th-inner {
  padding: 6px 5px;
  border-right: 1px solid rgba(0,0,0,0.06);
  min-height: 60px;
  height: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1px;
}

#plan-table thead th {
  background: #f4f5f7 !important;
  color: var(--text2) !important;
  border-color: rgba(0,0,0,0.06) !important;
}
#plan-table thead th.weekend { background: #f6f7f9 !important; }
#plan-table thead th.today-col { 
  background: #ecf9f7 !important;
  border-bottom: 2px solid var(--teal) !important;
  color: var(--teal2) !important;
}
[data-theme="dark"] #plan-table thead th { background: #1e2028 !important; color: rgba(255,255,255,0.65) !important; }

.th-employee { min-width: 150px; align-items: flex-start !important; padding-left: 14px !important; }
.col-stat { min-width: 38px; font-size: 11px; font-family: 'JetBrains Mono', 'Courier New', monospace; }

.th-day-num {
  font-size: 15px;
  font-weight: 700;
  font-family: 'DM Mono', 'Courier New', monospace;
  line-height: 1;
  color: #1f2937;           /* slightly softer than pure black */
}
.th-day-name {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #6b7280;           /* solid #6b7280 = 4.7:1 on #f4f5f7 */
}

.th-weekend { background: #f6f7f9 !important; }
.th-holiday { background: #fef2f2 !important; color: #991b1b !important; }
.th-today   { background: #ecf9f7 !important; color: #2a9d8f !important; }

/* Warning pulse on understaffed days â€“ scales with zoom */
:root { --table-zoom: 1; }
.warn-dot {
  width: calc(8px / var(--table-zoom));
  height: calc(8px / var(--table-zoom));
  min-width: 5px; min-height: 5px;
  max-width: 14px; max-height: 14px;
  border-radius: 50%;
  background: #f59e0b;
  margin-top: 1px;
  flex-shrink: 0;
  animation: warnPulse 1.4s ease-in-out infinite;
}
.warn-dot.critical {
  background: #ef4444;
  animation: warnPulseCritical 1.0s ease-in-out infinite;
}
@keyframes warnPulse {
  0%   { box-shadow: 0 0 0 0 rgba(245,158,11,0.8); transform: scale(1); }
  50%  { box-shadow: 0 0 0 calc(5px / var(--table-zoom)) rgba(245,158,11,0); transform: scale(1.2); }
  100% { box-shadow: 0 0 0 0 rgba(245,158,11,0); transform: scale(1); }
}
@keyframes warnPulseCritical {
  0%   { box-shadow: 0 0 0 0 rgba(239,68,68,0.9); transform: scale(1); }
  50%  { box-shadow: 0 0 0 calc(6px / var(--table-zoom)) rgba(239,68,68,0); transform: scale(1.25); }
  100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); transform: scale(1); }
}
/* Warn row: dot + labels inline */
.warn-row {
  display: flex;
  align-items: center;
  gap: calc(3px / var(--table-zoom));
  justify-content: center;
  margin-top: 2px;
  flex-wrap: wrap;
  max-width: 100%;
  overflow: hidden;
}
.warn-label {
  font-size: calc(8px / var(--table-zoom));
  font-weight: 800;
  font-family: 'DM Mono', 'Courier New', monospace;
  letter-spacing: 0;
  line-height: 1;
  background: rgba(180,100,0,0.14);
  color: #92400e;          /* dark amber â€“ 5.6:1 contrast on light bg */
  border-radius: calc(3px / var(--table-zoom));
  padding: calc(1.5px / var(--table-zoom)) calc(3.5px / var(--table-zoom));
  white-space: nowrap;
}
.warn-label.critical {
  background: rgba(180,0,0,0.13);
  color: #991b1b;          /* dark red â€“ 7.5:1 contrast */
}

/* Cells */
#plan-table td {
  border-right: 1px solid #e8eaed;
  border-bottom: 1px solid #e8eaed;
  padding: 0;
  vertical-align: top;
}
[data-theme="dark"] #plan-table td {
  border-right-color: rgba(255,255,255,0.06);
  border-bottom-color: rgba(255,255,255,0.06);
}

.employee-cell {
  min-width: 155px;
  padding: 7px 10px 7px 14px;
  cursor: pointer;
  /* Solid background â€” NO backdrop-filter (breaks stacking context) */
  background: #f7f8fa;
  position: sticky;
  left: 0;
  z-index: 8;
  border-right: 1.5px solid #dde1e8 !important;
  box-shadow: 4px 0 16px rgba(0,0,0,0.07);
}
[data-theme="dark"] .employee-cell {
  background: #1c1e26;
  border-right-color: rgba(255,255,255,0.08) !important;
  box-shadow: 4px 0 16px rgba(0,0,0,0.45);
}
.employee-cell:hover { background: #edf7f5; }
[data-theme="dark"] .employee-cell:hover { background: #22282e; }
.emp-name { font-weight: 700; font-size: 11.5px; color: var(--text); letter-spacing: 0.1px; }
[data-theme="dark"] .emp-name { color: #e8eaed; }
.emp-role  { font-size: 9.5px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.6px; margin-top: 1px; }
[data-theme="dark"] .emp-role { color: #6b7280; }

.stat-cell {
  text-align: center;
  vertical-align: middle;
  padding: 6px 4px;
  font-family: 'DM Mono', 'Courier New', monospace;
  font-size: 11px;
  font-weight: 600;
  background: #f5f6f8;
  position: sticky;
  z-index: 6;
  color: var(--text);
  border-right: 1px solid #dde1e8;
  box-shadow: 2px 0 8px rgba(0,0,0,0.04);
}
[data-theme="dark"] .stat-cell {
  background: #1c1e26;
  color: #9aa4c0;
  border-right-color: rgba(255,255,255,0.07);
}
.stat-cell.negative { color: #c81e1e; }
.stat-cell.positive { color: #15803d; }
.stat-vz { color: #1d4ed8; }
[data-theme="dark"] .stat-cell.negative { color: #f87171; }
[data-theme="dark"] .stat-cell.positive { color: #34d399; }
[data-theme="dark"] .stat-vz { color: #7da4ff; }

.day-cell {
  min-width: 54px;
  width: 54px;
  min-height: 56px;
  text-align: center;
  vertical-align: top;
  cursor: pointer;
  transition: background 0.1s;
  position: relative;
  padding-bottom: 4px;
  background: #ffffff;
}
[data-theme="dark"] .day-cell { background: #22242c; }
/* Cells with notes get a bit more height so note chip fits */
.day-cell.has-note { min-height: 72px; }
.day-cell:hover { background: #e8f8f6 !important; }
[data-theme="dark"] .day-cell:hover { background: rgba(60,80,160,0.25) !important; }
.day-cell.weekend  { background: #fdfaf0; }
.day-cell.holiday  { background: #fff5f5; }
.day-cell.today-col{ background: #edfaf8; }
[data-theme="dark"] .day-cell.weekend  { background: #2a2418; }
[data-theme="dark"] .day-cell.holiday  { background: #2a1a1a; }
[data-theme="dark"] .day-cell.today-col{ background: #182e2a; }

/* Note-edit overlay on hover */
.day-cell:hover .note-edit-btn { opacity: 1; }
.note-edit-btn {
  position: absolute;
  top: 2px; right: 2px;
  width: 14px; height: 14px;
  border-radius: 3px;
  background: rgba(37, 99, 235, 0.15);
  border: none;
  cursor: pointer;
  font-size: 9px;
  display: flex; align-items: center; justify-content: center;
  opacity: 0;
  transition: opacity 0.15s, background 0.15s;
  color: var(--accent);
  z-index: 2;
  padding: 0;
}
.note-edit-btn:hover { background: rgba(37, 99, 235, 0.3); }

.shift-badge {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 28px;
  border-radius: 6px;
  font-weight: 700;
  font-size: 11px;
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  margin-top: 5px;
  letter-spacing: 0.3px;
  line-height: 1;
  transition: transform 0.1s;
  cursor: pointer;
  position: relative;
}
.shift-badge:hover { transform: scale(1.08); }
.shift-badge .note-dot {
  position: absolute;
  top: -3px; right: -3px;
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #f59e0b;
  border: 1.5px solid var(--surface);
  box-shadow: 0 0 4px rgba(245,158,11,0.6);
}
/* Tausch-Marker */
.shift-badge .swap-dot {
  position: absolute;
  top: -3px; left: -3px;
  width: 14px; height: 14px;
  border-radius: 50%;
  background: linear-gradient(135deg, #06b6d4, #0ea5e9);
  border: 1.5px solid var(--surface);
  box-shadow: 0 0 6px rgba(6,182,212,0.7);
  display: flex; align-items: center; justify-content: center;
  font-size: 8px;
  animation: swapPulse 2s ease-in-out infinite;
}
@keyframes swapPulse {
  0%,100% { box-shadow: 0 0 4px rgba(6,182,212,0.7); }
  50%      { box-shadow: 0 0 10px rgba(6,182,212,1); }
}

/* Stats Modal */
.stats-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
.stats-table th {
  text-align: left;
  padding: 8px 10px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text3);
  border-bottom: 1.5px solid var(--border);
}
.stats-table td {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
  vertical-align: middle;
}
.stats-table tr:last-child td { border-bottom: none; }
.stats-table tr:hover td { background: var(--glass2); }
.stats-bar-wrap {
  width: 90px;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.stats-bar {
  height: 100%;
  border-radius: 3px;
  transition: width 0.4s ease;
}
.stats-summary {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}
.stats-card {
  background: rgba(255,255,255,0.42);
  backdrop-filter: var(--blur-sm);
  -webkit-backdrop-filter: var(--blur-sm);
  border: 1px solid rgba(255,255,255,0.70);
  border-top: 1px solid rgba(255,255,255,0.85);
  border-radius: var(--radius);
  padding: 12px 14px;
  text-align: center;
  box-shadow: 0 4px 16px rgba(20,40,80,0.10),
              inset 0 1px 0 rgba(255,255,255,0.80);
}
[data-theme="dark"] .stats-card {
  background: rgba(20,32,60,0.55);
  border-color: rgba(255,255,255,0.10);
  border-top-color: rgba(255,255,255,0.14);
  box-shadow: 0 4px 16px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.08);
}
.stats-card-val {
  font-size: 22px;
  font-weight: 700;
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  color: var(--accent);
  line-height: 1;
}
.stats-card-lbl {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.6px;
  margin-top: 4px;
}

/* Inline note chip below badge */
.shift-note-tag {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 2px auto 0;
  padding: 2px 5px;
  border-radius: 4px;
  background: rgba(245, 158, 11, 0.13);
  border: 1px solid rgba(245, 158, 11, 0.35);
  max-width: 50px;
  width: 50px;
  overflow: hidden;
  cursor: help;
}
.shift-note-tag-text {
  font-size: 7px;
  color: #92400e;
  font-style: italic;
  font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 44px;
  line-height: 1.3;
}
[data-theme="dark"] .shift-note-tag { background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.3); }
[data-theme="dark"] .shift-note-tag-text { color: #fcd34d; }

/* Note-only chip (no shift assigned) */
/* Ruhezeit-Verletzung Badge â€“ alle Schichten mit Ruhezeitverletzung */
.rest-violation-badge {
  position: absolute;
  bottom: calc(2px / var(--table-zoom));
  left: 50%;
  transform: translateX(-50%);
  font-size: calc(7.5px / var(--table-zoom));
  font-weight: 800;
  font-family: 'DM Mono', monospace;
  border-radius: calc(3px / var(--table-zoom));
  padding: calc(1.5px / var(--table-zoom)) calc(4px / var(--table-zoom));
  white-space: nowrap;
  pointer-events: none;
  z-index: 3;
  /* default = high: orange */
  background: #fff3cd;
  color: #7c4a00;          /* 7.1:1 contrast on #fff3cd */
  border: 1px solid #f59e0b;
  animation: restPulse 2.5s ease-in-out infinite;
}
/* critical: NDâ†’FD/ZD 0â€“2h â€“ red with fast pulse */
.rest-violation-badge.critical {
  background: #fee2e2;
  color: #7f1d1d;          /* 9.3:1 contrast on #fee2e2 */
  border-color: #ef4444;
  animation: restPulseFast 1s ease-in-out infinite;
}
/* high: SD/STâ†’FD or NDâ†’SD */
.rest-violation-badge.high {
  background: #ffedd5;
  color: #7c2d12;          /* 8.2:1 contrast on #ffedd5 */
  border-color: #f97316;
}
/* border: ZD/LTâ†’FD ~11h */
.rest-violation-badge.border {
  background: #fef9c3;
  color: #713f12;          /* 8.8:1 contrast on #fef9c3 */
  border-color: #eab308;
  animation: restPulse 4s ease-in-out infinite;
}
@keyframes restPulse {
  0%,100% { opacity: 1; }
  50%      { opacity: 0.55; }
}
@keyframes restPulseFast {
  0%,100% { opacity: 1; box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
  50%      { opacity: 0.8;  box-shadow: 0 0 5px 2px rgba(239,68,68,0.2); }
}

/* Improved note-only chip */
.note-only-chip {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 5px auto 3px;
  padding: 4px 5px;
  border-radius: 6px;
  background: rgba(245,158,11,0.13);
  border: 1.5px dashed rgba(245,158,11,0.6);
  width: 46px;
  cursor: pointer;
  transition: background var(--transition), border-color var(--transition), transform var(--transition);
  gap: 1px;
  box-shadow: 0 1px 4px rgba(245,158,11,0.15);
}
.note-only-chip:hover {
  background: rgba(245,158,11,0.24);
  border-color: rgba(245,158,11,0.9);
  transform: scale(1.05);
}
.note-only-icon {
  font-size: 11px;
  color: #d97706;
  line-height: 1;
}
.note-only-text {
  font-size: 7px;
  color: #92400e;
  font-style: italic;
  font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 40px;
  text-align: center;
  line-height: 1.2;
}
.note-only-cell { min-height: 64px; }
[data-theme="dark"] .note-only-chip { background: rgba(245,158,11,0.14); border-color: rgba(245,158,11,0.5); }
[data-theme="dark"] .note-only-icon { color: #fbbf24; }
[data-theme="dark"] .note-only-text  { color: #fcd34d; }

/* Undo/Redo buttons */
.undo-redo-group {
  display: flex;
  gap: 3px;
  flex-shrink: 0;
}
.undo-btn {
  width: 30px; height: 30px;
  border: 1px solid rgba(0,0,0,0.09);
  background: rgba(255,255,255,0.8);
  color: var(--text2);
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
  box-shadow: 0 1px 3px rgba(0,0,0,0.07);
}
.undo-btn:hover:not(:disabled) { background: rgba(255,255,255,0.92); color: var(--text); transform: translateY(-1px); box-shadow: 0 2px 10px rgba(0,0,0,0.10), inset 0 1px 0 rgba(255,255,255,1); }
.undo-btn:disabled { opacity: 0.30; cursor: not-allowed; }

/* Pan cursor states */
#table-container.pan-ready  { cursor: grab; }
#table-container.pan-active { cursor: grabbing; user-select: none; }

/* Employee highlight/focus mode */
.emp-row.focus-dimmed td { opacity: 0.22; transition: opacity 0.25s; }
.emp-row.focus-dimmed td.employee-cell { opacity: 0.22; }
.emp-row.focus-active td { opacity: 1; }
.emp-row.focus-active .employee-cell { background: rgba(91,191,181,0.10) !important; }
.focus-mode-on .employee-cell { cursor: pointer; }

/* Copy-month badge in header */
#copy-month-btn.has-source {
  background: rgba(91,191,181,0.15);
  border-color: rgba(91,191,181,0.35);
  color: var(--teal2);
}

/* Highlight bar above table when in focus mode */
.focus-banner {
  position: sticky;
  top: 0;
  z-index: 20;
  background: rgba(91,191,181,0.10);
  border-bottom: 1px solid rgba(91,191,181,0.25);
  padding: 4px 14px;
  font-size: 11px;
  font-weight: 600;
  color: var(--teal2);
  display: none;
  align-items: center;
  gap: 8px;
}
.focus-banner.visible { display: flex; }
.focus-banner button {
  margin-left: auto;
  padding: 2px 10px;
  border-radius: 6px;
  border: 1px solid rgba(91,191,181,0.4);
  background: rgba(91,191,181,0.15);
  color: var(--teal2);
  font-size: 10px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  transition: all var(--transition);
}
.focus-banner button:hover { background: rgba(91,191,181,0.30); }
.emp-fill-hint {
  font-size: 9px;
  color: var(--text3);
  letter-spacing: 0;
  opacity: 0;
  transition: opacity var(--transition);
  line-height: 1;
  margin-top: 2px;
}
.employee-cell:hover .emp-fill-hint { opacity: 1; }

/* ==========================================
   WUNSCH / SPERR â€“ LAYER
   ========================================== */
.wish-overlay {
  position: absolute;
  top: 3px; right: 3px;
  min-width: calc(10px / var(--table-zoom));
  height: calc(10px / var(--table-zoom));
  border-radius: calc(5px / var(--table-zoom));
  pointer-events: none;
  z-index: 4;
  transition: transform 0.15s;
  font-size: calc(8px / var(--table-zoom));
  display: flex; align-items: center; justify-content: center;
  font-weight: 900;
  line-height: 1;
  padding: 0 calc(2px / var(--table-zoom));
  letter-spacing: 0;
}
.wish-overlay.wish {
  background: rgba(22,163,74,0.25);
  border: 1.5px solid rgba(22,163,74,0.7);
  color: #16a34a;
  box-shadow: 0 0 4px rgba(22,163,74,0.4);
}
.wish-overlay.wish.wish-with-shift {
  /* Shows the specific shift type directly on the overlay */
  background: rgba(22,163,74,0.18);
  border-color: rgba(22,163,74,0.8);
  font-size: calc(7px / var(--table-zoom));
  letter-spacing: -0.3px;
  padding: 0 calc(3px / var(--table-zoom));
}
.wish-overlay.block {
  background: rgba(220,38,38,0.2);
  border: 1.5px solid rgba(220,38,38,0.65);
  color: #dc2626;
  box-shadow: 0 0 4px rgba(220,38,38,0.35);
}
/* Conflict: wish was ignored (shift assigned on blocked day) */
.day-cell.wish-conflict { outline: 2px solid rgba(239,68,68,0.7) !important; outline-offset: -2px; }

/* Wish-mode is active: tint cells to hint */
body.wish-mode-on .day-cell { cursor: crosshair !important; }
body.wish-mode-on #wish-mode-btn { background: rgba(22,163,74,0.12) !important; color: #15803d !important; border-color: rgba(22,163,74,0.30) !important; }

/* â”€â”€ WISH-SHIFT POPUP â”€â”€ */
.wish-shift-popup {
  position: fixed;
  z-index: 3000;
  background: rgba(255,255,255,0.80);
  backdrop-filter: blur(28px) saturate(1.8);
  -webkit-backdrop-filter: blur(28px) saturate(1.8);
  border: 1px solid rgba(255,255,255,0.88);
  border-top: 1px solid rgba(255,255,255,0.97);
  border-radius: 14px;
  box-shadow: 0 20px 50px rgba(20,40,80,0.22), 0 6px 16px rgba(20,40,80,0.12), inset 0 1px 0 rgba(255,255,255,0.95);
  min-width: 255px;
  overflow: hidden;
  animation: popIn 0.18s cubic-bezier(.34,1.56,.64,1);
}
[data-theme="dark"] .wish-shift-popup {
  background: rgba(14,20,42,0.90);
  border-color: rgba(255,255,255,0.12);
  box-shadow: 0 20px 50px rgba(0,0,0,0.65), inset 0 1px 0 rgba(255,255,255,0.09);
}
@keyframes popIn {
  from { transform: scale(0.88) translateY(-4px); opacity: 0; }
  to   { transform: scale(1) translateY(0); opacity: 1; }
}
.wsp-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 11px 14px 9px;
  border-bottom: 1px solid var(--border);
  background: rgba(22,163,74,0.08);
}
.wsp-title { font-size: 12.5px; font-weight: 700; color: var(--text); flex: 1; }
.wsp-date  { font-size: 10.5px; color: var(--text3); }
.wsp-close {
  width: 22px; height: 22px;
  border: 1px solid var(--border);
  background: var(--glass2);
  border-radius: 6px;
  color: var(--text3);
  cursor: pointer;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  line-height: 1;
}
.wsp-close:hover { background: rgba(239,68,68,0.15); color: #f87171; }
.wsp-body { padding: 12px 14px 14px; }
.wsp-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text3);
  margin-bottom: 9px;
}
.wsp-shifts {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 10px;
}
.wsp-shift-btn {
  height: 30px;
  min-width: 34px;
  padding: 0 8px;
  border-radius: 7px;
  border: 2px solid transparent;
  font-weight: 700;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  cursor: pointer;
  transition: all 0.14s;
  opacity: 0.80;
}
.wsp-shift-btn:hover { opacity: 1; transform: scale(1.06); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
.wsp-shift-btn.active { opacity: 1; border-color: white; box-shadow: 0 0 0 2.5px rgba(255,255,255,0.5), 0 3px 10px rgba(0,0,0,0.2); transform: scale(1.06); }
.wsp-any {
  display: flex;
  gap: 7px;
  align-items: center;
  padding-top: 8px;
  border-top: 1px solid var(--border);
}
.wsp-any-btn {
  flex: 1;
  padding: 6px 10px;
  border-radius: 8px;
  border: 1.5px solid rgba(22,163,74,0.4);
  background: rgba(22,163,74,0.10);
  color: #4ade80;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.14s;
  font-family: inherit;
}
.wsp-any-btn:hover { background: rgba(22,163,74,0.22); }
.wsp-any-btn.active { background: rgba(22,163,74,0.25); border-color: rgba(22,163,74,0.7); box-shadow: 0 0 0 2px rgba(22,163,74,0.3); }
.wsp-del-btn {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1.5px solid rgba(239,68,68,0.35);
  background: rgba(239,68,68,0.08);
  color: #f87171;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.14s;
  font-family: inherit;
  white-space: nowrap;
}
.wsp-del-btn:hover { background: rgba(239,68,68,0.18); border-color: rgba(239,68,68,0.6); }


/* Coverage bars in header */
.coverage-bars {
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 2px;
  margin-top: 3px;
  height: calc(14px / var(--table-zoom));
}
.cov-seg {
  width: calc(11px / var(--table-zoom));
  border-radius: calc(2px / var(--table-zoom));
  min-height: calc(2px / var(--table-zoom));
  transition: height 0.2s;
  cursor: default;
}

/* Keyboard nav focused cell */
.day-cell.kbnav-focus {
  outline: 2.5px solid var(--accent) !important;
  outline-offset: -2px;
  z-index: 5;
}

/* Multi-cell selection */
.day-cell.multi-sel {
  outline: 2.5px solid #f59e0b !important;
  outline-offset: -2px;
  background: rgba(245,158,11,0.15) !important;
  z-index: 4;
}
.multi-sel-bar {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(10,12,28,0.95);
  border: 1.5px solid rgba(245,158,11,0.6);
  border-radius: 12px;
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 9990;
  backdrop-filter: blur(12px);
  box-shadow: 0 4px 24px rgba(0,0,0,0.5);
  font-size: 12px;
  color: rgba(255,255,255,0.85);
  white-space: nowrap;
  pointer-events: all;
}
.multi-sel-badge {
  background: rgba(245,158,11,0.2);
  border: 1px solid rgba(245,158,11,0.5);
  color: #f59e0b;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 12px;
}
.multi-sel-action {
  padding: 5px 12px;
  border-radius: 7px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  color: white;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}
.multi-sel-action:hover { background: rgba(255,255,255,0.16); }
.multi-sel-action.danger { border-color: rgba(239,68,68,0.4); color: #f87171; }
.multi-sel-action.danger:hover { background: rgba(239,68,68,0.15); }
.multi-sel-action.primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); border-color: transparent; }

/* Header button rich tooltips */
.header-btn { position: relative; }
.header-btn[data-tip]:hover::after {
  content: attr(data-tip);
  position: absolute;
  top: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: rgba(8,10,24,0.97);
  color: rgba(255,255,255,0.88);
  font-size: 11px;
  font-weight: 400;
  line-height: 1.55;
  white-space: pre;
  padding: 8px 12px;
  border-radius: 9px;
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 6px 20px rgba(0,0,0,0.5);
  z-index: 9999;
  pointer-events: none;
  min-width: 160px;
  max-width: 280px;
  text-align: left;
}
.header-btn[data-tip]:hover::before {
  content: '';
  position: absolute;
  top: calc(100% + 3px);
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-bottom-color: rgba(8,10,24,0.97);
  z-index: 9999;
  pointer-events: none;
}

/* Row clear button (shown on row hover) */
/* emp-cell: position:sticky set on .employee-cell â€“ sticky acts as containing block */
.row-clear-btn {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  opacity: 0;
  width: 18px;
  height: 18px;
  border-radius: 4px;
  border: none;
  background: rgba(239,68,68,0.12);
  color: #f87171;
  font-size: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  flex-shrink: 0;
  line-height: 1;
  z-index: 2;
}
.row-clear-btn:hover { background: rgba(239,68,68,0.32); color: white; transform: translateY(-50%) scale(1.1); }
tr:hover .row-clear-btn { opacity: 1; }

/* Keyboard input buffer toast */
#kb-buffer-toast {
  position: fixed;
  bottom: 72px;
  right: 22px;
  background: rgba(8,10,24,0.95);
  border: 1.5px solid var(--accent);
  color: var(--accent);
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-size: 18px;
  font-weight: 700;
  padding: 8px 18px;
  border-radius: 10px;
  display: none;
  z-index: 9998;
  letter-spacing: 3px;
  box-shadow: 0 4px 16px rgba(91,127,255,0.3);
}
#kb-buffer-toast.visible { display: block; }
#emp-filter-bar {
  display: none;
  padding: 6px 14px 0;
  gap: 8px;
  align-items: center;
}
#emp-filter-bar.visible { display: flex; }
#emp-filter-input {
  flex: 1;
  max-width: 280px;
  padding: 5px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  color: var(--text);
  font-size: 12px;
  font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
  outline: none;
  transition: border-color var(--transition);
}
#emp-filter-input:focus { border-color: var(--accent); }
#emp-filter-input::placeholder { color: var(--text3); }
.filter-badge-count {
  font-size: 11px;
  color: var(--text3);
  white-space: nowrap;
}
.emp-row.filter-hidden { display: none !important; }

/* CSV export button (see also .export-btn/.csv-btn later) */

/* â”€â”€ AI PLANNER BUTTON â”€â”€ */
.ai-plan-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 16px;
  border-radius: 20px;
  cursor: pointer;
  font-family: inherit;
  font-size: 11.5px;
  font-weight: 700;
  transition: all var(--transition);
  flex-shrink: 0;
  border: 1px solid rgba(91,191,181,0.4);
  white-space: nowrap;
  background: rgba(91,191,181,0.12);
  color: var(--teal2);
  letter-spacing: 0.3px;
  box-shadow: 0 1px 4px rgba(91,191,181,0.15);
  position: relative;
}
.ai-plan-btn:hover {
  background: rgba(91,191,181,0.22);
  border-color: rgba(91,191,181,0.6);
  color: var(--teal2);
  transform: translateY(-1px);
  box-shadow: 0 4px 14px rgba(91,191,181,0.30);
}
.ai-plan-btn .ai-sparkle {
  font-size: 14px;
  animation: aiPulse 3s ease-in-out infinite;
}
@keyframes aiPulse {
  0%,100% { filter: brightness(1); transform: scale(1); }
  50%      { filter: brightness(1.4); transform: scale(1.15); }
}

/* â”€â”€ AI MODAL â”€â”€ */
#modal-ai .modal { min-width: min(520px, 96vw); max-width: 680px; padding: 0; overflow-y: auto; display: flex; flex-direction: column; }
.ai-modal-header {
  padding: 22px 24px 16px;
  background: linear-gradient(135deg, rgba(91,191,181,0.08), rgba(91,191,181,0.04));
  border-bottom: 1px solid rgba(91,191,181,0.15);
  position: relative;
}
.ai-modal-header::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(91,191,181,0.5) 40%, rgba(94,196,176,0.5) 60%, transparent);
}
.ai-modal-title {
  font-size: 17px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 4px;
}
.ai-modal-sub {
  font-size: 12px;
  color: var(--text3);
  margin-left: 34px;
}
.ai-modal-body { padding: 20px 24px; overflow-y: auto; flex: 1; }
.ai-section-title {
  font-size: 10.5px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text3);
  margin-bottom: 10px;
  margin-top: 18px;
}
.ai-section-title:first-child { margin-top: 0; }
.ai-rule-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--glass2);
  border: 1px solid var(--border);
  border-radius: 9px;
  margin-bottom: 6px;
  font-size: 12.5px;
}
.ai-rule-label { color: var(--text); font-weight: 500; }
.ai-rule-value { display: flex; align-items: center; gap: 6px; }
.ai-rule-value input[type="number"] {
  width: 58px;
  padding: 4px 7px;
  border: 1.5px solid var(--border);
  border-radius: 6px;
  background: var(--surface);
  color: var(--text);
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  text-align: center;
}
.ai-rule-value select {
  padding: 4px 7px;
  border: 1.5px solid var(--border);
  border-radius: 6px;
  background: var(--surface);
  color: var(--text);
  font-size: 12px;
}
.ai-rule-value label { font-size: 11.5px; color: var(--text2); }
.ai-toggle { display: flex; align-items: center; gap: 8px; }
.ai-toggle input[type="checkbox"] { width: 15px; height: 15px; accent-color: #a855f7; }

/* AI Log / Progress */
#ai-log {
  background: rgba(10,12,24,0.08);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text2);
  max-height: 160px;
  overflow-y: auto;
  display: none;
  line-height: 1.7;
  white-space: pre-wrap;
}
#ai-log.visible { display: block; }
[data-theme="dark"] #ai-log { background: rgba(0,0,0,0.25); }

.ai-progress-bar {
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  margin: 10px 0 4px;
  overflow: hidden;
  display: none;
}
.ai-progress-bar.visible { display: block; }
.ai-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #a855f7, #6366f1);
  border-radius: 2px;
  width: 0%;
  transition: width 0.4s ease;
  animation: shimmer 2s infinite linear;
  background-size: 200% 100%;
  background-image: linear-gradient(90deg, #a855f7 0%, #6366f1 50%, #a855f7 100%);
}
@keyframes shimmer { 0%{background-position:200%} 100%{background-position:-200%} }

.ai-result-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 10px;
}
.ai-result-badge {
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}
.ai-result-badge.ok { background: rgba(16,185,129,0.15); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
.ai-result-badge.warn { background: rgba(245,158,11,0.15); color: #fcd34d; border: 1px solid rgba(245,158,11,0.3); }


/* â”€â”€ WEEKEND GROUP SELECTOR (employee modal) â”€â”€ */
.we-group-selector {
  display: flex;
  gap: 8px;
}
.we-group-btn {
  flex: 1;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: var(--glass2);
  color: var(--text2);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  font-family: inherit;
}
.we-group-btn:hover { background: var(--glass); border-color: var(--glass-border2); }
.we-group-btn.active { color: white; border-color: transparent; }
.we-group-btn[data-group=""].active { background: rgba(100,116,139,0.7); }
.we-group-btn.we-A.active { background: linear-gradient(135deg,#2563eb,#3b82f6); box-shadow: 0 3px 12px rgba(37,99,235,0.35); }
.we-group-btn.we-B.active { background: linear-gradient(135deg,#059669,#10b981); box-shadow: 0 3px 12px rgba(5,150,105,0.35); }
.we-group-hint {
  font-size: 10.5px;
  color: var(--text3);
  min-height: 14px;
  margin-top: 3px;
}

/* â”€â”€ WEEKEND GROUP BADGES (main table + emp list) â”€â”€ */
.we-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 17px; height: 17px;
  border-radius: 5px;
  font-size: 9px;
  font-weight: 800;
  letter-spacing: 0;
  flex-shrink: 0;
  line-height: 1;
}
.we-badge.A { background: rgba(37,99,235,0.18); color: #60a5fa; border: 1px solid rgba(37,99,235,0.35); }
.we-badge.B { background: rgba(5,150,105,0.18);  color: #34d399; border: 1px solid rgba(5,150,105,0.35); }

/* â”€â”€ WEEKEND COLUMN HIGHLIGHTING based on we-group â”€â”€ */
/* WE-A columns: extra subtle blue tint when group A is off */
td.we-off-a { background: rgba(37,99,235,0.04) !important; }
td.we-off-b { background: rgba(5,150,105,0.04) !important; }

/* Weekend group row indicator strip */
.emp-we-strip {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  border-radius: 0 2px 2px 0;
}
.emp-we-strip.A { background: linear-gradient(180deg,#2563eb,#3b82f6); }
.emp-we-strip.B { background: linear-gradient(180deg,#059669,#10b981); }

/* Employee cell: position:sticky is set above â€“ do NOT add position:relative here
   as it would override sticky. position:sticky also acts as a containing block
   for absolutely-positioned children like .emp-we-strip. */

/* Preferences indicator in emp list */
.emp-pref-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 7px;
  border-radius: 10px;
  background: rgba(91,191,181,0.12);
  color: #c084fc;
  border: 1px solid rgba(91,191,181,0.25);
  font-size: 9.5px;
  font-weight: 600;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* WE overview widget in dept bar or separate area */
.we-overview-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 0 10px;
  height: 100%;
  border-left: 1px solid rgba(255,255,255,0.08);
  flex-shrink: 0;
}
.we-overview-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 10.5px;
  color: rgba(255,255,255,0.55);
}

  0%   { background: rgba(59,91,255,0.35) !important; }
  100% { background: transparent; }
}
.paste-flash { animation: pasteFlash 0.45s ease-out forwards; }

/* Footer rows */
.footer-row td {
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  font-size: 11px;
  text-align: center;
  vertical-align: middle;
  padding: 6px 4px;
  border-top: 1.5px solid var(--border);
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-weight: 600;
  color: var(--text);
}
.footer-label {
  text-align: left !important;
  padding-left: 12px !important;
  font-family: 'DM Sans', sans-serif !important;
  font-size: 12px !important;
  color: var(--text2);
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
.footer-count { color: var(--text); }
.footer-count.zero { color: var(--text3); }

/* ==========================================
   MODALS
   ========================================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(8,12,24,0.40);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s;
  backdrop-filter: blur(12px) saturate(1.3);
  -webkit-backdrop-filter: blur(12px) saturate(1.3);
}
.modal-overlay.visible {
  opacity: 1;
  pointer-events: all;
}
.modal {
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(40px) saturate(2.0) brightness(1.05);
  -webkit-backdrop-filter: blur(32px) saturate(2.0) brightness(1.05);
  border: 1px solid rgba(255,255,255,0.82);
  border-top: 1px solid rgba(255,255,255,0.95);
  border-radius: 22px;
  padding: 26px;
  min-width: 360px;
  max-width: 92vw;
  max-height: 87vh;
  overflow-y: auto;
  box-shadow:
    0 24px 60px rgba(20,40,80,0.22),
    0 8px 24px rgba(20,40,80,0.12),
    inset 0 1px 0 rgba(255,255,255,0.95),
    inset 0 -1px 0 rgba(0,0,0,0.04);
  transform: scale(0.94) translateY(8px);
  transition: transform 0.28s cubic-bezier(.34,1.56,.64,1);
}
[data-theme="dark"] .modal {
  background: rgba(14,20,42,0.78);
  border-color: rgba(255,255,255,0.12);
  border-top-color: rgba(255,255,255,0.16);
  box-shadow:
    0 24px 60px rgba(0,0,0,0.65),
    0 8px 24px rgba(0,0,0,0.45),
    inset 0 1px 0 rgba(255,255,255,0.10),
    inset 0 -1px 0 rgba(0,0,0,0.30);
}
.modal-overlay.visible .modal { transform: scale(1) translateY(0); }
.modal-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}
.modal-close {
  margin-left: auto;
  background: var(--glass2);
  border: 1px solid var(--border);
  color: var(--text3);
  cursor: pointer;
  font-size: 18px;
  padding: 2px 8px;
  border-radius: 8px;
  transition: all var(--transition);
  line-height: 1.4;
}
.modal-close:hover { background: rgba(239,68,68,0.15); color: #f87171; border-color: rgba(239,68,68,0.3); }

.form-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 16px;
}
.form-row label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.6px;
}
.form-row input, .form-row select, .form-row textarea {
  padding: 9px 13px;
  border: 1.5px solid rgba(180,200,230,0.45);
  background: rgba(255,255,255,0.55) !important;
  backdrop-filter: var(--blur-xs);
  border-radius: var(--radius);
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  outline: none;
  transition: border-color var(--transition), box-shadow var(--transition);
}
.form-row input:focus, .form-row select:focus, .form-row textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(91,127,255,0.15);
}
.form-row textarea { resize: vertical; min-height: 60px; }
.form-row input[type="range"] {
  padding: 4px 0;
  border: none;
  background: none;
  -webkit-appearance: none;
  width: 100%;
  backdrop-filter: none;
}
.form-row input[type="range"]::-webkit-slider-track {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
}
.form-row input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  cursor: pointer;
  margin-top: -6px;
  box-shadow: 0 2px 8px rgba(91,127,255,0.4);
}

.btn-row {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}
.btn {
  padding: 9px 18px;
  border: 1px solid transparent;
  border-radius: var(--radius);
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  transition: all var(--transition);
}
.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  box-shadow: 0 3px 12px rgba(91,127,255,0.35);
}
.btn-primary:hover { box-shadow: 0 5px 18px rgba(91,127,255,0.5); transform: translateY(-1px); }
.btn-secondary {
  background: var(--glass2);
  color: var(--text2);
  border-color: var(--border);
  backdrop-filter: var(--blur-sm);
}
.btn-secondary:hover { background: var(--glass); border-color: var(--accent); color: var(--accent); }
.btn-danger { background: rgba(239,68,68,0.1); color: #f87171; border-color: rgba(239,68,68,0.3); }
.btn-danger:hover { background: rgba(239,68,68,0.2); }

/* Employee list in modal */
.emp-list { display: flex; flex-direction: column; gap: 5px; }
.emp-list-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 13px;
  border-radius: var(--radius);
  background: var(--glass2);
  border: 1.5px solid var(--border);
  cursor: pointer;
  transition: all var(--transition);
  backdrop-filter: var(--blur-sm);
}
.emp-list-item:hover { border-color: var(--accent); background: var(--accent-light); }
.emp-list-item .drag-handle {
  color: var(--text3);
  cursor: grab;
  font-size: 16px;
}
.emp-list-item .emp-info { flex: 1; }
.emp-list-item .emp-info .name { font-weight: 600; font-size: 13px; }
.emp-list-item .emp-info .role { font-size: 11px; color: var(--text3); }
.emp-list-item .emp-actions { display: flex; gap: 4px; }
.emp-list-item .icon-btn {
  width: 27px; height: 27px;
  border: 1px solid var(--border);
  background: var(--glass2);
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text3);
  transition: all var(--transition);
}
.emp-list-item .icon-btn:hover { background: var(--glass); border-color: var(--text3); color: var(--text); }
.icon-btn.danger:hover { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.4); color: #f87171; }

/* Shift config */
.shift-config-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 13px;
  border-radius: var(--radius);
  border: 1.5px solid var(--border);
  margin-bottom: 6px;
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  cursor: grab;
  transition: all var(--transition);
}
.shift-config-item:hover { border-color: var(--accent); }
.shift-config-item.dragging-shift-cfg { opacity: 0.4; }
.shift-config-item.drag-over-shift-cfg { box-shadow: 0 0 0 2px var(--accent); }
.shift-preview {
  width: 38px; height: 32px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 11px;
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  flex-shrink: 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.2);
}
.shift-cfg-drag { color: var(--text3); cursor: grab; font-size: 16px; flex-shrink: 0; }
.shift-config-inputs { flex: 1; display: flex; gap: 5px; align-items: center; }
.shift-config-inputs input {
  padding: 5px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--glass);
  color: var(--text);
  font-size: 12px;
  font-family: inherit;
  outline: none;
  transition: border-color var(--transition);
}
.shift-config-inputs input:focus { border-color: var(--accent); }
.shift-config-inputs input.label-inp  { width: 46px; }
.shift-config-inputs input.name-inp   { flex: 1; }
.shift-config-inputs input.hours-inp  { width: 46px; }
.shift-config-inputs input.color-inp  { width: 32px; height: 28px; padding: 2px; cursor: pointer; border-radius: 5px; }

/* Settings toggles */
.settings-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 7px;
}
.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 9px 13px;
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  border-radius: var(--radius);
  border: 1.5px solid var(--border);
}
.toggle-label { font-size: 13px; font-weight: 500; color: var(--text); }
.toggle-switch {
  position: relative;
  width: 36px; height: 20px;
}
.toggle-switch input { display: none; }
.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  top: 3px; left: 3px;
  background: white;
  border-radius: 50%;
  transition: transform 0.2s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.toggle-switch input:checked + .toggle-slider { background: linear-gradient(135deg, var(--accent), var(--accent2)); }
.toggle-switch input:checked + .toggle-slider::before { transform: translateX(16px); }

/* Context menu â€“ glass */
#context-menu, #emp-context-menu {
  position: fixed;
  background: var(--glass);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  border-radius: 13px;
  padding: 6px;
  z-index: 3000;
  box-shadow: var(--shadow-lg);
  display: none;
  min-width: 210px;
}
#context-menu.visible, #emp-context-menu.visible { display: block; }
.ctx-item {
  padding: 8px 13px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text);
  transition: background var(--transition);
}
.ctx-item:hover { background: var(--glass2); }
.ctx-item.danger { color: #f87171; }
.ctx-item.danger:hover { background: rgba(239,68,68,0.12); }
.ctx-divider { height: 1px; background: var(--border); margin: 4px 0; }

/* Toast â€“ glass */
#toast {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--glass);
  backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  color: var(--text);
  padding: 10px 22px;
  border-radius: 40px;
  font-size: 13px;
  font-weight: 600;
  z-index: 9999;
  transition: transform 0.3s cubic-bezier(.34,1.56,.64,1), opacity 0.3s;
  opacity: 0;
  pointer-events: none;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 8px;
}
#toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* Loading â€“ glass */
#loading {
  position: fixed;
  inset: 0;
  background: var(--bg);
  background-image: var(--bg-mesh);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  transition: opacity 0.5s;
}
#loading.hidden { opacity: 0; pointer-events: none; }
.spinner {
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-right-color: var(--accent2);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Note popup â€“ glass */
.note-popup {
  position: fixed;
  background: var(--glass);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 14px;
  z-index: 2000;
  box-shadow: var(--shadow-lg);
  min-width: 220px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s, transform 0.25s cubic-bezier(.34,1.56,.64,1);
  transform: scale(0.92);
}
.note-popup.visible { opacity: 1; pointer-events: all; transform: scale(1); }
.note-popup textarea {
  width: 100%;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 7px 10px;
  font-family: inherit;
  font-size: 12px;
  background: var(--glass2);
  color: var(--text);
  resize: none;
  outline: none;
  transition: border-color var(--transition);
  backdrop-filter: var(--blur-sm);
}
.note-popup textarea:focus { border-color: var(--accent); }
.note-popup .note-actions { display: flex; gap: 6px; margin-top: 10px; justify-content: flex-end; }
.note-popup .note-actions button {
  padding: 5px 11px;
  border: 1px solid transparent;
  border-radius: 7px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  font-family: inherit;
  transition: all var(--transition);
}

/* Drag & Drop */
.emp-row.drag-over td { background: var(--accent-light) !important; outline: 2px solid var(--accent); outline-offset: -2px; }
.emp-row.dragging { opacity: 0.35; }

/* ==========================================
   WEEK VIEW CONTROLS
   ========================================== */
#week-controls {
  display: none;
  align-items: center;
  gap: 8px;
}
#week-controls.visible { display: flex; }
.week-nav-btn {
  padding: 5px 11px;
  border: 1px solid rgba(0,0,0,0.09);
  background: rgba(255,255,255,0.80);
  color: var(--text2);
  border-radius: 7px;
  cursor: pointer;
  font-family: inherit;
  font-size: 11px;
  font-weight: 600;
  transition: all var(--transition);
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.week-nav-btn:hover { background: white; color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.10); }
.week-label { font-size: 12px; color: var(--text); min-width: 110px; text-align: center; font-weight: 600; }

/* ==========================================
   YEAR VIEW OVERLAY
   ========================================== */
#year-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.28);
  backdrop-filter: blur(20px) saturate(1.5);
  -webkit-backdrop-filter: blur(20px) saturate(1.5);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
#year-overlay.visible { opacity: 1; pointer-events: all; }

.year-panel {
  background: var(--glass);
  backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 28px 32px;
  box-shadow: var(--shadow-lg);
  width: min(680px, 95vw);
  transform: scale(0.92) translateY(20px);
  transition: transform 0.3s cubic-bezier(.34,1.56,.64,1);
}
#year-overlay.visible .year-panel { transform: scale(1) translateY(0); }

.year-panel-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
}
.year-nav-btn {
  width: 34px; height: 34px;
  border: 1px solid var(--border);
  background: var(--glass2);
  color: var(--text);
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
}
.year-nav-btn:hover { background: var(--accent-light); border-color: var(--accent); }
.year-heading {
  font-size: 22px;
  font-weight: 700;
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  color: var(--text);
  flex: 1;
  text-align: center;
  letter-spacing: 2px;
}
.year-close-btn {
  width: 34px; height: 34px;
  border: 1px solid var(--border);
  background: var(--glass2);
  color: var(--text3);
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
}
.year-close-btn:hover { background: rgba(239,68,68,0.15); color: #f87171; border-color: rgba(239,68,68,0.3); }

.year-months-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
.year-month-card {
  border-radius: 14px;
  border: 1.5px solid var(--border);
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  cursor: pointer;
  padding: 12px 10px;
  text-align: center;
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
}
.year-month-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  opacity: 0;
  transition: opacity var(--transition);
  border-radius: inherit;
}
.year-month-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(91,127,255,0.2); }
.year-month-card:hover::before { opacity: 0.08; }
.year-month-card.current-month { border-color: var(--accent); background: var(--accent-light); }
.year-month-card.current-month::before { opacity: 0.12; }
.year-month-name {
  font-weight: 700;
  font-size: 13px;
  color: var(--text);
  position: relative;
  z-index: 1;
  letter-spacing: 0.3px;
}
.year-month-days {
  font-size: 10px;
  color: var(--text3);
  margin-top: 2px;
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  position: relative;
  z-index: 1;
}
.year-month-card.current-month .year-month-name { color: var(--accent); }

/* Mini calendar in year card */
.mini-cal {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  margin-top: 6px;
  position: relative;
  z-index: 1;
}
.mini-cal-day {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 2px;
  font-size: 6.5px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  color: var(--text3);
  font-weight: 600;
}
.mini-cal-day.has-shifts { background: var(--accent); color: white; border-radius: 3px; }
.mini-cal-day.weekend   { color: rgba(248,113,113,0.7); }
.mini-cal-day.holiday   { background: rgba(248,113,113,0.2); color: #f87171; border-radius: 3px; }
.mini-cal-day.empty     { opacity: 0; }

/* ==========================================
   PRINT STYLES
   ========================================== */
@media print {
  body { background: white; overflow: visible; display: block; }
  body::before { display: none; }
  #header, #sidebar, .modal-overlay, #loading, #toast, #year-overlay { display: none !important; }
  #main { display: block; overflow: visible; }
  #table-container { overflow: visible; padding: 0; }
  #plan-wrapper { box-shadow: none; border-radius: 0; overflow: visible; background: white !important; backdrop-filter: none; }
  #plan-table { font-size: 9px !important; zoom: 1 !important; }
  #plan-table thead th { background: #1a1d2e !important; }
  #plan-table td, #plan-table th { padding: 2px 3px !important; }
  .shift-badge { width: 28px !important; height: 22px !important; font-size: 9px !important; }
  .day-cell { min-width: 32px !important; width: 32px !important; }
  @page { size: A3 landscape; margin: 8mm; }
}

/* â”€â”€ SVG Icon Styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header-btn svg,
.undo-btn svg,
.export-btn svg,
.save-btn svg,
.ai-plan-btn svg,
.icon-btn svg,
.btn svg,
.row-clear-btn svg,
[class*="-btn"] svg {
  display: inline-block;
  vertical-align: middle;
  flex-shrink: 0;
  pointer-events: none;
}
.header-btn,
.undo-btn,
.export-btn,
.save-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

/* â”€â”€ Header-btn: refined glass style â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header-btn {
  background: rgba(255,255,255,0.70);
  border: 1px solid rgba(0,0,0,0.08);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  transition: background 0.15s, box-shadow 0.15s, transform 0.1s;
}
.header-btn:hover {
  background: rgba(255,255,255,0.92);
  box-shadow: 0 2px 10px rgba(0,0,0,0.10);
  transform: translateY(-1px);
}
.header-btn:active { transform: translateY(0); }
[data-theme="dark"] .header-btn {
  background: rgba(255,255,255,0.06);
  border-color: rgba(255,255,255,0.10);
}
[data-theme="dark"] .header-btn:hover {
  background: rgba(255,255,255,0.12);
  box-shadow: 0 2px 10px rgba(0,0,0,0.35);
}

/* â”€â”€ Icon-btn in modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.icon-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px; height: 28px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: var(--glass2);
  color: var(--text2);
  cursor: pointer;
  transition: all 0.15s;
}
.icon-btn:hover {
  background: var(--surface2);
  color: var(--text);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.icon-btn.danger { color: #ef4444; border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.06); }
.icon-btn.danger:hover { background: rgba(239,68,68,0.14); }

/* â”€â”€ Employee Hover Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#emp-tooltip {
  position: fixed;
  z-index: 9500;
  pointer-events: none;
  opacity: 0;
  transform: translateY(4px);
  transition: opacity 0.18s ease, transform 0.18s ease;
  min-width: 220px;
  max-width: 300px;
}
#emp-tooltip.visible {
  opacity: 1;
  transform: translateY(0);
}
.emp-tt-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.14), 0 2px 8px rgba(0,0,0,0.07);
  overflow: hidden;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
[data-theme="dark"] .emp-tt-card {
  box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.3);
}
.emp-tt-header {
  padding: 10px 14px 8px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(135deg, rgba(91,191,181,0.12) 0%, transparent 100%);
}
.emp-tt-name {
  font-weight: 700;
  font-size: 12.5px;
  color: var(--text);
  letter-spacing: 0.2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.emp-tt-role {
  font-size: 10.5px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.6px;
  margin-top: 1px;
}
.emp-tt-body {
  padding: 10px 14px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px 12px;
}
.emp-tt-stat {
  display: flex;
  flex-direction: column;
  gap: 1px;
}
.emp-tt-stat-label {
  font-size: 9.5px;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text3);
  font-weight: 600;
}
.emp-tt-stat-val {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  font-family: 'DM Mono', 'Courier New', monospace;
}
.emp-tt-stat-val.positive { color: #10b981; }
.emp-tt-stat-val.negative { color: #ef4444; }
.emp-tt-badges {
  padding: 6px 14px 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  border-top: 1px solid var(--border);
}
.emp-tt-badge {
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 20px;
  letter-spacing: 0.3px;
}
.emp-tt-prefs {
  padding: 0 14px 10px;
  font-size: 10.5px;
  color: var(--text2);
  line-height: 1.5;
  border-top: 1px solid var(--border);
  padding-top: 7px;
}
.emp-tt-prefs-label {
  font-size: 9.5px;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: #c084fc;
  font-weight: 700;
  margin-bottom: 3px;
}
</style>
</head>

<body data-theme="light">

<!-- LOADING -->
<div id="loading">
  <div class="spinner"></div>
  <div style="font-size:14px;color:var(--text2);font-weight:600;letter-spacing:0.3px;">Dienstplan wird geladenâ€¦</div>
</div>

<!-- TOAST -->
<div id="toast">âœ“ Gespeichert</div>

<!-- TOOLTIP -->
<div class="tooltip-box" id="tooltip"></div>

<!-- YEAR OVERLAY -->
<div id="year-overlay" onclick="if(event.target===this)closeYearView()">
  <div class="year-panel">
    <div class="year-panel-header">
      <button class="year-nav-btn" onclick="changeYearView(-1)">â€¹</button>
      <div class="year-heading" id="year-heading">2026</div>
      <button class="year-nav-btn" onclick="changeYearView(1)">â€º</button>
      <button class="year-close-btn" onclick="closeYearView()">Ã—</button>
    </div>
    <div class="year-months-grid" id="year-months-grid"></div>
  </div>
</div>

<!-- NOTE POPUP -->
<div class="note-popup" id="note-popup">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
    <span id="note-popup-badge" style="display:inline-flex;align-items:center;justify-content:center;width:30px;height:24px;border-radius:5px;font-weight:700;font-size:10px;font-family:'Space Mono',monospace;flex-shrink:0;"></span>
    <div>
      <div style="font-size:11px;font-weight:700;color:var(--text);" id="note-popup-name"></div>
      <div style="font-size:10px;color:var(--text3);" id="note-popup-date"></div>
    </div>
  </div>
  <textarea id="note-textarea" rows="3" placeholder="Notiz eingebenâ€¦ (z.B. Wunsch, Tausch, Info)"></textarea>
  <div class="note-actions">
    <button id="note-delete" style="background:var(--surface2);color:#ef4444;border:1px solid #fecaca;">ðŸ—‘ LÃ¶schen</button>
    <button id="note-cancel" style="background:var(--surface2);color:var(--text2);">Abbrechen</button>
    <button id="note-save" style="background:var(--accent);color:white;">âœ“ Speichern</button>
  </div>
</div>

<!-- CONTEXT MENU (day cells) -->
<div id="context-menu">
  <div class="ctx-item" id="ctx-note">âœï¸ Notiz bearbeiten</div>
  <div class="ctx-item" id="ctx-copy">ðŸ“‹ Dienst kopieren <span style="float:right;opacity:0.45;font-size:10px">Ctrl+C</span></div>
  <div class="ctx-item" id="ctx-paste" style="opacity:0.4">ðŸ“Œ Dienst einfÃ¼gen <span style="float:right;opacity:0.45;font-size:10px">Ctrl+V</span></div>
  <div class="ctx-item" id="ctx-swap">ðŸ”„ Zum Tauschen ausschreiben</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" id="ctx-clear" style="color:#ef4444">ðŸ—‘ï¸ Dienst lÃ¶schen</div>
</div>

<!-- CONTEXT MENU (employee name) -->
<div id="emp-context-menu">
  <div style="padding:7px 13px 5px;font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.7px;" id="emp-ctx-label">Mitarbeiter</div>
  <div class="ctx-divider" style="margin:2px 0 4px"></div>
  <div class="ctx-item" id="emp-ctx-fill">ðŸ–Šï¸ Alle leeren Werktage ausfÃ¼llen</div>
  <div class="ctx-item" id="emp-ctx-fill-all">ðŸ“‹ Alle leeren Tage ausfÃ¼llen (inkl. WE)</div>
  <div class="ctx-divider"></div>
  <div style="padding:4px 13px 3px;font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.7px">Schichtmuster eintragen</div>
  <div class="ctx-item" id="emp-ctx-pat-wechsel" onclick="applyShiftPattern(empContextTarget,'FD-SD-wechsel')">ðŸ”„ FD/SD-Wechselschicht (2-Wochen)</div>
  <div class="ctx-item" id="emp-ctx-pat-nd" onclick="applyShiftPattern(empContextTarget,'ND-Block')">ðŸŒ™ Nachtblock (3 NÃ¤chte / Woche)</div>
  <div class="ctx-item" id="emp-ctx-pat-vollrot" onclick="applyShiftPattern(empContextTarget,'Vollrotation')">â™»ï¸ Vollrotation FD/SD/ND</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" id="emp-ctx-clear-month" style="color:#f87171">ðŸ—‘ï¸ Ganzen Monat lÃ¶schen</div>
</div>

<!-- ============================================================
     HEADER
     ============================================================ -->
<div id="header">

  <!-- LEFT: Logo + Nav -->
  <div class="header-left">
    <div class="logo">
      <div class="logo-icon">
        <svg width="28" height="22" viewBox="0 0 34 28" fill="none">
          <rect width="34" height="28" rx="5" fill="#E30613"/>
          <text x="50%" y="20" text-anchor="middle" font-family="Inter,sans-serif" font-weight="700" font-size="18" fill="white">H</text>
        </svg>
      </div>
      <div class="logo-text">
        <div class="logo-title">HELIOS Dienstplan</div>
        <div class="logo-sub" id="header-dept-name">Klinikum Duisburg</div>
      </div>
    </div>

    <div class="header-sep"></div>

    <div class="view-toggle h-hide-compact">
      <button class="view-btn active" id="btn-month" onclick="setView('month')">Monat</button>
      <button class="view-btn" id="btn-week" onclick="setView('week')">Woche</button>
      <button class="view-btn" id="btn-year" onclick="openYearView()">Jahr</button>
    </div>

    <div class="header-sep h-hide-compact"></div>

    <div class="month-nav">
      <button onclick="changeMonth(-1)" title="Vorheriger Monat">&#8249;</button>
      <div class="month-label" id="month-label" onclick="openYearView()" title="JahresÃ¼bersicht">APRIL 2026</div>
      <button onclick="changeMonth(1)" title="NÃ¤chster Monat">&#8250;</button>
    </div>
    <div id="week-controls">
      <button class="week-nav-btn" onclick="changeWeek(-1)">&#8249;</button>
      <span class="week-label" id="week-label">KW 14</span>
      <button class="week-nav-btn" onclick="changeWeek(1)">&#8250;</button>
    </div>

    <div class="header-sep h-hide-compact"></div>

    <div class="zoom-control h-hide-compact">
      <button onclick="adjustZoom(-0.1)" title="Verkleinern">âˆ’</button>
      <input type="range" class="zoom-slider" id="zoom-slider" min="0.5" max="1.5" step="0.05" value="1" oninput="setZoom(+this.value)">
      <button onclick="adjustZoom(0.1)" title="VergrÃ¶ÃŸern">+</button>
      <span class="zoom-label" id="zoom-label">100%</span>
    </div>

    <div class="undo-redo-group h-hide-compact">
      <button class="undo-btn" id="undo-btn" onclick="undoAction()" title="RÃ¼ckgÃ¤ngig (Ctrl+Z)" disabled><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M3 13A9 9 0 1 0 5.17 5.17L3 7"/></svg></button>
      <button class="undo-btn" id="redo-btn" onclick="redoAction()" title="Wiederholen (Ctrl+Y)" disabled><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M21 13A9 9 0 1 1 18.83 5.17L21 7"/></svg></button>
    </div>
  </div>

  <!-- SPACER -->
  <div class="header-spacer"></div>

  <!-- RIGHT: Status + Actions -->
  <div class="header-right">
    <div class="workdays-badge h-hide-compact" id="workdays-badge">20 Arbeitstage</div>

    <div class="sync-badge offline h-hide-compact" id="sync-badge">
      <div class="sync-dot"></div>
      <span id="sync-text">Lokal</span>
    </div>

    <div class="header-sep"></div>

    <button class="header-btn" id="lock-btn" onclick="toggleLock()" data-tip="Bearbeitung sperren"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2.5"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg></button>
    <button class="header-btn h-hide-compact" id="pan-btn" onclick="togglePanMode()" data-tip="Scrollmodus (P)"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/></svg></button>
    <button class="header-btn" id="wish-mode-btn" onclick="toggleWishMode()" data-tip="VerfÃ¼gbarkeits-Modus (W)"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><circle cx="9" cy="16" r="1.2" fill="currentColor"/><circle cx="15" cy="16" r="1.2" fill="currentColor"/></svg></button>
    <button class="header-btn h-hide-compact" id="copy-month-btn" onclick="openCopyMonthModal()" data-tip="Monat kopieren"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
    <button class="header-btn" onclick="openModal('modal-employees')" data-tip="Mitarbeiter verwalten"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg></button>
    <button class="header-btn h-hide-compact" onclick="openModal('modal-shifts')" data-tip="Dienste konfigurieren"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/><path d="M7 9h4M13 9h4M7 12h3M13 12h3"/></svg></button>
    <button class="header-btn h-hide-compact" onclick="openStatsModal()" data-tip="Monatsstatistik"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></button>
    <button class="header-btn" onclick="openModal('modal-settings')" data-tip="Einstellungen"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
    <button class="header-btn h-hide-compact" id="theme-btn" onclick="toggleTheme()" data-tip="Dark / Light Mode"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button>

    <div class="header-sep"></div>

    <button class="export-btn h-hide-compact" onclick="printPDF()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg> PDF</button>
    <button class="export-btn h-hide-compact" onclick="openModal('modal-io')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg> Archiv</button>
    <button class="ai-plan-btn" onclick="openModal('modal-ai')" title="KI-Dienstplanung">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> KI-Plan
    </button>
    <button class="save-btn" onclick="saveAll()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Sichern<span class="unsaved-dot"></span></button>

    <button class="layout-toggle-btn" id="layout-toggle-btn" onclick="cycleLayout()" data-layout="desktop" title="Ansicht wechseln"></button>
    <button class="header-btn" id="overflow-drawer-btn" onclick="toggleOverflowDrawer()" title="Mehr" style="display:none"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="5" cy="12" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="19" cy="12" r="1.5" fill="currentColor"/></svg></button>
  </div>
</div>

<div id="header-overflow-drawer">
  <button class="header-btn" onclick="adjustZoom(-0.1)" title="Verkleinern">âˆ’</button>
  <input type="range" class="zoom-slider" id="zoom-slider-drawer" min="0.5" max="1.5" step="0.05" value="1"
    oninput="setZoom(+this.value); document.getElementById('zoom-slider').value=this.value">
  <button class="header-btn" onclick="adjustZoom(0.1)" title="VergrÃ¶ÃŸern">+</button>
  <span class="zoom-label" id="zoom-label-drawer" style="margin-right:8px">100%</span>
  <button class="header-btn" id="undo-btn-d" onclick="undoAction()" title="RÃ¼ckgÃ¤ngig" disabled><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M3 13A9 9 0 1 0 5.17 5.17L3 7"/></svg></button>
  <button class="header-btn" id="redo-btn-d" onclick="redoAction()" title="Wiederholen" disabled><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M21 13A9 9 0 1 1 18.83 5.17L21 7"/></svg></button>
  <button class="header-btn" onclick="openStatsModal()" title="Statistik"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></button>
  <button class="header-btn" onclick="exportCSV()" title="CSV Export"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
  <button class="header-btn" onclick="openModal('modal-io')" title="Archiv"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg></button>
  <button class="header-btn" onclick="printPDF()" title="PDF"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg></button>
  <button class="header-btn" onclick="toggleFilterBar()" title="Filter"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg></button>
  <button class="header-btn" onclick="openCopyMonthModal()" title="Monat kopieren"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
  <button class="header-btn" onclick="openModal('modal-shifts')" title="Dienste"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/><path d="M7 9h4M13 9h4M7 12h3M13 12h3"/></svg></button>
  <button class="header-btn" onclick="toggleTheme()" title="Theme"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button>
  <button class="header-btn" onclick="togglePanMode()" title="Scrollen"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/></svg></button>
</div>


<!-- ============================================================
     DEPARTMENT TABS BAR
     ============================================================ -->
<div id="dept-bar">
  <!-- filled by renderDeptTabs() -->
</div>

<!-- ============================================================
     MAIN
     ============================================================ -->
<div id="main">

  <!-- SIDEBAR -->
  <div id="sidebar" id="shift-sidebar">
    <!-- filled by JS -->
  </div>

  <!-- TABLE AREA -->
  <div id="table-container">
    <!-- Filter bar -->
    <div id="emp-filter-bar">
      <input id="emp-filter-input" type="text" placeholder="ðŸ” Mitarbeiter suchenâ€¦" oninput="applyEmpFilter(this.value)" autocomplete="off">
      <span class="filter-badge-count" id="filter-count"></span>
      <button style="margin-left:4px;padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:var(--glass2);color:var(--text2);font-size:11px;cursor:pointer" onclick="applyEmpFilter('');document.getElementById('emp-filter-input').value=''">âœ• LÃ¶schen</button>
    </div>
    <!-- Focus-mode Banner -->
    <div class="focus-banner" id="focus-banner">
      <span>ðŸ‘ï¸ Fokus: <strong id="focus-emp-name">â€”</strong></span>
      <button onclick="clearFocusMode()">Ã— Fokus aufheben</button>
    </div>
    <div id="plan-wrapper">
      <table id="plan-table">
        <thead id="plan-thead"></thead>
        <tbody id="plan-tbody"></tbody>
        <tfoot id="plan-tfoot"></tfoot>
      </table>
    </div>
  </div>

</div>

<!-- AI PLANNER MODAL -->
<div class="modal-overlay" id="modal-ai">
  <div class="modal" style="min-width:min(520px,96vw);max-width:680px;padding:0;overflow-y:auto;display:flex;flex-direction:column;max-height:88vh">
    <div class="ai-modal-header">
      <div class="ai-modal-title">
        <span style="font-size:22px">âœ¦</span>
        KI-Dienstplanung
        <button class="modal-close" onclick="closeModal('modal-ai')" style="margin-left:auto">Ã—</button>
      </div>
      <div class="ai-modal-sub">Claude plant den Monat automatisch nach deinen Regeln.</div>
    </div>

    <div class="ai-modal-body">
      <!-- API Key Status -->
      <div id="ai-key-status" style="display:flex;align-items:center;gap:10px;padding:9px 14px;background:rgba(22,163,74,0.09);border:1px solid rgba(22,163,74,0.25);border-radius:10px;margin-bottom:14px">
        <span style="font-size:16px">ðŸ”‘</span>
        <div style="flex:1">
          <div style="font-size:12px;font-weight:700;color:#16a34a" id="ai-key-label">âœ“ API-Key hinterlegt</div>
          <div style="font-size:10.5px;color:var(--text3);margin-top:1px">Sicher im Browser gespeichert</div>
        </div>
        <button class="btn btn-secondary" style="font-size:10.5px;padding:4px 10px" onclick="toggleAIKeyEdit()" id="ai-key-edit-btn">Ã¤ndern</button>
      </div>
      <div id="ai-key-edit-area" style="display:none;margin-bottom:14px">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
          <input type="password" id="ai-api-key" placeholder="sk-ant-api03-..."
            style="flex:1;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);font-size:12px;font-family:'DM Mono',monospace"
            oninput="saveAIKey(this.value)">
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="toggleKeyVisibility()">ðŸ‘</button>
        </div>
        <div style="font-size:10.5px;color:var(--text3)">
          API-Key unter <a href="https://console.anthropic.com/keys" target="_blank" style="color:var(--teal2)">console.anthropic.com/keys</a> erstellen
        </div>
      </div>

      <!-- Rules -->
      <div class="ai-section-title">ðŸ“‹ Planungsregeln</div>
      <div class="ai-rule-row">
        <span class="ai-rule-label">ðŸŒ… FrÃ¼hschicht-Mindestbesetzung</span>
        <div class="ai-rule-value"><input type="number" id="ai-min-fd" value="2" min="1" max="10"> Personen</div>
      </div>
      <div class="ai-rule-row">
        <span class="ai-rule-label">ðŸŒ† SpÃ¤tschicht-Mindestbesetzung</span>
        <div class="ai-rule-value"><input type="number" id="ai-min-sd" value="2" min="1" max="10"> Personen</div>
      </div>
      <div class="ai-rule-row">
        <span class="ai-rule-label">ðŸŒ™ Nachtdienst-Mindestbesetzung</span>
        <div class="ai-rule-value"><input type="number" id="ai-min-nd" value="2" min="0" max="10"> Personen</div>
      </div>
      <div class="ai-rule-row">
        <span class="ai-rule-label">ðŸ“… Max. Arbeitstage am StÃ¼ck</span>
        <div class="ai-rule-value"><input type="number" id="ai-max-streak" value="9" min="3" max="14"> Tage</div>
      </div>
      <div class="ai-rule-row">
        <span class="ai-rule-label">ðŸŒ™ Max. NÃ¤chte pro Woche</span>
        <div class="ai-rule-value"><input type="number" id="ai-max-nd" value="3" min="1" max="7"> NÃ¤chte</div>
      </div>
      <div class="ai-rule-row">
        <span class="ai-rule-label">âš–ï¸ Wochenend-Gruppen (A/B-Rotation)</span>
        <div class="ai-rule-value ai-toggle">
          <input type="checkbox" id="ai-we-balance" checked>
          <label for="ai-we-balance">aktiv</label>
        </div>
      </div>
      <div id="ai-we-overview" style="padding:8px 12px;background:var(--glass2);border:1px solid var(--border);border-radius:9px;margin-bottom:6px;font-size:11px;display:flex;gap:16px;flex-wrap:wrap">
        <span style="color:var(--text3)">ðŸ—“ Gruppen:</span>
        <span id="ai-we-a-list" style="color:#2563eb"></span>
        <span id="ai-we-b-list" style="color:#16a34a"></span>
        <span id="ai-we-none-list" style="color:var(--text3)"></span>
      </div>
      <div class="ai-rule-row">
        <span class="ai-rule-label">ðŸ“Š Stunden-Ausgleich (IST â‰ˆ SOLL)</span>
        <div class="ai-rule-value ai-toggle">
          <input type="checkbox" id="ai-hours-balance" checked>
          <label for="ai-hours-balance">aktiv</label>
        </div>
      </div>
      <div class="ai-rule-row">
        <span class="ai-rule-label">ðŸ—“ WÃ¼nsche & Sperrtage beachten</span>
        <div class="ai-rule-value ai-toggle">
          <input type="checkbox" id="ai-respect-wishes" checked>
          <label for="ai-respect-wishes">aktiv</label>
        </div>
      </div>
      <div id="ai-wish-overview" style="display:none;padding:9px 12px;background:rgba(22,163,74,0.07);border:1px solid rgba(22,163,74,0.2);border-radius:9px;margin-bottom:6px;font-size:11px;line-height:1.7">
        <div style="font-weight:700;color:#16a34a;margin-bottom:4px">ðŸ“‹ VerfÃ¼gbarkeiten:</div>
        <div id="ai-wish-list" style="color:var(--text2)"></div>
      </div>

      <div class="ai-section-title" style="margin-top:16px">âš™ï¸ Modus</div>
      <div class="ai-rule-row">
        <span class="ai-rule-label">Bestehende EintrÃ¤ge</span>
        <div class="ai-rule-value">
          <select id="ai-mode">
            <option value="fill">Nur leere Zellen fÃ¼llen</option>
            <option value="overwrite">Alles neu planen</option>
          </select>
        </div>
      </div>

      <!-- Progress / Log -->
      <div class="ai-progress-bar" id="ai-progress-bar"><div class="ai-progress-fill" id="ai-progress-fill"></div></div>
      <div id="ai-log" class="ai-log"></div>
      <div class="ai-result-badges" id="ai-result-badges" style="display:none"></div>

      <!-- Buttons -->
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-bottom:4px">
        <button class="btn btn-secondary" onclick="closeModal('modal-ai')">Abbrechen</button>
        <button class="btn btn-primary" id="ai-run-btn" onclick="runAIPlanner()"
          style="background:linear-gradient(135deg,var(--teal),var(--teal2));border-color:transparent;color:white;box-shadow:0 4px 16px rgba(91,191,181,0.4)">
          âœ¦ Jetzt planen
        </button>
      </div>
    </div>
  </div>
</div>


<!-- MODAL: IMPORT / EXPORT / ARCHIVE -->
<div class="modal-overlay" id="modal-io">
  <div class="modal" style="min-width:540px;max-width:640px">
    <div class="modal-title">
      ðŸ“¦ Archiv â€“ Speichern Â· Import Â· Export
      <button class="modal-close" onclick="closeModal('modal-io')">Ã—</button>
    </div>

    <!-- SAVE -->
    <div style="margin-bottom:18px;padding:14px;border-radius:10px;background:rgba(91,127,255,0.07);border:1px solid rgba(91,127,255,0.2)">
      <div style="font-size:12px;font-weight:700;color:var(--accent);margin-bottom:8px;letter-spacing:0.5px">ðŸ’¾ LOKALER SPEICHERSTAND</div>
      <div style="font-size:11.5px;color:var(--text2);margin-bottom:10px;line-height:1.6">
        Alle Abteilungen werden automatisch im Browser gespeichert. Klicke <strong>Jetzt sichern</strong> um sicherzustellen, dass alle Ã„nderungen gespeichert sind.
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button onclick="saveAll();closeModal('modal-io')" style="padding:8px 18px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;font-size:12px;font-weight:700;cursor:pointer">
          ðŸ’¾ Jetzt sichern
        </button>
        <span id="io-save-status" style="font-size:11px;color:var(--text3)"></span>
      </div>
    </div>

    <!-- EXPORT -->
    <div style="margin-bottom:18px">
      <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:6px;letter-spacing:0.5px;display:flex;align-items:center;gap:8px">
        â¬‡ EXPORTIEREN
        <span style="font-size:10px;font-weight:500;color:var(--text3);background:var(--surface2);padding:2px 7px;border-radius:10px;font-family:monospace">.dpz</span>
      </div>
      <div style="font-size:11.5px;color:var(--text2);margin-bottom:10px;line-height:1.6">
        Exportiert DienstplÃ¤ne als <code style="font-family:monospace;background:var(--surface2);padding:1px 5px;border-radius:3px">.dpz</code> Datei (JSON-Format). Extern speichern, teilen oder spÃ¤ter wieder importieren.
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="exportPlan('current')" style="padding:8px 16px;border-radius:8px;border:none;background:linear-gradient(135deg,#10b981,#059669);color:white;font-size:12px;font-weight:700;cursor:pointer">
          â¬‡ Aktuelle Abteilung
        </button>
        <button onclick="exportPlan('all')" style="padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--glass2);color:var(--text);font-size:12px;font-weight:600;cursor:pointer">
          â¬‡ Vollsicherung (alle Abteilungen)
        </button>
      </div>
    </div>

    <div style="height:1px;background:var(--border);margin:4px 0 18px"></div>

    <!-- IMPORT -->
    <div>
      <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:6px;letter-spacing:0.5px;display:flex;align-items:center;gap:8px">
        â¬† IMPORTIEREN
        <span style="font-size:10px;font-weight:500;color:var(--text3);background:var(--surface2);padding:2px 7px;border-radius:10px;font-family:monospace">.dpz / .dienstplan</span>
      </div>
      <div style="font-size:11.5px;color:var(--text2);margin-bottom:12px;line-height:1.6">
        LÃ¤dt eine <code style="font-family:monospace;background:var(--surface2);padding:1px 5px;border-radius:3px">.dpz</code> Datei und fÃ¼gt die enthaltenen Abteilungen hinzu. Bestehende Daten bleiben erhalten.
      </div>
      <div id="io-drop-zone" style="border:2px dashed rgba(91,127,255,0.4);border-radius:12px;padding:28px;text-align:center;cursor:pointer;transition:all 0.2s;background:rgba(91,127,255,0.04)"
        onclick="document.getElementById('io-file-input').click()"
        ondragover="event.preventDefault();this.style.borderColor='rgba(91,127,255,0.8)';this.style.background='rgba(91,127,255,0.08)'"
        ondragleave="this.style.borderColor='';this.style.background=''"
        ondrop="event.preventDefault();this.style.borderColor='';this.style.background='';handleImportDrop(event)">
        <div style="font-size:32px;margin-bottom:8px">ðŸ“‚</div>
        <div style="font-size:13px;font-weight:600;color:var(--text2)">Datei hier ablegen oder klicken</div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">.dpz Â· .dienstplan Â· .json</div>
      </div>
      <input type="file" id="io-file-input" accept=".dpz,.dienstplan,.json" style="display:none" onchange="handleImportFile(this)">
      <div id="io-import-result" style="margin-top:12px;font-size:12px;padding:8px 12px;border-radius:8px;background:var(--glass2);display:none"></div>
    </div>
  </div>
</div>

<!-- MODAL: DEPARTMENT MANAGER -->
<div class="modal-overlay" id="modal-depts">
  <div class="modal" style="min-width:480px">
    <div class="modal-title">
      ðŸ¥ Abteilungen verwalten
      <button class="modal-close" onclick="closeModal('modal-depts')">Ã—</button>
    </div>
    <div id="dept-list-container" style="margin-bottom:16px"></div>
    <div style="border-top:1px solid var(--border);padding-top:14px">
      <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px">âž• Neue Abteilung</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="new-dept-name" type="text" placeholder="Name (z.B. Station A1)" maxlength="40"
          style="flex:1;min-width:140px;padding:7px 10px;border-radius:8px;border:1px solid var(--border);background:var(--glass2);color:var(--text);font-size:12px;outline:none"
          onkeydown="if(event.key==='Enter')addDepartment()">
        <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text2)">
          Farbe: <input id="new-dept-color" type="color" value="#5b7fff" style="width:32px;height:28px;border:none;background:transparent;cursor:pointer">
        </div>
        <button onclick="addDepartment()" style="padding:7px 14px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;font-size:12px;font-weight:700;cursor:pointer">
          âž• HinzufÃ¼gen
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: COPY MONTH -->
<div class="modal-overlay" id="modal-copy-month">
  <div class="modal" style="min-width:400px">
    <div class="modal-title">
      ðŸ“‹ Vorlage aus Vormonat
      <button class="modal-close" onclick="closeModal('modal-copy-month')">Ã—</button>
    </div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.6;">
      Dienste aus einem anderen Monat als <strong>Startvorlage</strong> in den aktuellen Monat kopieren.<br>
      <span style="font-size:11px;color:var(--text3);">Bereits belegte Tage werden Ã¼bersprungen.</span>
    </div>
    <div class="form-row">
      <label>Quellmonat</label>
      <select id="copy-source-month">
        <!-- filled by JS -->
      </select>
    </div>
    <div class="form-row">
      <label>Quellmitarbeiter</label>
      <select id="copy-source-emp">
        <option value="__all__">Alle Mitarbeiter (1:1)</option>
        <!-- filled by JS -->
      </select>
    </div>
    <div class="toggle-row" style="margin-bottom:12px">
      <span class="toggle-label">Notizen ebenfalls kopieren</span>
      <label class="toggle-switch"><input type="checkbox" id="copy-with-notes" checked><span class="toggle-slider"></span></label>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('modal-copy-month')">Abbrechen</button>
      <button class="btn btn-primary" onclick="executeCopyMonth()">ðŸ“‹ Jetzt kopieren</button>
    </div>
  </div>
</div>

<!-- ============================================================
     MODAL: EMPLOYEES
     ============================================================ -->
<div class="modal-overlay" id="modal-employees">
  <div class="modal" style="min-width:480px">
    <div class="modal-title">
      ðŸ‘¥ Mitarbeiter verwalten
      <button class="modal-close" onclick="closeModal('modal-employees')">Ã—</button>
    </div>
    <!-- WE-Gruppe SchnellÃ¼bersicht -->
    <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--glass2);border:1px solid var(--border);border-radius:9px;margin-bottom:12px;font-size:11px">
      <span style="color:var(--text3)">ðŸ—“ WE-Gruppen:</span>
      <span id="emp-modal-we-a" style="color:#60a5fa;font-weight:600"></span>
      <span style="color:var(--border)">Â·</span>
      <span id="emp-modal-we-b" style="color:#34d399;font-weight:600"></span>
      <div style="flex:1"></div>
      <button class="btn btn-secondary" style="font-size:10.5px;padding:4px 10px" onclick="autoAssignWeGroups()" title="Alle Mitarbeiter gleichmÃ¤ÃŸig auf A & B verteilen"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Auto A/B</button>
    </div>
    <div id="emp-list-container" class="emp-list"></div>
    <div class="btn-row" style="margin-top:12px;justify-content:flex-start">
      <button class="btn btn-primary" onclick="openAddEmployee()">+ Mitarbeiter hinzufÃ¼gen</button>
    </div>
  </div>
</div>

<!-- MODAL: ADD/EDIT EMPLOYEE -->
<div class="modal-overlay" id="modal-edit-employee">
  <div class="modal" style="min-width:420px">
    <div class="modal-title">
      <span id="emp-edit-title">Mitarbeiter hinzufÃ¼gen</span>
      <button class="modal-close" onclick="closeModal('modal-edit-employee')">Ã—</button>
    </div>
    <div class="form-row">
      <label>Name (Nachname, Vorname)</label>
      <input type="text" id="emp-name-input" placeholder="MUSTERMANN, MAX">
    </div>
    <div class="form-row">
      <label>Rolle / Funktion</label>
      <select id="emp-role-input">
        <option>Stationsleitung</option>
        <option>Stellv. Leitung</option>
        <option>Fachkraft</option>
        <option>Pflegekraft</option>
        <option>Azubi</option>
        <option>Praktikant</option>
        <option>Hilfskraft</option>
      </select>
    </div>
    <div class="form-row">
      <label>Stellenanteil (VZ): <span id="vz-display">100%</span></label>
      <input type="range" id="emp-vz-input" min="10" max="100" step="5" value="100"
        oninput="document.getElementById('vz-display').textContent=this.value+'%'">
    </div>
    <div class="form-row">
      <label>Ãœbertrag Vormonat (Stunden)</label>
      <input type="number" id="emp-vmt-input" value="0" step="0.5">
    </div>

    <!-- Weekend Group -->
    <div class="form-row">
      <label>ðŸ—“ Wochenend-Gruppe</label>
      <div class="we-group-selector">
        <button type="button" class="we-group-btn" data-group="" id="we-btn-none"
          onclick="selectWeGroup('')">Keine</button>
        <button type="button" class="we-group-btn we-A" data-group="A" id="we-btn-a"
          onclick="selectWeGroup('A')">Gruppe A</button>
        <button type="button" class="we-group-btn we-B" data-group="B" id="we-btn-b"
          onclick="selectWeGroup('B')">Gruppe B</button>
      </div>
      <div class="we-group-hint" id="we-group-hint"></div>
    </div>

    <!-- Preferences -->
    <div class="form-row">
      <label>âœ¦ KI-PrÃ¤ferenzen <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--text3)">(Freitext â€“ fÃ¼r KI-Planung)</span></label>
      <textarea id="emp-prefs-input" rows="3"
        placeholder="z. B.: Kein Nachtdienst am Wochenende â€¢ Max. 2 ND am StÃ¼ck â€¢ Bevorzugt FrÃ¼hdienst â€¢ Keine SpÃ¤tdienste an Montagen"
        style="resize:vertical;font-size:12px;line-height:1.6"></textarea>
      <div style="font-size:10.5px;color:var(--text3);margin-top:4px">
        ðŸ’¡ Freitext â€“ Claude liest dies beim Erstellen des KI-Plans und berÃ¼cksichtigt es so gut wie mÃ¶glich.
      </div>
    </div>

    <input type="hidden" id="emp-edit-id">
    <input type="hidden" id="emp-we-group-val" value="">
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('modal-edit-employee')">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveEmployee()">Speichern</button>
    </div>
  </div>
</div>

<!-- MODAL: SHIFT TYPES CONFIG -->
<div class="modal-overlay" id="modal-shifts">
  <div class="modal" style="min-width:560px;max-width:680px">
    <div class="modal-title">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
      Dienste &amp; KÃ¼rzel konfigurieren
      <button class="modal-close" onclick="closeModal('modal-shifts')">Ã—</button>
    </div>
    <!-- Tab bar -->
    <div style="display:flex;gap:4px;border-bottom:2px solid var(--border);margin-bottom:14px">
      <button id="shifts-tab-types" onclick="switchShiftsTab('types')"
        style="padding:7px 16px;border:none;border-radius:6px 6px 0 0;font-size:12px;font-weight:600;cursor:pointer;background:var(--teal);color:white;margin-bottom:-2px;border-bottom:2px solid var(--teal)">
        Diensttypen
      </button>
      <button id="shifts-tab-shortcuts" onclick="switchShiftsTab('shortcuts')"
        style="padding:7px 16px;border:none;border-radius:6px 6px 0 0;font-size:12px;font-weight:600;cursor:pointer;background:var(--glass2);color:var(--text2);margin-bottom:-2px;border-bottom:2px solid transparent">
        âŒ¨ TastenkÃ¼rzel
      </button>
    </div>
    <!-- Panel: Diensttypen -->
    <div id="shifts-panel-types">
      <div style="font-size:11px;color:var(--text3);margin-bottom:12px;">
        KÃ¼rzel Â· Name Â· Stunden Â· Farbe (Text) Â· Hintergrund Â· Reihenfolge per Drag
      </div>
      <div id="shift-config-list"></div>
      <div class="btn-row" style="justify-content:flex-start;margin-top:8px">
        <button class="btn btn-secondary" onclick="addShiftType()">+ Dienst hinzufÃ¼gen</button>
      </div>
    </div>
    <!-- Panel: TastenkÃ¼rzel -->
    <div id="shifts-panel-shortcuts" style="display:none">
      <div style="font-size:12px;color:var(--text2);margin-bottom:6px;line-height:1.5">
        Definiere eigene Tipp-KÃ¼rzel fÃ¼r die schnelle Tastatureingabe.
        <br><span style="color:var(--text3);font-size:11px">Tipp: Im Plan einfach das KÃ¼rzel eintippen â†’ Dienst wird gesetzt. GroÃŸ-/Kleinschreibung egal.</span>
      </div>
      <!-- Vordefinierte KÃ¼rzel (readonly info) -->
      <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin:12px 0 6px">
        Eingebaute KÃ¼rzel
      </div>
      <div id="builtin-shortcuts-display" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px"></div>
      <!-- Custom shortcuts -->
      <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin:0 0 6px">
        Eigene KÃ¼rzel
        <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--text3);margin-left:8px">KÃ¼rzel â†’ Dienst-ID (z.B. "fr" â†’ "FD")</span>
      </div>
      <div id="custom-shortcuts-list"></div>
      <div class="btn-row" style="justify-content:flex-start;margin-top:8px">
        <button class="btn btn-secondary" onclick="addCustomShortcut()">+ KÃ¼rzel hinzufÃ¼gen</button>
      </div>
    </div>
    <div class="btn-row" style="margin-top:16px">
      <button class="btn btn-secondary" onclick="closeModal('modal-shifts')">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveShiftConfig()">Speichern</button>
    </div>
  </div>
</div>

<!-- MODAL: SETTINGS -->
<div class="modal-overlay" id="modal-settings">
  <div class="modal" style="min-width:420px">
    <div class="modal-title">
      â˜° Einstellungen
      <button class="modal-close" onclick="closeModal('modal-settings')">Ã—</button>
    </div>

    <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;">Spalten anzeigen</div>
    <div class="settings-grid" id="col-toggles"></div>

    <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 10px;">FuÃŸzeile Dienste zÃ¤hlen</div>
    <div id="footer-toggles" style="display:flex;flex-wrap:wrap;gap:6px;"></div>

    <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 10px;">Stundenfaktor</div>
    <div class="form-row" style="margin-bottom:0">
      <input type="number" id="hour-factor-input" value="7.7" step="0.1" min="1" max="12">
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('modal-settings')">SchlieÃŸen</button>
      <button class="btn btn-primary" onclick="applySettings()">Ãœbernehmen</button>
    </div>
  </div>
</div>

<!-- MODAL: MONATSSTATISTIK -->
<div class="modal-overlay" id="modal-stats">
  <div class="modal" style="min-width:600px;max-width:780px">
    <div class="modal-title">
      ðŸ“Š Monatsstatistik â€“ <span id="stats-month-label"></span>
      <button class="modal-close" onclick="closeModal('modal-stats')">Ã—</button>
    </div>
    <!-- Tab bar -->
    <div style="display:flex;gap:4px;padding:10px 20px 0;border-bottom:1px solid var(--border);margin-bottom:0">
      <button id="stats-tab-overview" onclick="switchStatsTab('overview')"
        style="padding:6px 14px;border:none;border-radius:6px 6px 0 0;font-size:12px;font-weight:600;cursor:pointer;background:var(--helios-red);color:white">Ãœbersicht</button>
      <button id="stats-tab-check" onclick="switchStatsTab('check')"
        style="padding:6px 14px;border:none;border-radius:6px 6px 0 0;font-size:12px;font-weight:600;cursor:pointer;background:var(--glass2);color:var(--text2)">Monats-Check</button>
      <div style="flex:1"></div>
      <button onclick="markHolidaysAsFrei()" style="padding:5px 12px;border:1px solid var(--border);border-radius:6px;font-size:11px;font-weight:600;background:var(--glass2);color:var(--text2);cursor:pointer;margin-bottom:2px"
        title="Alle freien Feiertage automatisch als 'X' markieren"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8 6 12 2 16 6"/></svg> Feiertage â†’ Frei</button>
    </div>
    <div id="stats-content" style="padding:16px 0 4px"></div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('modal-stats')">SchlieÃŸen</button>
    </div>
  </div>
</div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
// =============================================================================
// STATE
// =============================================================================
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let currentView = 'month';
let currentWeek = 1;
let currentZoom = 1;
let editLocked = false;
let darkMode = false;
let selectedShift = 'FD';
let contextTarget = null;
let focusEmpId    = null;
let panModeActive = false;
let wishes    = {};
let wishMode  = false;
let cellClipboard  = null;
let navCell        = null;
let empFilter      = '';
let customShortcuts = {}; // { 'kÃ¼rzel': 'SHIFT_ID' }

// Multi-cell selection
let selectedCells  = new Set(); // Set of "empId|ds" strings
let isSelecting    = false;     // drag-selection active
let selAnchor      = null;      // { empId, ds } start of drag

// Keyboard typing buffer (e.g. "fd" â†’ FD)
let _kbBuffer      = '';
let _kbTimer       = null;

// =============================================================================
// UNSAVED INDICATOR
// =============================================================================
let _hasUnsaved = false;
function markUnsaved() {
  _hasUnsaved = true;
  document.body.classList.add('has-unsaved');
  const tab = document.querySelector('.dept-tab.active');
  if (tab) tab.classList.add('has-unsaved');
}
function clearUnsaved() {
  _hasUnsaved = false;
  document.body.classList.remove('has-unsaved');
  document.querySelectorAll('.dept-tab').forEach(t => t.classList.remove('has-unsaved'));
}

// =============================================================================
// UNDO / REDO
// =============================================================================
const MAX_HISTORY = 50;
let undoStack = [];
let redoStack = [];

function pushHistory() {
  undoStack.push(JSON.stringify(shifts));
  if (undoStack.length > MAX_HISTORY) undoStack.shift();
  redoStack = [];
  updateUndoRedoBtns();
  markUnsaved();
}
function undoAction() {
  if (!undoStack.length) return;
  redoStack.push(JSON.stringify(shifts));
  shifts = JSON.parse(undoStack.pop());
  updateUndoRedoBtns();
  renderTable(); saveLocal();
  showToast('\u21a9 R\u00fckg\u00e4ngig');
}
function redoAction() {
  if (!redoStack.length) return;
  undoStack.push(JSON.stringify(shifts));
  shifts = JSON.parse(redoStack.pop());
  updateUndoRedoBtns();
  renderTable(); saveLocal();
  showToast('\u21aa Wiederholt');
}
function updateUndoRedoBtns() {
  const ub = document.getElementById('undo-btn'); if(ub) ub.disabled = undoStack.length === 0;
  const rb = document.getElementById('redo-btn'); if(rb) rb.disabled = redoStack.length === 0;
  // Also sync drawer buttons
  const ud = document.getElementById('undo-btn-d');
  const rd = document.getElementById('redo-btn-d');
  if (ud) ud.disabled = undoStack.length === 0;
  if (rd) rd.disabled = redoStack.length === 0;
}

// =============================================================================
// DEPARTMENT MANAGEMENT
// =============================================================================
const DEPT_COLORS = ['#5b7fff','#f97316','#10b981','#d946ef','#e11d48','#0ea5e9','#a78bfa','#f59e0b'];
const DEFAULT_SHIFT_TYPES = [
  { id: 'FD', label: 'FD', name: 'Fr\u00fcdienst',    hours: 7.7, color: '#ffffff', bg: '#0ea5e9' },
  { id: 'SD', label: 'SD', name: 'Sp\u00e4tdienst',   hours: 7.7, color: '#ffffff', bg: '#d946ef' },
  { id: 'ND', label: 'ND', name: 'Nachtdienst',       hours: 10,  color: '#ffffff', bg: '#f97316' },
  { id: 'ZD', label: 'ZD', name: 'Zwischendienst',    hours: 7.7, color: '#ffffff', bg: '#7c3aed' },
  { id: 'ST', label: 'ST', name: 'Sp\u00e4tteam',     hours: 7.7, color: '#ffffff', bg: '#2563eb' },
  { id: 'U',  label: 'U',  name: 'Urlaub',            hours: 0,   color: '#92400e', bg: '#fef3c7' },
  { id: 'K',  label: 'K',  name: 'Krank',             hours: 0,   color: '#ffffff', bg: '#ef4444' },
  { id: 'LT', label: 'LT', name: 'Langzeit',          hours: 7.7, color: '#ffffff', bg: '#10b981' },
  { id: 'X',  label: 'X',  name: 'Frei',              hours: 0,   color: '#64748b', bg: '#f1f5f9' },
];
const DEFAULT_EMPLOYEES = [
  { id: 'e1',  name: 'ADAMS, HENDRIK',         role: 'Stationsleitung', vz: 100, vmt: 0, weGroup: 'A', preferences: '' },
  { id: 'e2',  name: 'FUCHSA, JENNIFER',        role: 'Stellv. Leitung', vz: 100, vmt: 0, weGroup: 'B', preferences: '' },
  { id: 'e3',  name: 'G\u00dcNTER, STEPHANIE',  role: 'Fachkraft',       vz: 100, vmt: 0, weGroup: 'A', preferences: '' },
  { id: 'e4',  name: 'BLANK, ALEXANDRA',        role: 'Fachkraft',       vz: 100, vmt: 0, weGroup: 'B', preferences: '' },
  { id: 'e5',  name: 'FRIEDRICH, KRISTINA',     role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'A', preferences: '' },
  { id: 'e6',  name: 'WEIENBERG, HANNA',        role: 'Fachkraft',       vz: 100, vmt: 0, weGroup: 'B', preferences: '' },
  { id: 'e7',  name: 'HACKMANN, MATTHIAS',      role: 'Fachkraft',       vz:  90, vmt: 0, weGroup: 'A', preferences: 'Max. 2 Nachtdienste am St\u00fcck' },
  { id: 'e8',  name: 'BUCHM\u00dcLLER, J\u00d6RG', role: 'Fachkraft',  vz: 100, vmt: 0, weGroup: 'B', preferences: '' },
  { id: 'e9',  name: 'R\u00d6SKEN, KATRIN',     role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'A', preferences: 'Kein Nachtdienst am Wochenende wenn m\u00f6glich' },
  { id: 'e10', name: 'THEISSEN, JENNIFER',      role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'B', preferences: '' },
  { id: 'e11', name: 'DANIELS, JUSTIN',         role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'A', preferences: '' },
  { id: 'e12', name: 'KAYMAZ, MELDA',           role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'B', preferences: '' },
  { id: 'e13', name: 'K\u00dcHN, PHILIPP',      role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'A', preferences: '' },
  { id: 'e14', name: 'STRACHANSKI, JULIA',      role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'B', preferences: '' },
  { id: 'e15', name: 'PREUSSNER, PAULINE',      role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'A', preferences: '' },
  { id: 'e16', name: 'BIELOK, LARA',            role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'B', preferences: '' },
  { id: 'e17', name: 'W\u00dcSTKAMP, BIANCA',   role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'A', preferences: '' },
  { id: 'e18', name: 'BONDZAU, MARTINA',        role: 'Pflegekraft',     vz: 100, vmt: 0, weGroup: 'B', preferences: '' },
];

function makeDefaultDept(id, name, color) {
  return {
    id, name, color,
    employees:  JSON.parse(JSON.stringify(DEFAULT_EMPLOYEES)),
    shifts:     {},
    shiftTypes: JSON.parse(JSON.stringify(DEFAULT_SHIFT_TYPES)),
    settings:   { cols:{vz:true,soll:true,ist:true,diff:true,vmt:true}, footerShifts:{}, hourFactor:7.7 },
    wishes:     {}
  };
}

let departments   = [ makeDefaultDept('dept_1', 'Station A3', DEPT_COLORS[0]) ];
let currentDeptId = 'dept_1';

function currentDept() {
  return departments.find(d => d.id === currentDeptId) || departments[0];
}
function saveDeptState(dept) {
  dept.employees  = JSON.parse(JSON.stringify(employees));
  dept.shifts     = JSON.parse(JSON.stringify(shifts));
  dept.shiftTypes = JSON.parse(JSON.stringify(shiftTypes));
  dept.settings   = JSON.parse(JSON.stringify(settings));
  dept.wishes     = JSON.parse(JSON.stringify(wishes));
}
function loadDeptState(dept) {
  employees  = JSON.parse(JSON.stringify(dept.employees  || DEFAULT_EMPLOYEES));
  shifts     = JSON.parse(JSON.stringify(dept.shifts     || {}));
  shiftTypes = JSON.parse(JSON.stringify(dept.shiftTypes || DEFAULT_SHIFT_TYPES));
  wishes     = JSON.parse(JSON.stringify(dept.wishes     || {}));
  settings   = Object.assign(
    { cols:{vz:true,soll:true,ist:true,diff:true,vmt:true}, footerShifts:{}, hourFactor:7.7 },
    JSON.parse(JSON.stringify(dept.settings || {}))
  );
  shiftTypes.forEach(st => { if (settings.footerShifts[st.id] === undefined) settings.footerShifts[st.id] = true; });
}

function switchDept(id) {
  if (id === currentDeptId) return;
  saveDeptState(currentDept());
  saveLocal();
  currentDeptId = id;
  const dept = currentDept();
  loadDeptState(dept);
  document.getElementById('header-dept-name').textContent = dept.name;
  undoStack = []; redoStack = [];
  updateUndoRedoBtns();
  clearUnsaved();
  renderDeptTabs();
  render();
  showToast('\ud83d\udcc2 ' + dept.name);
}

function addDept() {
  const name = prompt('Name der neuen Abteilung:', 'Neue Station');
  if (!name || !name.trim()) return;
  const id = 'dept_' + Date.now();
  const color = DEPT_COLORS[departments.length % DEPT_COLORS.length];
  const newDept = {
    id, name: name.trim(), color,
    employees: [], shifts: {},
    shiftTypes: JSON.parse(JSON.stringify(DEFAULT_SHIFT_TYPES)),
    settings: { cols:{vz:true,soll:true,ist:true,diff:true,vmt:true}, footerShifts:{}, hourFactor:7.7 },
    wishes: {}
  };
  DEFAULT_SHIFT_TYPES.forEach(st => { newDept.settings.footerShifts[st.id] = true; });
  saveDeptState(currentDept());
  departments.push(newDept);
  saveLocal();
  switchDept(id);
}

function renameDept(id) {
  const dept = departments.find(d => d.id === id);
  if (!dept) return;
  const name = prompt('Neuer Name:', dept.name);
  if (!name || !name.trim()) return;
  dept.name = name.trim();
  if (id === currentDeptId) document.getElementById('header-dept-name').textContent = dept.name;
  renderDeptTabs(); saveLocal();
  showToast('\u270f\ufe0f Umbenannt');
}

function deleteDept(id) {
  if (departments.length <= 1) { showToast('\u26a0\ufe0f Mindestens eine Abteilung n\u00f6tig'); return; }
  const dept = departments.find(d => d.id === id);
  if (!confirm('Abteilung "' + (dept ? dept.name : '') + '" wirklich l\u00f6schen?\nAlle Dienstplandaten gehen unwiderruflich verloren!')) return;
  departments = departments.filter(d => d.id !== id);
  if (currentDeptId === id) {
    currentDeptId = departments[0].id;
    loadDeptState(departments[0]);
    document.getElementById('header-dept-name').textContent = departments[0].name;
    render();
  }
  renderDeptTabs(); saveLocal();
  showToast('\ud83d\uddd1\ufe0f Abteilung gel\u00f6scht');
}

function changeDeptColor(id) {
  const dept = departments.find(d => d.id === id);
  if (!dept) return;
  const inp = document.createElement('input');
  inp.type = 'color'; inp.value = dept.color;
  inp.onchange = () => { dept.color = inp.value; renderDeptTabs(); saveLocal(); };
  inp.click();
}

function renderDeptTabs() {
  const bar = document.getElementById('dept-bar');
  if (!bar) return;
  let html = '';
  departments.forEach(dept => {
    const isActive = dept.id === currentDeptId;
    html += '<div class="dept-tab' + (isActive ? ' active' : '') + '"'
      + ' onclick="switchDept(\'' + dept.id + '\')"'
      + ' ondblclick="renameDept(\'' + dept.id + '\')"'
      + ' title="Klick: wechseln  \u2022  Doppelklick: umbenennen  \u2022  Rechtsklick: Optionen"'
      + ' oncontextmenu="showDeptMenu(event,\'' + dept.id + '\')">'
      + '<div class="dept-tab-dot" style="background:' + dept.color + '"></div>'
      + '<span>' + escapeHTML(dept.name) + '</span>'
      + '<div class="dept-tab-unsaved" title="Ungespeicherte \u00c4nderungen"></div>'
      + '</div>';
  });
  html += '<div class="dept-bar-spacer"></div>';
  html += '<button class="dept-tab-add" onclick="addDept()" title="Neue Abteilung anlegen">\uff0b Abteilung</button>';
  html += '<button class="dept-manage-btn" onclick="openModal(\'modal-io\')" title="Speichern \u00b7 Import \u00b7 Export">\ud83d\udce6 Archiv</button>';
  bar.innerHTML = html;
}

let _deptMenuEl = null;
function showDeptMenu(e, deptId) {
  e.preventDefault(); e.stopPropagation();
  if (_deptMenuEl) { _deptMenuEl.remove(); _deptMenuEl = null; }
  const menu = document.createElement('div');
  menu.style.cssText = 'position:fixed;left:' + Math.min(e.clientX, window.innerWidth - 210) + 'px;top:' + (e.clientY + 4) + 'px;z-index:9000;'
    + 'background:rgba(14,16,34,0.97);border:1px solid rgba(255,255,255,0.12);border-radius:10px;'
    + 'padding:5px 0;box-shadow:0 8px 32px rgba(0,0,0,0.55);min-width:208px;backdrop-filter:blur(16px)';
  const items = [
    ['\u270f\ufe0f Umbenennen', 'renameDept(\'' + deptId + '\')'],
    ['\ud83c\udfa8 Farbe \u00e4ndern', 'changeDeptColor(\'' + deptId + '\')'],
    null,
    ['\u2b07 Abteilung exportieren (.dpz)', 'exportDept(\'' + deptId + '\')'],
    ['\ud83d\udce6 Archiv \u00f6ffnen', 'openModal(\'modal-io\')'],
    null,
    ['\ud83d\uddd1\ufe0f Abteilung l\u00f6schen', 'deleteDept(\'' + deptId + '\')', '#f87171'],
  ];
  items.forEach(item => {
    if (!item) { const d = document.createElement('div'); d.className = 'ctx-divider'; menu.appendChild(d); return; }
    const el = document.createElement('div');
    el.className = 'ctx-item';
    el.textContent = item[0];
    if (item[2]) el.style.color = item[2];
    el.onclick = () => { menu.remove(); _deptMenuEl = null; new Function(item[1])(); };
    menu.appendChild(el);
  });
  document.body.appendChild(menu);
  _deptMenuEl = menu;
  const cleanup = (ev) => { if (!menu.contains(ev.target)) { menu.remove(); _deptMenuEl = null; document.removeEventListener('click', cleanup); } };
  setTimeout(() => document.addEventListener('click', cleanup), 60);
}

let settings = {
  cols: { vz: true, soll: true, ist: true, diff: true, vmt: true },
  footerShifts: {},
  hourFactor: 7.7
};
let shiftTypes = JSON.parse(JSON.stringify(DEFAULT_SHIFT_TYPES));
let employees  = JSON.parse(JSON.stringify(DEFAULT_EMPLOYEES));

// shifts[empId][dateStr] = {type:'FD', note:''}
let shifts = {};

// =============================================================================
// HOLIDAYS (NRW)
// =============================================================================
function getNRWHolidays(year) {
  // Easter calculation (Gauss)
  const a = year % 19, b = Math.floor(year / 100), c = year % 100;
  const d = Math.floor(b / 4), e = b % 4;
  const f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4), k = c % 4;
  const l = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * l) / 451);
  const month = Math.floor((h + l - 7 * m + 114) / 31);
  const day = ((h + l - 7 * m + 114) % 31) + 1;
  const easter = new Date(year, month - 1, day);

  function addDays(date, n) {
    const d = new Date(date);
    d.setDate(d.getDate() + n);
    return d;
  }
  function fmt(d) {
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  const h_fixed = {
    [`${year}-01-01`]: 'Neujahr',
    [`${year}-05-01`]: 'Tag der Arbeit',
    [`${year}-10-03`]: 'Tag der Deutschen Einheit',
    [`${year}-11-01`]: 'Allerheiligen',
    [`${year}-12-25`]: '1. Weihnachtstag',
    [`${year}-12-26`]: '2. Weihnachtstag',
  };
  const h_movable = {
    [fmt(addDays(easter, -2))]:  'Karfreitag',
    [fmt(easter)]:               'Ostersonntag',
    [fmt(addDays(easter, 1))]:   'Ostermontag',
    [fmt(addDays(easter, 39))]:  'Christi Himmelfahrt',
    [fmt(addDays(easter, 49))]:  'Pfingstsonntag',
    [fmt(addDays(easter, 50))]:  'Pfingstmontag',
    [fmt(addDays(easter, 60))]:  'Fronleichnam',
  };
  return { ...h_fixed, ...h_movable };
}

// =============================================================================
// DATE HELPERS
// =============================================================================
const DAYS_DE = ['SO','MO','DI','MI','DO','FR','SA'];
const MONTHS_DE = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];

function daysInMonth(y, m) { return new Date(y, m+1, 0).getDate(); }

function dateStr(y, m, d) {
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

function isWeekend(y, m, d) {
  const dow = new Date(y, m, d).getDay();
  return dow === 0 || dow === 6;
}

function isToday(y, m, d) {
  const t = new Date();
  return t.getFullYear() === y && t.getMonth() === m && t.getDate() === d;
}

function getWorkdays(y, m) {
  const hols = getNRWHolidays(y);
  let count = 0;
  for (let d = 1; d <= daysInMonth(y, m); d++) {
    const ds = dateStr(y, m, d);
    const dow = new Date(y, m, d).getDay();
    if (dow >= 1 && dow <= 5 && !hols[ds]) count++;
  }
  return count;
}

function calcSoll(vz, workdays, hourFactor) {
  return Math.round(workdays * hourFactor * (vz / 100) * 10) / 10;
}

function calcIst(empId, y, m) {
  const empShifts = shifts[empId] || {};
  let total = 0;
  for (let d = 1; d <= daysInMonth(y, m); d++) {
    const ds = dateStr(y, m, d);
    if (empShifts[ds] && empShifts[ds].type) {
      const st = shiftTypes.find(s => s.id === empShifts[ds].type);
      if (st) total += st.hours;
    }
  }
  return Math.round(total * 10) / 10;
}

// =============================================================================
// GET VISIBLE DAYS (month or week)
// =============================================================================
function getVisibleDays() {
  const total = daysInMonth(currentYear, currentMonth);
  if (currentView === 'month') {
    return Array.from({length: total}, (_, i) => i+1);
  } else {
    // Week: 7 days per week, starting Monday of currentWeek
    const firstDay = new Date(currentYear, currentMonth, 1);
    const firstDow = firstDay.getDay(); // 0=Sun
    // Days in current month, grouped by ISO week
    const weeks = [];
    let week = [];
    for (let d = 1; d <= total; d++) {
      const dow = new Date(currentYear, currentMonth, d).getDay();
      if (dow === 1 && week.length > 0) { weeks.push(week); week = []; }
      week.push(d);
    }
    if (week.length > 0) weeks.push(week);
    const wk = weeks[Math.min(currentWeek-1, weeks.length-1)] || weeks[0];
    updateWeekLabel(wk);
    return wk;
  }
}

function getWeeksInMonth() {
  const total = daysInMonth(currentYear, currentMonth);
  const weeks = [];
  let week = [];
  for (let d = 1; d <= total; d++) {
    const dow = new Date(currentYear, currentMonth, d).getDay();
    if (dow === 1 && week.length > 0) { weeks.push(week); week = []; }
    week.push(d);
  }
  if (week.length > 0) weeks.push(week);
  return weeks.length;
}

function updateWeekLabel(days) {
  if (!days || days.length === 0) return;
  const d1 = days[0], d2 = days[days.length-1];
  document.getElementById('week-label').textContent = `${d1}.â€“${d2}. ${MONTHS_DE[currentMonth].substring(0,3)}.`;
}

// =============================================================================
// RENDER
// =============================================================================
function render() {
  renderHeader();
  renderSidebar();
  renderTable();
  applyZoom();
}

function renderHeader() {
  document.getElementById('month-label').textContent =
    `${MONTHS_DE[currentMonth].toUpperCase()} ${currentYear}`;
  const wd = getWorkdays(currentYear, currentMonth);
  document.getElementById('workdays-badge').textContent = `${wd} Arbeitstage`;
}

function renderSidebar() {
  const sb = document.getElementById('sidebar');
  sb.innerHTML = '';
  let dragSrcId = null;

  shiftTypes.forEach(st => {
    const btn = document.createElement('button');
    btn.className = 'sidebar-shift-btn' + (selectedShift === st.id ? ' selected' : '');
    btn.style.background = st.bg;
    btn.style.color = st.color;
    btn.title = `${st.name} (${st.hours}h) â€” Ziehen zum Sortieren`;
    btn.innerHTML = `${st.label}<span>${st.hours}h</span>`;
    btn.setAttribute('draggable', 'true');
    btn.dataset.id = st.id;

    btn.addEventListener('click', () => {
      selectedShift = st.id;
      renderSidebar();
    });

    // Drag reorder sidebar
    btn.addEventListener('dragstart', e => {
      dragSrcId = st.id;
      btn.classList.add('dragging-shift');
      e.dataTransfer.effectAllowed = 'move';
    });
    btn.addEventListener('dragend', () => btn.classList.remove('dragging-shift'));
    btn.addEventListener('dragover', e => { e.preventDefault(); btn.classList.add('drag-over-shift'); });
    btn.addEventListener('dragleave', () => btn.classList.remove('drag-over-shift'));
    btn.addEventListener('drop', e => {
      e.preventDefault();
      btn.classList.remove('drag-over-shift');
      const toId = st.id;
      if (!dragSrcId || dragSrcId === toId) return;
      const fromIdx = shiftTypes.findIndex(s => s.id === dragSrcId);
      const toIdx   = shiftTypes.findIndex(s => s.id === toId);
      const [moved] = shiftTypes.splice(fromIdx, 1);
      shiftTypes.splice(toIdx, 0, moved);
      dragSrcId = null;
      renderSidebar();
      saveLocal();
    });

    sb.appendChild(btn);
  });
}

function renderTable() {
  const holidays = getNRWHolidays(currentYear);
  const days = getVisibleDays();
  const thead = document.getElementById('plan-thead');
  const tbody = document.getElementById('plan-tbody');
  const tfoot = document.getElementById('plan-tfoot');

  // --- Pre-compute per-day counts for warnings + coverage bars ---
  const WARN_SHIFTS = ['FD', 'SD', 'ND'];
  const MIN_STAFF = 2;
  const dayCounts = {}; // dayCounts[ds][shiftId] = count
  const maxDayCount = employees.length; // for scaling bars
  days.forEach(d => {
    const ds = dateStr(currentYear, currentMonth, d);
    dayCounts[ds] = {};
    WARN_SHIFTS.forEach(sid => {
      dayCounts[ds][sid] = employees.filter(emp =>
        shifts[emp.id]?.[ds]?.type === sid
      ).length;
    });
  });

  // --- THEAD ---
  let thHTML = '<tr>';
  thHTML += `<th class="stat-th emp-th" style="left:0"><div class="th-inner th-employee" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3)">Mitarbeiter</div></th>`;

  let statLeft = 150;
  const statCols = [
    {key:'vz', label:'VZ'},
    {key:'soll', label:'Soll'},
    {key:'ist', label:'Ist'},
    {key:'diff', label:'+/âˆ’'},
    {key:'vmt', label:'Vmt'},
  ];
  statCols.forEach(col => {
    if (!settings.cols[col.key]) return;
    thHTML += `<th class="stat-th" style="left:${statLeft}px"><div class="th-inner col-stat">${col.label}</div></th>`;
    statLeft += 38;
  });

  days.forEach(d => {
    const ds = dateStr(currentYear, currentMonth, d);
    const dow = new Date(currentYear, currentMonth, d).getDay();
    const dayName = DAYS_DE[dow];
    const wknd = isWeekend(currentYear, currentMonth, d);
    const isHol = !!holidays[ds];
    const isTod = isToday(currentYear, currentMonth, d);
    let cls = '';
    if (isTod) cls = 'th-today';
    else if (isHol) cls = 'th-holiday';
    else if (wknd) cls = 'th-weekend';

    // Warning logic: ALL days (inkl. Wochenende & Feiertage)
    let warnHTML = '';
    const missingShifts = WARN_SHIFTS.filter(sid => (dayCounts[ds][sid] || 0) < MIN_STAFF);
    if (missingShifts.length > 0) {
      const hasCritical = missingShifts.some(sid => (dayCounts[ds][sid] || 0) === 0);
      const dotClass = hasCritical ? 'warn-dot critical' : 'warn-dot';
      const labelsHTML = missingShifts.map(sid => {
        const cnt = dayCounts[ds][sid] || 0;
        const isCrit = cnt === 0;
        return `<span class="warn-label${isCrit ? ' critical' : ''}" title="${sid}: nur ${cnt} von mind. 2">${sid}:${cnt}</span>`;
      }).join('');
      warnHTML = `<div class="warn-row"><div class="${dotClass}"></div>${labelsHTML}</div>`;
    }

    thHTML += `<th class="${cls}"><div class="th-inner">
      <div class="th-day-num">${d}</div>
      <div class="th-day-name">${dayName}</div>
      ${buildCoverageBars(ds, maxDayCount)}
      ${warnHTML}
    </div></th>`;
  });
  thHTML += '</tr>';
  thead.innerHTML = thHTML;

  // --- Compute sticky left positions ---
  const EMP_WIDTH = 150;
  const STAT_WIDTH = 44;
  let stickyLeftAcc = EMP_WIDTH;
  const statLeftMap = {};
  statCols.forEach(col => {
    statLeftMap[col.key] = stickyLeftAcc;
    if (settings.cols[col.key]) stickyLeftAcc += STAT_WIDTH;
  });

  // --- TBODY ---
  let tbHTML = '';
  employees.forEach((emp, idx) => {
    const workdays = getWorkdays(currentYear, currentMonth);
    const soll = calcSoll(emp.vz, workdays, settings.hourFactor);
    const ist  = calcIst(emp.id, currentYear, currentMonth);
    const diff = Math.round((ist - soll + (emp.vmt||0)) * 10) / 10;
    const diffSign = diff >= 0 ? '+' : '';
    const diffClass = diff >= 0 ? 'positive' : 'negative';

    tbHTML += `<tr class="emp-row" data-empid="${emp.id}" draggable="${!editLocked}" 
      ondragstart="dragStart(event,'${emp.id}')"
      ondragover="dragOver(event)"
      ondrop="dropRow(event,'${emp.id}')"
      ondragend="dragEnd(event)">`;

    const weBadge = emp.weGroup ? `<span class="we-badge ${emp.weGroup}" title="Wochenend-Gruppe ${emp.weGroup}">${emp.weGroup}</span>` : '';
    const prefDot = emp.preferences ? `<span title="KI-PrÃ¤ferenz: ${escapeHTML(emp.preferences)}" style="color:#c084fc;font-size:9px;cursor:help">âœ¦</span>` : '';
    tbHTML += `<td class="employee-cell emp-cell"
      onmouseenter="showEmpTooltip(event,'${emp.id}')"
      onmouseleave="hideEmpTooltip()"
      onclick="toggleFocusMode('${emp.id}')"
      ondblclick="event.stopPropagation();openEditEmployee('${emp.id}')"
      oncontextmenu="handleEmpContextMenu(event,'${emp.id}')">
      ${emp.weGroup ? `<div class="emp-we-strip ${emp.weGroup}"></div>` : ''}
      <div class="emp-name" style="display:flex;align-items:center;gap:5px">${emp.name} ${weBadge} ${prefDot}</div>
      <div class="emp-role">${emp.role}</div>
      <div class="emp-fill-hint">Doppelklick: Bearbeiten â€¢ Rechtsklick: AusfÃ¼llen</div>
      <button class="row-clear-btn" title="Monat leeren" onclick="event.stopPropagation();clearEmployeeMonth('${emp.id}')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>
    </td>`;

    if (settings.cols.vz)   tbHTML += `<td class="stat-cell stat-vz" style="position:sticky;left:${statLeftMap.vz}px">${emp.vz}%</td>`;
    if (settings.cols.soll) tbHTML += `<td class="stat-cell" style="position:sticky;left:${statLeftMap.soll}px">${soll}</td>`;
    if (settings.cols.ist)  tbHTML += `<td class="stat-cell" style="position:sticky;left:${statLeftMap.ist}px">${ist}</td>`;
    if (settings.cols.diff) tbHTML += `<td class="stat-cell ${diffClass}" style="position:sticky;left:${statLeftMap.diff}px">${diffSign}${diff}</td>`;
    if (settings.cols.vmt)  tbHTML += `<td class="stat-cell" style="position:sticky;left:${statLeftMap.vmt}px">${emp.vmt||0}</td>`;

    days.forEach(d => {
      const ds = dateStr(currentYear, currentMonth, d);
      const wknd = isWeekend(currentYear, currentMonth, d);
      const isHol = !!holidays[ds];
      const isTod = isToday(currentYear, currentMonth, d);
      let cls = 'day-cell';
      if (isTod) cls += ' today-col';
      else if (isHol) cls += ' holiday';
      else if (wknd) cls += ' weekend';

      const empShifts = shifts[emp.id] || {};
      const cell = empShifts[ds];
      const hasNote = !!(cell && cell.note && cell.note.trim());
      const hasShift = !!(cell && cell.type);
      let inner = '';

      // Note-edit pencil button (shown on hover via CSS)
      const noteEditBtn = editLocked ? '' :
        `<button class="note-edit-btn" onclick="event.stopPropagation();openNotePopup('${emp.id}','${ds}')" title="Notiz bearbeiten">âœŽ</button>`;

      if (hasShift) {
        const st = shiftTypes.find(s => s.id === cell.type);
        if (st) {
          const noteDot = hasNote ? `<span class="note-dot"></span>` : '';
          const swapDot = cell.swap ? `<span class="swap-dot" title="Zum Tauschen ausgeschrieben">ðŸ”„</span>` : '';

          // âš¡ Ruhezeit-Check (ArbZG Â§5 â€“ mind. 11h Ruhezeit)
          // Typische Schichtzeiten im Krankenhaus:
          //   ND: 22:00 â€“ 06:00 (endet morgens!) â†’ FD/ZD selber Tag = 0-2h Pause = KRITISCH
          //   SD: 14:00 â€“ 22:30 â†’ FD nÃ¤chster Tag 06:00 = ~7.5h < 11h = VERLETZUNG
          //   ST: 13:00 â€“ 22:00 â†’ FD nÃ¤chster Tag 06:00 = ~8h < 11h = VERLETZUNG
          //   ZD: 08:00 â€“ 18:00 â†’ FD nÃ¤chster Tag 06:00 = ~12h = GRENZWERTIG
          //   LT: Ganztags  â†’ FD nÃ¤chster Tag = ggf. zu kurz
          let restBadge = '';
          // Get prev day date string (cross-month-border aware)
          const getPrevDs = (day) => {
            if (day > 1) return dateStr(currentYear, currentMonth, day - 1);
            const pm = currentMonth === 0 ? 11 : currentMonth - 1;
            const py = currentMonth === 0 ? currentYear - 1 : currentYear;
            return dateStr(py, pm, daysInMonth(py, pm));
          };
          const prevDs = getPrevDs(d);
          const prevCell = shifts[emp.id]?.[prevDs];
          const prevType = prevCell?.type || '';

          // Find matching shift type label for dynamic naming
          const findLabel = (id) => shiftTypes.find(s => s.id === id)?.label || id;

          if (prevType) {
            // â”€â”€â”€ Ruhezeitmatrix nach ArbZG Â§5 (mind. 11h Ruhezeit) â”€â”€â”€
            // Schichtzeiten Helios Duisburg:
            //   ND  22:00â€“06:00 | SD  14:00â€“22:30 | ST  13:00â€“22:00
            //   FD  06:00â€“14:00 | ZD  08:00â€“18:00 | LT  08:00â€“16:00
            //   FB/FT  ganztags  | U/URL  ganztags

            const isFortbildung = (id) => /^(FT|FB|FO|FBT|FORT)/i.test(id);
            const isUrlaub      = (id) => /^(U|URL|KR|AZV|BER)/i.test(id);

            // Ruhezeit-SchÃ¤tzung in Stunden: prevType â†’ currentType
            const restHours = (prev, curr) => {
              const ends   = { ND:6,  SD:22.5, ST:22, FD:14, ZD:18, LT:16 };
              const starts = { FD:6,  ZD:8,    LT:8,  SD:14, ST:13 };
              const prevEnd   = ends[prev]   ?? (isFortbildung(prev) ? 17 : (isUrlaub(prev) ? 0 : null));
              const currStart = starts[curr] ?? (isFortbildung(curr) ? 8  : (isUrlaub(curr) ? 0 : null));
              if (prevEnd === null || currStart === null) return 99; // unbekannt â†’ kein Badge
              let rest = currStart - prevEnd;
              if (rest < 0) rest += 24; // NachtÃ¼bergang
              return rest;
            };

            // ND-spezifische Regeln (ND endet 06:00)
            const isNDCritical = prevType === 'ND' && ['FD','ZD','LT'].includes(cell.type);
            const isNDFortbild  = prevType === 'ND' && isFortbildung(cell.type);
            const isNDHigh      = prevType === 'ND' && ['SD','ST'].includes(cell.type);
            const isNDUrlaub    = prevType === 'ND' && isUrlaub(cell.type);

            // SD/ST-Regeln (enden ~22:00)
            const isSDHigh = ['SD','ST'].includes(prevType) && ['FD','ZD','LT'].includes(cell.type);
            const isSDFort = ['SD','ST'].includes(prevType) && isFortbildung(cell.type);

            // ZD/LT-Grenzwert
            const isBorder = ['ZD','LT'].includes(prevType) && ['FD'].includes(cell.type);

            let severity = null, hours = 99, hoursStr = '';

            if      (isNDCritical || isNDFortbild) { severity = 'critical'; hoursStr = '0â€“2'; }
            else if (isNDHigh)                      { severity = 'high';     hoursStr = '~8'; }
            else if (isNDUrlaub)                    { severity = 'high';     hoursStr = '~8'; }
            else if (isSDHigh || isSDFort)          { severity = 'high';     hoursStr = '7â€“10'; }
            else if (isBorder)                      { severity = 'border';   hoursStr = '~11'; }

            if (severity) {
              const prevLbl = findLabel(prevType);
              const currLbl = findLabel(cell.type);
              const icon  = severity === 'critical' ? 'âš¡' : 'âš ';
              const badge = severity === 'critical' ? `${icon}${hoursStr}h!` : `${icon}${hoursStr}h`;
              const tip   = `${icon} Ruhezeitverletzung (ArbZG Â§5):
${prevLbl} â†’ ${currLbl}
Ruhezeit: nur ~${hoursStr}h statt mind. 11h`;
              restBadge = `<div class="rest-violation-badge ${severity}" title="${tip}">${badge}</div>`;
            }
          }

          inner = `${noteEditBtn}<div class="shift-badge" style="background:${st.bg};color:${st.color}"
            onclick="handleCellClick(event,'${emp.id}','${ds}')"
            oncontextmenu="handleContextMenu(event,'${emp.id}','${ds}')"
            title="${escapeHTML(st.name)}${cell.note ? '\nâœŽ '+escapeHTML(cell.note) : ''}${cell.swap ? '\nðŸ”„ Tauschen' : ''}${restBadge ? '\nâš¡ Ruhezeitverletzung NDâ†’FD <11h!' : ''}"
            >${st.label}${noteDot}${swapDot}</div>${restBadge}`;
          if (hasNote) {
            inner += `<div class="shift-note-tag" title="${escapeHTML(cell.note)}">
              <span class="shift-note-tag-text">${escapeHTML(cell.note)}</span>
            </div>`;
          }
        }
      } else {
        // Kein Dienst â€“ Notiz-Only-Chip falls Notiz vorhanden
        inner = noteEditBtn;
        if (hasNote) {
          inner += `<div class="note-only-chip"
            onclick="event.stopPropagation();openNotePopup('${emp.id}','${ds}')"
            oncontextmenu="event.stopPropagation();handleContextMenu(event,'${emp.id}','${ds}')"
            title="âœŽ ${escapeHTML(cell.note)}">
            <span class="note-only-icon">âœŽ</span>
            <span class="note-only-text">${escapeHTML(cell.note)}</span>
          </div>`;
        }
      }

      // Wish/Block overlay (new format: {type:'wish'|'block', shift?:'FD'})
      const rawWish = wishes[emp.id]?.[ds];
      // Support both old string format and new object format
      const empWish = rawWish
        ? (typeof rawWish === 'string' ? { type: rawWish, shift: '' } : rawWish)
        : null;
      let wishOverlay = '';
      if (empWish) {
        if (empWish.type === 'block') {
          wishOverlay = `<div class="wish-overlay block" title="âœ— Sperrtag">âœ—</div>`;
        } else {
          const shiftLabel = empWish.shift || '';
          const shiftSt    = shiftTypes.find(s => s.id === shiftLabel);
          const shiftStyle = shiftSt ? `background:${shiftSt.color};color:${shiftSt.textColor||'#fff'};` : '';
          const title      = shiftLabel ? `âœ“ Wunsch: ${shiftLabel}` : 'âœ“ Wunschdienst';
          wishOverlay = shiftLabel
            ? `<div class="wish-overlay wish wish-shift" style="${shiftStyle}" title="${title}">âœ“${shiftLabel}</div>`
            : `<div class="wish-overlay wish" title="${title}">âœ“</div>`;
        }
      }
      // Conflict: shift assigned on a blocked day
      const wishConflict = empWish?.type === 'block' && hasShift ? ' wish-conflict' : '';

      tbHTML += `<td class="${cls}${hasNote?' has-note':''}${(!hasShift&&hasNote)?' note-only-cell':''}${wishConflict}"
        data-ds="${ds}"
        onclick="wishMode ? handleWishClick(event,'${emp.id}','${ds}') : handleCellSingleClick(event,'${emp.id}','${ds}')"
        ondblclick="wishMode ? null : handleCellDblClick(event,'${emp.id}','${ds}')"
        oncontextmenu="wishMode ? handleWishClick(event,'${emp.id}','${ds}') : handleContextMenu(event,'${emp.id}','${ds}')"
        onmousedown="if(!wishMode && !panModeActive) handleCellMouseDown(event,'${emp.id}','${ds}')"
        onmouseenter="handleCellMouseEnter(event,'${emp.id}','${ds}')"
        >${inner}${wishOverlay}</td>`;
    });

    tbHTML += '</tr>';
  });
  tbody.innerHTML = tbHTML;
  // Re-apply focus highlight after DOM rebuild
  if (focusEmpId) applyFocusMode();
  // Re-apply keyboard nav highlight
  if (navCell) {
    const td = document.querySelector(`tr[data-empid="${navCell.empId}"] td[data-ds="${navCell.ds}"]`);
    if (td) td.classList.add('kbnav-focus');
  }
  // Re-apply employee filter
  if (empFilter) applyEmpFilter(empFilter);

  // --- TFOOT ---
  const footShifts = shiftTypes.filter(st => settings.footerShifts[st.id] !== false);
  let tfHTML = '';
  footShifts.forEach(st => {
    const visStatCols2 = statCols.filter(c => settings.cols[c.key]);
    const fColspan = 1 + visStatCols2.length;
    tfHTML += `<tr class="footer-row">`;
    tfHTML += `<td colspan="${fColspan}"><div class="footer-label">
      <span style="display:inline-block;width:22px;height:18px;border-radius:4px;background:${st.bg};color:${st.color};font-size:9px;font-weight:700;text-align:center;line-height:18px;font-family:'Space Mono',monospace">${st.label}</span>
      ${st.name}
    </div></td>`;

    days.forEach(d => {
      const ds = dateStr(currentYear, currentMonth, d);
      let count = 0;
      employees.forEach(emp => {
        if (shifts[emp.id] && shifts[emp.id][ds] && shifts[emp.id][ds].type === st.id) count++;
      });
      tfHTML += `<td class="footer-count${count===0?' zero':''}">${count}</td>`;
    });
    tfHTML += '</tr>';
  });
  tfoot.innerHTML = tfHTML;
}

// =============================================================================
// CELL INTERACTION
// =============================================================================
// =============================================================================
// MULTI-CELL SELECTION
// =============================================================================
function getSelKey(empId, ds) { return empId + '|' + ds; }
function parseSelKey(key) { const [e, d] = key.split('|'); return {empId: e, ds: d}; }

function toggleCellSel(empId, ds) {
  const key = getSelKey(empId, ds);
  if (selectedCells.has(key)) selectedCells.delete(key);
  else selectedCells.add(key);
  updateMultiSelUI();
}

function updateMultiSelUI() {
  // Update cell highlights
  document.querySelectorAll('.multi-sel').forEach(el => el.classList.remove('multi-sel'));
  selectedCells.forEach(key => {
    const {empId, ds} = parseSelKey(key);
    const td = document.querySelector(`tr[data-empid="${empId}"] td[data-ds="${ds}"]`);
    if (td) td.classList.add('multi-sel');
  });
  // Show/hide floating bar
  const bar  = document.getElementById('multi-sel-bar');
  const cnt  = document.getElementById('multi-sel-count');
  const n    = selectedCells.size;
  if (n > 0) {
    bar.style.display = 'flex';
    cnt.textContent   = n + ' Zelle' + (n !== 1 ? 'n' : '');
  } else {
    bar.style.display = 'none';
  }
}

function clearMultiSel() {
  selectedCells.clear();
  updateMultiSelUI();
}

function applyShiftToSelection() {
  if (!selectedCells.size || editLocked) return;
  pushHistory();
  selectedCells.forEach(key => {
    const {empId, ds} = parseSelKey(key);
    if (!shifts[empId]) shifts[empId] = {};
    const cur = shifts[empId][ds];
    shifts[empId][ds] = { type: selectedShift, note: cur?.note || '', swap: cur?.swap || false };
  });
  clearMultiSel();
  renderTable(); saveLocal();
  const st = shiftTypes.find(s => s.id === selectedShift);
  showToast(`âœ“ ${selectedCells.size || '?'} Zellen â†’ ${st?.label || selectedShift}`);
}

function clearShiftSelection() {
  if (!selectedCells.size || editLocked) return;
  pushHistory();
  selectedCells.forEach(key => {
    const {empId, ds} = parseSelKey(key);
    if (shifts[empId]?.[ds]) {
      if (shifts[empId][ds].note?.trim()) shifts[empId][ds].type = '';
      else delete shifts[empId][ds];
    }
  });
  clearMultiSel();
  renderTable(); saveLocal();
}

function deleteSelection() {
  if (!selectedCells.size || editLocked) return;
  pushHistory();
  selectedCells.forEach(key => {
    const {empId, ds} = parseSelKey(key);
    if (shifts[empId]) delete shifts[empId][ds];
  });
  clearMultiSel();
  renderTable(); saveLocal();
}

// =============================================================================
// CELL CLICK HANDLING (single / double / triple / shift+click)
// =============================================================================
let _clickTimer   = null;
let _clickCount   = 0;

function handleCellMouseDown(e, empId, ds) {
  if (panModeActive) return;
  // Shift+click = add to multi-selection
  if (e.shiftKey && selectedCells.size > 0) {
    e.preventDefault();
    toggleCellSel(empId, ds);
    return;
  }
  // Start drag selection with Ctrl
  if (e.ctrlKey || e.metaKey) {
    e.preventDefault();
    isSelecting = true;
    selAnchor   = {empId, ds};
    if (!selectedCells.has(getSelKey(empId, ds))) selectedCells.add(getSelKey(empId, ds));
    updateMultiSelUI();
    return;
  }
  // Normal navigation focus
  navCell = null;
  requestAnimationFrame(() => setNavCell(empId, ds));
}

function handleCellMouseEnter(e, empId, ds) {
  if (!isSelecting) return;
  selectedCells.add(getSelKey(empId, ds));
  updateMultiSelUI();
}

function handleCellSingleClick(e, empId, ds) {
  e.stopPropagation();
  if (editLocked) return;
  if (e.target.closest('.note-only-chip,.note-edit-btn,.rest-violation-badge')) return;
  // Shift+click handled in mousedown
  if (e.shiftKey) return;
  // Ctrl+click handled in mousedown
  if (e.ctrlKey || e.metaKey) return;

  // Triple-click detection via click count
  _clickCount++;
  clearTimeout(_clickTimer);
  _clickTimer = setTimeout(() => {
    if (_clickCount >= 3) {
      // Triple click â†’ note
      _clickCount = 0;
      openNotePopup(empId, ds);
    } else if (_clickCount === 1) {
      // Single click â€“ if multi-sel active, add to selection; else set focus only
      _clickCount = 0;
      if (selectedCells.size > 0) {
        toggleCellSel(empId, ds);
      }
      // Focus is already set by mousedown
    } else {
      _clickCount = 0;
    }
  }, 220);
}

function handleCellDblClick(e, empId, ds) {
  e.stopPropagation();
  if (editLocked) return;
  if (e.target.closest('.note-only-chip,.note-edit-btn,.rest-violation-badge')) return;
  _clickCount = 0;
  clearTimeout(_clickTimer);
  // Double click = assign current shift
  pushHistory();
  if (!shifts[empId]) shifts[empId] = {};
  const cur = shifts[empId][ds];
  if (cur && cur.type === selectedShift) {
    if (cur.note?.trim()) shifts[empId][ds].type = '';
    else delete shifts[empId][ds];
  } else {
    shifts[empId][ds] = { type: selectedShift, note: cur?.note || '', swap: cur?.swap || false };
  }
  renderTable(); saveLocal();
}

// Legacy single-click still used in some contexts
function handleCellClick(e, empId, ds) {
  handleCellSingleClick(e, empId, ds);
}

// =============================================================================
// ROW CLEAR (erase one employee's entire month)
// =============================================================================
function clearEmployeeMonth(empId) {
  const emp = employees.find(em => em.id === empId);
  if (!confirm(`Alle Dienste von ${emp?.name || 'Mitarbeiter'} in ${MONTHS_DE[currentMonth]} ${currentYear} lÃ¶schen?`)) return;
  pushHistory();
  if (shifts[empId]) {
    const total = daysInMonth(currentYear, currentMonth);
    for (let d = 1; d <= total; d++) {
      delete shifts[empId][dateStr(currentYear, currentMonth, d)];
    }
  }
  renderTable(); saveLocal();
  showToast(`ðŸ—‘ ${emp?.name || 'MA'}: Monat geleert`);
}

// =============================================================================
// KEYBOARD INPUT BUFFER (type shift codes like fd, nd, sd, k, u, ltâ€¦)
// =============================================================================
const SHIFT_SHORTCUTS = {
  'fd': 'FD', 'frÃ¼h': 'FD', 'frÃ¼hdienst': 'FD',
  'sd': 'SD', 'spÃ¤t': 'SD', 'spÃ¤tdienst': 'SD',
  'nd': 'ND', 'nacht': 'ND', 'nachtdienst': 'ND',
  'zd': 'ZD', 'zwischen': 'ZD',
  'st': 'ST', 'spÃ¤tteam': 'ST',
  'lt': 'LT', 'leitungstag': 'LT', 'leitung': 'LT',
  'fb': null, // dynamic: first matching FT/FB/FO shift
  'fort': null,
  'k': 'K', 'krank': 'K',
  'u': 'U', 'urlaub': 'U',
  'x': 'X', 'frei': 'X',
};

function resolveShortcut(buf) {
  const low = buf.toLowerCase().trim();
  // Check user-defined shortcuts first (override built-ins)
  if (customShortcuts[low]) {
    const st = shiftTypes.find(s => s.id === customShortcuts[low]);
    return st ? st.id : null;
  }
  // Direct static match
  if (SHIFT_SHORTCUTS[low] !== undefined) {
    const id = SHIFT_SHORTCUTS[low];
    if (id) {
      const st = shiftTypes.find(s => s.id === id);
      return st ? st.id : null;
    }
    // Dynamic: fortbildung â€“ find first matching shift
    if (low === 'fb' || low === 'fort') {
      const st = shiftTypes.find(s => /^(FT|FB|FO|FBT|FORT)/i.test(s.id));
      return st ? st.id : null;
    }
  }
  // Try exact shift ID match (case-insensitive)
  const byId = shiftTypes.find(s => s.id.toLowerCase() === low);
  if (byId) return byId.id;
  // Try label match
  const byLabel = shiftTypes.find(s => s.label.toLowerCase() === low);
  if (byLabel) return byLabel.id;
  return null;
}

function feedKbBuffer(char) {
  _kbBuffer += char;
  clearTimeout(_kbTimer);
  // Show buffer toast
  const toast = document.getElementById('kb-buffer-toast');
  toast.textContent = _kbBuffer.toUpperCase();
  toast.classList.add('visible');

  const resolved = resolveShortcut(_kbBuffer);
  if (resolved) {
    // Select that shift type
    const prev = document.querySelector('.sidebar-shift-btn.selected');
    if (prev) prev.classList.remove('selected');
    selectedShift = resolved;
    const btn = document.querySelector(`.sidebar-shift-btn[data-id="${resolved}"]`);
    if (btn) btn.classList.add('selected');
    // Apply to navCell or selectedCells
    if (selectedCells.size > 0) {
      applyShiftToSelection();
    } else if (navCell && !editLocked) {
      pushHistory();
      if (!shifts[navCell.empId]) shifts[navCell.empId] = {};
      const cur = shifts[navCell.empId][navCell.ds];
      shifts[navCell.empId][navCell.ds] = { type: selectedShift, note: cur?.note||'', swap: cur?.swap||false };
      renderTable(); saveLocal();
      // Auto-advance to next cell
      moveNavCell('ArrowRight');
    }
    showToast(`âŒ¨ ${shiftTypes.find(s=>s.id===resolved)?.label || resolved} â€“ ${shiftTypes.find(s=>s.id===resolved)?.name || ''}`);
    _kbBuffer = '';
    toast.classList.remove('visible');
    return;
  }

  // Auto-clear after 1.5s if no match
  _kbTimer = setTimeout(() => {
    _kbBuffer = '';
    toast.classList.remove('visible');
  }, 1500);
}

// mouseup ends drag-selection globally
document.addEventListener('mouseup', () => { isSelecting = false; });



function handleContextMenu(e, empId, ds) {
  e.preventDefault();
  e.stopPropagation();
  contextTarget = { empId, ds };
  updateContextMenuForTarget(empId, ds);
  const menu = document.getElementById('context-menu');
  menu.style.left = e.clientX + 'px';
  menu.style.top  = e.clientY + 'px';
  menu.classList.add('visible');
  document.getElementById('emp-context-menu').classList.remove('visible');
}

// =============================================================================
// EMPLOYEE CONTEXT MENU (Rechtsklick auf Mitarbeiternamen)
// =============================================================================
let empContextTarget = null;

function handleEmpContextMenu(e, empId) {
  e.preventDefault();
  e.stopPropagation();
  empContextTarget = empId;
  const emp = employees.find(em => em.id === empId);
  document.getElementById('emp-ctx-label').textContent = emp ? emp.name : 'Mitarbeiter';
  const fillLabel = document.getElementById('emp-ctx-fill');
  const st = shiftTypes.find(s => s.id === selectedShift);
  const stLabel = st ? `"${st.label}" â€“ ${st.name}` : selectedShift;
  fillLabel.innerHTML = `ðŸ–Šï¸ Werktage fÃ¼llen mit <strong style="color:var(--accent)">${stLabel}</strong>`;
  const _fillAll = document.getElementById('emp-ctx-fill-all'); if(_fillAll) _fillAll.innerHTML =
    `ðŸ“‹ Alle Tage fÃ¼llen mit <strong style="color:var(--accent)">${stLabel}</strong>`;
  const menu = document.getElementById('emp-context-menu');
  menu.style.left = e.clientX + 'px';
  menu.style.top  = e.clientY + 'px';
  menu.classList.add('visible');
  document.getElementById('context-menu').classList.remove('visible');
}

document.getElementById('emp-ctx-fill').onclick = () => {
  if (!empContextTarget || editLocked) return;
  fillEmployeeMonth(empContextTarget, false);
  document.getElementById('emp-context-menu').classList.remove('visible');
};
document.getElementById('emp-ctx-fill-all').onclick = () => {
  if (!empContextTarget || editLocked) return;
  fillEmployeeMonth(empContextTarget, true);
  document.getElementById('emp-context-menu').classList.remove('visible');
};
document.getElementById('emp-ctx-clear-month').onclick = () => {
  if (!empContextTarget || editLocked) return;
  if (!confirm(`Gesamten Monat fÃ¼r ${employees.find(e=>e.id===empContextTarget)?.name || ''} lÃ¶schen?`)) return;
  pushHistory();
  const total = daysInMonth(currentYear, currentMonth);
  if (!shifts[empContextTarget]) shifts[empContextTarget] = {};
  for (let d = 1; d <= total; d++) {
    const ds = dateStr(currentYear, currentMonth, d);
    delete shifts[empContextTarget][ds];
  }
  document.getElementById('emp-context-menu').classList.remove('visible');
  renderTable(); saveLocal();
  showToast('ðŸ—‘ï¸ Monat geleert');
};

function fillEmployeeMonth(empId, includeWeekends) {
  pushHistory();
  const holidays = getNRWHolidays(currentYear);
  const total = daysInMonth(currentYear, currentMonth);
  if (!shifts[empId]) shifts[empId] = {};
  let filled = 0;
  for (let d = 1; d <= total; d++) {
    const ds = dateStr(currentYear, currentMonth, d);
    const existing = shifts[empId][ds];
    if (existing && existing.type) continue;
    if (!includeWeekends) {
      const dow = new Date(currentYear, currentMonth, d).getDay();
      if (dow === 0 || dow === 6) continue;
      if (holidays[ds]) continue;
    }
    shifts[empId][ds] = { type: selectedShift, note: existing?.note || '', swap: false };
    filled++;
  }
  renderTable(); saveLocal();
  const st = shiftTypes.find(s => s.id === selectedShift);
  showToast(`âœ“ ${filled} Tage mit ${st?.label || selectedShift} gefÃ¼llt`);
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('#emp-context-menu')) {
    document.getElementById('emp-context-menu').classList.remove('visible');
  }
});

document.getElementById('ctx-clear').onclick = () => {
  if (contextTarget && !editLocked) {
    pushHistory();
    const {empId, ds} = contextTarget;
    if (shifts[empId]) delete shifts[empId][ds];
    renderTable();
    saveLocal();
  }
  document.getElementById('context-menu').classList.remove('visible');
};

document.getElementById('ctx-note').onclick = () => {
  if (contextTarget) openNotePopup(contextTarget.empId, contextTarget.ds);
  document.getElementById('context-menu').classList.remove('visible');
};

document.getElementById('ctx-swap').onclick = () => {
  if (contextTarget && !editLocked) {
    const {empId, ds} = contextTarget;
    if (!shifts[empId]) shifts[empId] = {};
    if (!shifts[empId][ds]) shifts[empId][ds] = { type: '', note: '', swap: false };
    shifts[empId][ds].swap = !shifts[empId][ds].swap;
    const isNow = shifts[empId][ds].swap;
    renderTable();
    saveLocal();
    showToast(isNow ? 'ðŸ”„ Als Tauschtag markiert' : 'âœ“ Tauschmarkierung entfernt');
  }
  document.getElementById('context-menu').classList.remove('visible');
};

// Update swap menu label based on current state
function updateContextMenuForTarget(empId, ds) {
  const swapItem = document.getElementById('ctx-swap');
  const isSwap = shifts[empId]?.[ds]?.swap;
  swapItem.textContent = isSwap ? 'âœ“ Tausch aufheben' : 'ðŸ”„ Zum Tauschen ausschreiben';
}

document.addEventListener('click', () => {
  document.getElementById('context-menu').classList.remove('visible');
});

// =============================================================================
// NOTE POPUP
// =============================================================================
let noteTarget = null;

function openNotePopup(empId, ds) {
  if (editLocked) return;
  noteTarget = {empId, ds};
  const popup   = document.getElementById('note-popup');
  const ta      = document.getElementById('note-textarea');
  const badge   = document.getElementById('note-popup-badge');
  const nameEl  = document.getElementById('note-popup-name');
  const dateEl  = document.getElementById('note-popup-date');

  const existing = shifts[empId]?.[ds];
  ta.value = existing?.note || '';

  // Populate header
  const emp = employees.find(e => e.id === empId);
  nameEl.textContent = emp ? emp.name : '';
  const [y, m, d] = ds.split('-').map(Number);
  const dow = new Date(y, m-1, d).getDay();
  dateEl.textContent = `${DAYS_DE[dow]}, ${d}.${m}.${y}`;

  if (existing?.type) {
    const st = shiftTypes.find(s => s.id === existing.type);
    if (st) {
      badge.textContent = st.label;
      badge.style.background = st.bg;
      badge.style.color = st.color;
      badge.style.display = '';
    } else { badge.style.display = 'none'; }
  } else {
    badge.style.display = 'none';
  }

  // Position smart: near center, but check viewport edges
  popup.style.left = '50%';
  popup.style.top = '50%';
  popup.style.transform = 'translate(-50%,-50%) scale(0.95)';
  popup.classList.add('visible');
  popup.style.transform = 'translate(-50%,-50%) scale(1)';
  ta.focus();
  ta.select();
}

document.getElementById('note-save').onclick = () => {
  if (noteTarget) {
    pushHistory();
    const {empId, ds} = noteTarget;
    const note = document.getElementById('note-textarea').value.trim();
    if (!shifts[empId]) shifts[empId] = {};
    if (!shifts[empId][ds]) shifts[empId][ds] = { type: '', note: '' };
    shifts[empId][ds].note = note;
    renderTable();
    saveLocal();
    showToast('âœŽ Notiz gespeichert');
  }
  document.getElementById('note-popup').classList.remove('visible');
};

document.getElementById('note-delete').onclick = () => {
  if (noteTarget) {
    pushHistory();
    const {empId, ds} = noteTarget;
    if (shifts[empId]?.[ds]) {
      shifts[empId][ds].note = '';
      renderTable();
      saveLocal();
    }
  }
  document.getElementById('note-popup').classList.remove('visible');
};

document.getElementById('note-cancel').onclick = () => {
  document.getElementById('note-popup').classList.remove('visible');
};

// =============================================================================
// ZOOM
// =============================================================================
function setZoom(val) {
  currentZoom = Math.min(1.5, Math.max(0.5, val));
  const s = document.getElementById('zoom-slider');
  const l = document.getElementById('zoom-label');
  if (s) s.value = currentZoom;
  if (l) l.textContent = Math.round(currentZoom*100) + '%';
  // Sync drawer zoom controls
  const sd = document.getElementById('zoom-slider-drawer');
  const ld = document.getElementById('zoom-label-drawer');
  if (sd) sd.value = currentZoom;
  if (ld) ld.textContent = Math.round(currentZoom*100) + '%';
  applyZoom();
}

function applyZoom() {
  const t = document.getElementById('plan-table');
  // Use CSS `zoom` instead of transform:scale â€” zoom does NOT break position:sticky
  t.style.zoom = currentZoom;
  // Update CSS var used for warn-dot and other calc() expressions
  document.documentElement.style.setProperty('--table-zoom', currentZoom);
  // No need to adjust wrapper width â€” zoom shrinks/expands layout naturally
}

function adjustZoom(delta) {
  setZoom(currentZoom + delta);
}

// =============================================================================
// VIEW & NAVIGATION
// =============================================================================
function setView(v) {
  currentView = v;
  document.getElementById('btn-month').classList.toggle('active', v === 'month');
  document.getElementById('btn-week').classList.toggle('active', v === 'week');
  document.getElementById('week-controls').classList.toggle('visible', v === 'week');
  currentWeek = 1;
  render();
}

function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  if (currentMonth < 0)  { currentMonth = 11; currentYear--; }
  currentWeek = 1;
  render();
}

function changeWeek(delta) {
  const maxW = getWeeksInMonth();
  currentWeek = Math.max(1, Math.min(maxW, currentWeek + delta));
  render();
}

// =============================================================================
// YEAR VIEW
// =============================================================================
let yearViewYear = new Date().getFullYear();

function openYearView() {
  yearViewYear = currentYear;
  renderYearView();
  document.getElementById('year-overlay').classList.add('visible');
}

function closeYearView() {
  document.getElementById('year-overlay').classList.remove('visible');
}

function changeYearView(delta) {
  yearViewYear += delta;
  renderYearView();
}

function renderYearView() {
  document.getElementById('year-heading').textContent = yearViewYear;
  const hols = getNRWHolidays(yearViewYear);
  const grid = document.getElementById('year-months-grid');
  grid.innerHTML = '';

  for (let m = 0; m < 12; m++) {
    const card = document.createElement('div');
    card.className = 'year-month-card' +
      (m === currentMonth && yearViewYear === currentYear ? ' current-month' : '');
    card.title = `${MONTHS_DE[m]} ${yearViewYear} Ã¶ffnen`;

    const wd = getWorkdays(yearViewYear, m);
    const total = daysInMonth(yearViewYear, m);

    // Count total shifts this month across all employees
    let totalShifts = 0;
    employees.forEach(emp => {
      for (let d = 1; d <= total; d++) {
        const ds = dateStr(yearViewYear, m, d);
        if (shifts[emp.id]?.[ds]?.type) totalShifts++;
      }
    });

    // Build mini calendar
    const firstDow = new Date(yearViewYear, m, 1).getDay(); // 0=Sun
    const startOffset = (firstDow === 0) ? 6 : firstDow - 1; // Mon-start
    let miniHTML = '<div class="mini-cal">';
    // Day name headers
    ['Mo','Di','Mi','Do','Fr','Sa','So'].forEach(d => {
      miniHTML += `<div class="mini-cal-day" style="color:var(--text3);font-weight:700">${d}</div>`;
    });
    // Empty cells
    for (let i = 0; i < startOffset; i++) {
      miniHTML += '<div class="mini-cal-day empty"></div>';
    }
    // Days
    for (let d = 1; d <= total; d++) {
      const ds = dateStr(yearViewYear, m, d);
      const dow = new Date(yearViewYear, m, d).getDay();
      const isWknd = (dow === 0 || dow === 6);
      const isHol  = !!hols[ds];
      const hasShift = employees.some(emp => shifts[emp.id]?.[ds]?.type);
      let cls = 'mini-cal-day';
      if (hasShift) cls += ' has-shifts';
      else if (isHol) cls += ' holiday';
      else if (isWknd) cls += ' weekend';
      miniHTML += `<div class="${cls}">${d}</div>`;
    }
    miniHTML += '</div>';

    card.innerHTML = `
      <div class="year-month-name">${MONTHS_DE[m].substring(0,3).toUpperCase()}</div>
      <div class="year-month-days">${wd} Arbeitstage${totalShifts > 0 ? ' Â· ' + totalShifts + ' Dienste' : ''}</div>
      ${miniHTML}
    `;

    card.addEventListener('click', () => {
      currentYear  = yearViewYear;
      currentMonth = m;
      currentWeek  = 1;
      setView('month');
      closeYearView();
    });

    grid.appendChild(card);
  }
}

// =============================================================================
// NEUE FUNKTION 1: MONATSSTATISTIK
// Warum: Die Leitung braucht auf Knopfdruck eine Ãœbersicht â€“ wer ist Ã¼ber/unter Soll,
// wie viele Krankentage, Urlaubstage und Tausch-Markierungen gibt es diesen Monat.
// Das ist der tÃ¤gl. Blick, den man sonst manuell zusammenrechnet.
// =============================================================================
let _statsTab = 'overview';
function switchStatsTab(tab) {
  _statsTab = tab;
  ['overview','check'].forEach(t => {
    const btn = document.getElementById('stats-tab-' + t);
    if (btn) {
      btn.style.background = t === tab ? 'var(--helios-red)' : 'var(--glass2)';
      btn.style.color = t === tab ? 'white' : 'var(--text2)';
    }
  });
  renderStatsContent();
}

function openStatsModal() {
  document.getElementById('stats-month-label').textContent =
    `${MONTHS_DE[currentMonth]} ${currentYear}`;
  _statsTab = 'overview';
  switchStatsTab('overview');
  openModal('modal-stats');
}

function renderStatsContent() {
  const cont = document.getElementById('stats-content');
  if (!cont) return;

  // Dispatch to correct tab
  if (_statsTab === 'check') {
    cont.innerHTML = runMonthCheck();
    return;
  }

  const workdays  = getWorkdays(currentYear, currentMonth);
  const total     = daysInMonth(currentYear, currentMonth);

  // Global summary
  let totalIst = 0, totalSoll = 0, sickDays = 0, vacDays = 0, swapCount = 0;
  employees.forEach(emp => {
    const soll = calcSoll(emp.vz, workdays, settings.hourFactor);
    const ist  = calcIst(emp.id, currentYear, currentMonth);
    totalIst  += ist;
    totalSoll += soll;
    for (let d = 1; d <= total; d++) {
      const ds = dateStr(currentYear, currentMonth, d);
      const c  = shifts[emp.id]?.[ds];
      if (!c) continue;
      if (c.type === 'K') sickDays++;
      if (c.type === 'U') vacDays++;
      if (c.swap) swapCount++;
    }
  });

  const maxIst = Math.max(...employees.map(emp => calcIst(emp.id, currentYear, currentMonth)), 1);

  let html = `
  <div class="stats-summary">
    <div class="stats-card">
      <div class="stats-card-val">${Math.round(totalIst)}h</div>
      <div class="stats-card-lbl">Gesamt Ist</div>
    </div>
    <div class="stats-card">
      <div class="stats-card-val">${Math.round(totalSoll)}h</div>
      <div class="stats-card-lbl">Gesamt Soll</div>
    </div>
    <div class="stats-card">
      <div class="stats-card-val" style="color:#f87171">${sickDays}</div>
      <div class="stats-card-lbl">Krank-Tage</div>
    </div>
    <div class="stats-card">
      <div class="stats-card-val" style="color:#34d399">${vacDays}</div>
      <div class="stats-card-lbl">Urlaubstage</div>
    </div>
  </div>
  ${swapCount > 0 ? `<div style="margin-bottom:14px;padding:8px 12px;background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);border-radius:8px;font-size:12px;color:#06b6d4;">ðŸ”„ ${swapCount} Tausch-Markierung${swapCount!==1?'en':''} diesen Monat</div>` : ''}
  <table class="stats-table">
    <thead>
      <tr>
        <th>Mitarbeiter</th>
        <th>VZ</th>
        <th>Soll</th>
        <th>Ist</th>
        <th style="min-width:90px">Auslastung</th>
        <th>Diff</th>
        <th>K</th>
        <th>U</th>
      </tr>
    </thead>
    <tbody>`;

  employees.forEach(emp => {
    const soll  = calcSoll(emp.vz, workdays, settings.hourFactor);
    const ist   = calcIst(emp.id, currentYear, currentMonth);
    const diff  = Math.round((ist - soll + (emp.vmt||0)) * 10) / 10;
    const diffSign  = diff >= 0 ? '+' : '';
    const diffColor = diff >= 0 ? '#34d399' : '#f87171';
    const pct  = soll > 0 ? Math.min(100, Math.round(ist / soll * 100)) : 0;
    const barColor = pct >= 95 ? '#34d399' : pct >= 70 ? 'var(--accent)' : '#f87171';

    let sick = 0, vac = 0;
    for (let d = 1; d <= total; d++) {
      const ds = dateStr(currentYear, currentMonth, d);
      const c  = shifts[emp.id]?.[ds];
      if (!c) continue;
      if (c.type === 'K') sick++;
      if (c.type === 'U') vac++;
    }

    html += `<tr>
      <td>
        <div style="font-weight:600;font-size:11.5px">${escapeHTML(emp.name)}</div>
        <div style="font-size:9.5px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px">${escapeHTML(emp.role)}</div>
      </td>
      <td style="color:var(--accent);font-family:'Space Mono',monospace">${emp.vz}%</td>
      <td style="font-family:'Space Mono',monospace">${soll}h</td>
      <td style="font-family:'Space Mono',monospace">${ist}h</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px">
          <div class="stats-bar-wrap">
            <div class="stats-bar" style="width:${pct}%;background:${barColor}"></div>
          </div>
          <span style="font-size:10px;font-family:'Space Mono',monospace;color:var(--text3)">${pct}%</span>
        </div>
      </td>
      <td style="color:${diffColor};font-weight:700;font-family:'Space Mono',monospace">${diffSign}${diff}h</td>
      <td style="color:#f87171;font-weight:600">${sick||'â€“'}</td>
      <td style="color:#34d399;font-weight:600">${vac||'â€“'}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  cont.innerHTML = html;
}

// =============================================================================
// LOCK
// =============================================================================
function toggleLock() {
  editLocked = !editLocked;
  const btn = document.getElementById('lock-btn');
  if(btn) { btn.innerHTML = editLocked ? '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2.5"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>' : '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2.5"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>'; btn.classList.toggle('locked', editLocked); }
  showToast(editLocked ? 'ðŸ”’ Bearbeitung gesperrt' : 'ðŸ”“ Bearbeitung aktiv');
}

// =============================================================================
// THEME
// =============================================================================
function toggleTheme() {
  darkMode = !darkMode;
  document.body.dataset.theme = darkMode ? 'dark' : 'light';
  const _tb = document.getElementById('theme-btn'); if(_tb) _tb.innerHTML = darkMode ? '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>' : '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
  saveLocal();
}

// =============================================================================
// EMPLOYEE MANAGEMENT
// =============================================================================
function openModal(id) {
  if (id === 'modal-employees') renderEmpList();
  if (id === 'modal-shifts')    { renderShiftConfig(); renderShortcutsPanel(); }
  if (id === 'modal-settings')  renderSettings();
  if (id === 'modal-stats')     renderStatsContent();
  if (id === 'modal-ai')        renderAIWeOverview();
  document.getElementById(id).classList.add('visible');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('visible');
}

function autoAssignWeGroups() {
  if (!confirm(`Alle ${employees.length} Mitarbeiter gleichmÃ¤ÃŸig auf Wochenend-Gruppen A und B verteilen?\nBestehende Gruppen werden Ã¼berschrieben.`)) return;
  employees.forEach((emp, i) => { emp.weGroup = i % 2 === 0 ? 'A' : 'B'; });
  renderEmpList();
  render();
  saveLocal();
  showToast('ðŸ—“ A/B-Gruppen auto-zugeteilt');
}

function updateEmpModalWeCount() {
  const a = employees.filter(e => e.weGroup === 'A').length;
  const b = employees.filter(e => e.weGroup === 'B').length;
  const n = employees.filter(e => !e.weGroup).length;
  const elA = document.getElementById('emp-modal-we-a');
  const elB = document.getElementById('emp-modal-we-b');
  if (elA) elA.textContent = `Gruppe A: ${a} MA`;
  if (elB) elB.textContent = `Gruppe B: ${b} MA${n ? ` Â· Ohne: ${n}` : ''}`;
}

function renderEmpList() {
  const container = document.getElementById('emp-list-container');
  container.innerHTML = '';
  employees.forEach((emp) => {
    const item = document.createElement('div');
    item.className = 'emp-list-item';
    item.setAttribute('draggable', 'true');
    item.dataset.empid = emp.id;
    const weBadge = emp.weGroup ? `<span class="we-badge ${emp.weGroup}">${emp.weGroup}</span>` : '';
    const prefTag = emp.preferences ? `<span class="emp-pref-tag" title="${escapeHTML(emp.preferences)}">âœ¦ ${escapeHTML(emp.preferences.slice(0,35))}${emp.preferences.length>35?'â€¦':''}</span>` : '';
    item.innerHTML = `
      <span class="drag-handle">â ¿</span>
      <div class="emp-info">
        <div class="name" style="display:flex;align-items:center;gap:6px">${emp.name} ${weBadge}</div>
        <div class="role">${emp.role} Â· ${emp.vz}% Â· Vmt: ${emp.vmt||0}h</div>
        ${prefTag ? `<div style="margin-top:4px">${prefTag}</div>` : ''}
      </div>
      <div class="emp-actions">
        <button class="icon-btn" onclick="openEditEmployee('${emp.id}')" title="Bearbeiten"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        <button class="icon-btn danger" onclick="deleteEmployee('${emp.id}')" title="Entfernen"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>
      </div>
    `;
    item.addEventListener('dragstart', e => { e.dataTransfer.setData('emp-reorder', emp.id); });
    item.addEventListener('dragover', e => { e.preventDefault(); item.style.background = 'var(--accent-light)'; });
    item.addEventListener('dragleave', () => { item.style.background = ''; });
    item.addEventListener('drop', e => {
      e.preventDefault();
      item.style.background = '';
      const fromId = e.dataTransfer.getData('emp-reorder');
      if (fromId === emp.id) return;
      const fromIdx = employees.findIndex(x => x.id === fromId);
      const toIdx   = employees.findIndex(x => x.id === emp.id);
      const [moved] = employees.splice(fromIdx, 1);
      employees.splice(toIdx, 0, moved);
      renderEmpList();
      render();
      saveLocal();
    });
    container.appendChild(item);
  });
  updateEmpModalWeCount();
}
function selectWeGroup(grp) {
  document.getElementById('emp-we-group-val').value = grp;
  ['', 'A', 'B'].forEach(g => {
    const id = g === '' ? 'we-btn-none' : `we-btn-${g.toLowerCase()}`;
    const btn = document.getElementById(id);
    if (btn) btn.classList.toggle('active', g === grp);
  });
  const hints = {
    '': 'Keine Wochenend-Gruppe â€“ freie Planung',
    'A': 'Gruppe A: arbeitet jedes 1. Wochenende, hat jedes 2. frei',
    'B': 'Gruppe B: arbeitet jedes 2. Wochenende, hat jedes 1. frei'
  };
  const el = document.getElementById('we-group-hint');
  if (el) el.textContent = hints[grp] || '';
}

function openAddEmployee() {
  document.getElementById('emp-edit-title').textContent = 'Mitarbeiter hinzufÃ¼gen';
  document.getElementById('emp-name-input').value = '';
  document.getElementById('emp-role-input').value = 'Pflegekraft';
  document.getElementById('emp-vz-input').value = 100;
  document.getElementById('vz-display').textContent = '100%';
  document.getElementById('emp-vmt-input').value = 0;
  document.getElementById('emp-prefs-input').value = '';
  document.getElementById('emp-edit-id').value = '';
  selectWeGroup('');
  openModal('modal-edit-employee');
}

function openEditEmployee(empId) {
  closeModal('modal-employees');
  const emp = employees.find(e => e.id === empId);
  if (!emp) return;
  document.getElementById('emp-edit-title').textContent = 'Mitarbeiter bearbeiten';
  document.getElementById('emp-name-input').value = emp.name;
  document.getElementById('emp-role-input').value = emp.role;
  document.getElementById('emp-vz-input').value = emp.vz;
  document.getElementById('vz-display').textContent = emp.vz + '%';
  document.getElementById('emp-vmt-input').value = emp.vmt || 0;
  document.getElementById('emp-prefs-input').value = emp.preferences || '';
  document.getElementById('emp-edit-id').value = emp.id;
  selectWeGroup(emp.weGroup || '');
  openModal('modal-edit-employee');
}

function saveEmployee() {
  const name  = document.getElementById('emp-name-input').value.trim().toUpperCase();
  const role  = document.getElementById('emp-role-input').value;
  const vz    = parseInt(document.getElementById('emp-vz-input').value);
  const vmt   = parseFloat(document.getElementById('emp-vmt-input').value) || 0;
  const prefs = document.getElementById('emp-prefs-input').value.trim();
  const weGrp = document.getElementById('emp-we-group-val').value;
  const id    = document.getElementById('emp-edit-id').value;

  if (!name) { alert('Bitte Name eingeben.'); return; }

  if (id) {
    const emp = employees.find(e => e.id === id);
    if (emp) { emp.name = name; emp.role = role; emp.vz = vz; emp.vmt = vmt; emp.preferences = prefs; emp.weGroup = weGrp; }
  } else {
    employees.push({ id: 'e' + Date.now(), name, role, vz, vmt, preferences: prefs, weGroup: weGrp });
  }
  closeModal('modal-edit-employee');
  render();
  saveLocal();
  showToast('âœ“ Mitarbeiter gespeichert');
}

function deleteEmployee(empId) {
  if (!confirm('Mitarbeiter wirklich entfernen? Alle Dienste dieses Mitarbeiters gehen verloren.')) return;
  employees = employees.filter(e => e.id !== empId);
  delete shifts[empId];
  renderEmpList();
  render();
  saveLocal();
}

// =============================================================================
// SHIFT CONFIG
// =============================================================================
function renderShiftConfig() {
  const container = document.getElementById('shift-config-list');
  container.innerHTML = '';
  let dragSrcIdx = null;

  shiftTypes.forEach((st, idx) => {
    const item = document.createElement('div');
    item.className = 'shift-config-item';
    item.setAttribute('draggable', 'true');
    item.dataset.idx = idx;

    item.innerHTML = `
      <span class="shift-cfg-drag">â ¿</span>
      <div class="shift-preview" style="background:${st.bg};color:${st.color}">${st.label}</div>
      <div class="shift-config-inputs">
        <input class="label-inp" type="text" value="${escapeHTML(st.label)}" placeholder="KÃ¼rzel" oninput="updateShiftPreview(this)">
        <input class="name-inp" type="text" value="${escapeHTML(st.name)}" placeholder="Name">
        <input class="hours-inp" type="number" value="${st.hours}" step="0.5" placeholder="h">
        <input class="color-inp" type="color" value="${st.color}" oninput="updateShiftPreview(this)" title="Schriftfarbe">
        <input class="color-inp" type="color" value="${st.bg}" oninput="updateShiftPreview(this)" title="Hintergrundfarbe">
      </div>
      <button class="icon-btn danger" onclick="removeShiftTypeByIdx(${idx})" title="LÃ¶schen"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>
    `;

    // Drag reorder
    item.addEventListener('dragstart', e => {
      dragSrcIdx = +item.dataset.idx;
      item.classList.add('dragging-shift-cfg');
      e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', () => item.classList.remove('dragging-shift-cfg'));
    item.addEventListener('dragover', e => { e.preventDefault(); item.classList.add('drag-over-shift-cfg'); });
    item.addEventListener('dragleave', () => item.classList.remove('drag-over-shift-cfg'));
    item.addEventListener('drop', e => {
      e.preventDefault();
      item.classList.remove('drag-over-shift-cfg');
      const toIdx = +item.dataset.idx;
      if (dragSrcIdx === null || dragSrcIdx === toIdx) return;
      // Save current input values before reordering
      _syncShiftConfigFromDOM();
      const [moved] = shiftTypes.splice(dragSrcIdx, 1);
      shiftTypes.splice(toIdx, 0, moved);
      renderShiftConfig();
    });

    container.appendChild(item);
  });
}

function _syncShiftConfigFromDOM() {
  const items = document.querySelectorAll('.shift-config-item');
  items.forEach((item, idx) => {
    if (!shiftTypes[idx]) return;
    const inputs = item.querySelectorAll('input');
    shiftTypes[idx].label = inputs[0].value.trim();
    shiftTypes[idx].name  = inputs[1].value.trim();
    shiftTypes[idx].hours = parseFloat(inputs[2].value)||0;
    shiftTypes[idx].color = inputs[3].value;
    shiftTypes[idx].bg    = inputs[4].value;
  });
}

// Make removeShiftType accessible by index at render time
function removeShiftTypeByIdx(idx) {
  shiftTypes.splice(idx, 1);
  renderShiftConfig();
}

function updateShiftPreview(inp) {
  const idx = inp.dataset.idx;
  const field = inp.dataset.field;
  const item = inp.closest('.shift-config-item');
  const preview = item.querySelector('.shift-preview');
  // Update temp
  const label = item.querySelector('[data-field="label"]').value;
  const color = item.querySelector('[data-field="color"]').value;
  const bg    = item.querySelector('[data-field="bg"]').value;
  preview.textContent = label;
  preview.style.color = color;
  preview.style.background = bg;
}

function addShiftType() {
  shiftTypes.push({ id: 'S'+Date.now(), label: 'NEU', name: 'Neuer Dienst', hours: 7.7, color: '#ffffff', bg: '#666666' });
  renderShiftConfig();
}

function removeShiftType(idx) {
  shiftTypes.splice(idx, 1);
  renderShiftConfig();
}

function saveShiftConfig() {
  _syncShiftConfigFromDOM();
  _syncCustomShortcutsFromDOM();
  closeModal('modal-shifts');
  renderSidebar();
  renderTable();
  saveLocal();
  showToast('âœ“ Dienste & KÃ¼rzel gespeichert');
}

// =============================================================================
// SETTINGS
// =============================================================================
function renderSettings() {
  const ct = document.getElementById('col-toggles');
  const colLabels = {vz:'Stellenanteil (VZ)', soll:'Soll-Stunden', ist:'Ist-Stunden', diff:'Differenz (+/âˆ’)', vmt:'Vormonat'};
  ct.innerHTML = Object.keys(colLabels).map(key => `
    <div class="toggle-row">
      <span class="toggle-label">${colLabels[key]}</span>
      <label class="toggle-switch">
        <input type="checkbox" data-col="${key}" ${settings.cols[key]?'checked':''}>
        <div class="toggle-slider"></div>
      </label>
    </div>
  `).join('');

  const ft = document.getElementById('footer-toggles');
  ft.innerHTML = shiftTypes.map(st => `
    <label style="display:flex;align-items:center;gap:5px;cursor:pointer;padding:4px 8px;border-radius:5px;background:var(--surface2);border:1.5px solid var(--border)">
      <input type="checkbox" data-footer="${st.id}" ${settings.footerShifts[st.id]!==false?'checked':''}>
      <span style="display:inline-block;width:28px;height:22px;border-radius:4px;background:${st.bg};color:${st.color};font-size:9px;font-weight:700;text-align:center;line-height:22px">${st.label}</span>
    </label>
  `).join('');

  document.getElementById('hour-factor-input').value = settings.hourFactor;
}

function applySettings() {
  document.querySelectorAll('#col-toggles input[data-col]').forEach(inp => {
    settings.cols[inp.dataset.col] = inp.checked;
  });
  document.querySelectorAll('#footer-toggles input[data-footer]').forEach(inp => {
    settings.footerShifts[inp.dataset.footer] = inp.checked;
  });
  settings.hourFactor = parseFloat(document.getElementById('hour-factor-input').value) || 7.7;
  closeModal('modal-settings');
  render();
  saveLocal();
  showToast('âœ“ Einstellungen gespeichert');
}

// =============================================================================
// DRAG & DROP ROWS (in table)
// =============================================================================
let dragEmpId = null;
function dragStart(e, empId) {
  if (editLocked) { e.preventDefault(); return; }
  dragEmpId = empId;
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(() => {
    e.target.closest('tr').classList.add('dragging');
  }, 0);
}
function dragOver(e) {
  if (!dragEmpId) return;
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}
function dropRow(e, targetEmpId) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (!dragEmpId || dragEmpId === targetEmpId) return;
  const fromIdx = employees.findIndex(x => x.id === dragEmpId);
  const toIdx   = employees.findIndex(x => x.id === targetEmpId);
  const [moved] = employees.splice(fromIdx, 1);
  employees.splice(toIdx, 0, moved);
  dragEmpId = null;
  render();
  saveLocal();
}
function dragEnd(e) {
  document.querySelectorAll('.emp-row').forEach(r => {
    r.classList.remove('drag-over', 'dragging');
  });
  dragEmpId = null;
}

// =============================================================================
// PDF / PRINT
// =============================================================================
function printPDF() {
  showToast('â³ PDF wird vorbereitetâ€¦');
  setTimeout(() => { window.print(); }, 300);
}

// =============================================================================
// TOAST
// =============================================================================
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.classList.remove('show'); }, 2500);
}

// =============================================================================
// ESCAPE HTML
// =============================================================================
function escapeHTML(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}


// =============================================================================
// PERSISTENCE â€“ LOCAL STORAGE  (v2: all departments in one key)
// =============================================================================
const LS_KEY = 'dienstplan-pro-v2';

function getFullState() {
  // Always snapshot current working vars into active dept first
  saveDeptState(currentDept());
  return {
    version: 2,
    departments,
    currentDeptId,
    darkMode,
    currentZoom,
    currentYear,
    currentMonth,
    customShortcuts
  };
}

function saveLocal() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(getFullState()));
    clearUnsaved();
  } catch(e) { console.warn('saveLocal failed', e); }
}

function loadLocal() {
  try {
    // Try v2 format
    const raw = localStorage.getItem(LS_KEY);
    if (raw) {
      const d = JSON.parse(raw);
      if (d.version === 2 && d.departments && d.departments.length) {
        departments   = d.departments;
        currentDeptId = d.currentDeptId && departments.find(x => x.id === d.currentDeptId)
          ? d.currentDeptId : departments[0].id;
        loadDeptState(currentDept());
        if (d.darkMode !== undefined) {
          darkMode = d.darkMode;
          document.body.dataset.theme = darkMode ? 'dark' : 'light';
          const tb = document.getElementById('theme-btn');
          if (tb) tb.innerHTML = darkMode ? '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>' : '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
        }
        if (d.currentZoom) { currentZoom = d.currentZoom; }
        if (d.currentYear  !== undefined) currentYear  = d.currentYear;
        if (d.currentMonth !== undefined) currentMonth = d.currentMonth;
        if (d.customShortcuts) customShortcuts = d.customShortcuts;
        return true;
      }
    }
    // Fallback: try v1 per-dept format (dienstplan-departments + dienstplan-dept-*)
    const deptsRaw = localStorage.getItem('dienstplan-departments');
    if (deptsRaw) {
      const depts = JSON.parse(deptsRaw);
      if (depts && depts.length) {
        departments = depts.map(dept => {
          const dKey = 'dienstplan-dept-' + dept.id;
          const dRaw = localStorage.getItem(dKey);
          const data = dRaw ? JSON.parse(dRaw) : {};
          return Object.assign({ employees:[], shifts:{}, shiftTypes:JSON.parse(JSON.stringify(DEFAULT_SHIFT_TYPES)),
            settings:{cols:{vz:true,soll:true,ist:true,diff:true,vmt:true},footerShifts:{},hourFactor:7.7}, wishes:{} },
            { id: dept.id, name: dept.name, color: dept.color },
            { employees: data.employees || [], shifts: data.shifts || {},
              shiftTypes: data.shiftTypes || JSON.parse(JSON.stringify(DEFAULT_SHIFT_TYPES)),
              settings: data.settings || {}, wishes: data.wishes || {} });
        });
        const savedCurrent = localStorage.getItem('dienstplan-current-dept');
        currentDeptId = savedCurrent && departments.find(x => x.id === savedCurrent)
          ? savedCurrent : departments[0].id;
        loadDeptState(currentDept());
        saveLocal(); // upgrade to v2
        showToast('\u2705 Daten aus v1 migriert');
        return true;
      }
    }
    // Fallback: try original single-dept format
    const oldRaw = localStorage.getItem('dienstplan-pro-data');
    if (oldRaw) {
      const d = JSON.parse(oldRaw);
      const migrated = makeDefaultDept('dept_1', 'Station A3', DEPT_COLORS[0]);
      if (d.employees)  migrated.employees  = d.employees;
      if (d.shifts)     migrated.shifts     = d.shifts;
      if (d.shiftTypes) migrated.shiftTypes = d.shiftTypes;
      if (d.settings)   Object.assign(migrated.settings, d.settings);
      if (d.wishes)     migrated.wishes     = d.wishes;
      departments   = [migrated];
      currentDeptId = 'dept_1';
      loadDeptState(migrated);
      if (d.darkMode !== undefined) { darkMode = d.darkMode; }
      if (d.currentZoom) currentZoom = d.currentZoom;
      saveLocal();
      showToast('\u2705 Daten aus Altversion migriert');
      return true;
    }
    return false;
  } catch(e) { console.warn('loadLocal error', e); return false; }
}

// =============================================================================
// EXPORT / IMPORT (.dpz â€“ Dienstplan Zip/JSON bundle)
// =============================================================================
const DPZ_VERSION = '2.0';
const DPZ_MIME    = 'application/json';

function exportDept(deptId) {
  // Save current state first
  saveDeptState(currentDept());
  const dept = departments.find(d => d.id === deptId);
  if (!dept) return;
  const bundle = {
    version:    DPZ_VERSION,
    app:        'Dienstplan PRO',
    exportedAt: new Date().toISOString(),
    type:       'single',
    departments: [JSON.parse(JSON.stringify(dept))]
  };
  const safe = dept.name.replace(/[^a-z0-9\u00e4\u00f6\u00fc\u00df_\-]/gi, '_');
  const filename = 'DienstplanPRO_' + safe + '_' + new Date().toISOString().slice(0,10) + '.dpz';
  downloadJSON(bundle, filename);
  showToast('\u2b07 Exportiert: ' + dept.name);
}

function exportPlan(mode) {
  saveDeptState(currentDept());
  const ids = mode === 'all' ? departments.map(d => d.id) : [currentDeptId];
  const bundle = {
    version:    DPZ_VERSION,
    app:        'Dienstplan PRO',
    exportedAt: new Date().toISOString(),
    type:       mode === 'all' ? 'full-backup' : 'single',
    departments: departments.filter(d => ids.includes(d.id)).map(d => JSON.parse(JSON.stringify(d)))
  };
  const filename = mode === 'all'
    ? 'DienstplanPRO_Vollsicherung_' + new Date().toISOString().slice(0,10) + '.dpz'
    : 'DienstplanPRO_' + (currentDept().name).replace(/[^a-z0-9\u00e4\u00f6\u00fc\u00df_\-]/gi,'_') + '_' + new Date().toISOString().slice(0,10) + '.dpz';
  downloadJSON(bundle, filename);
  showToast('\u2b07 ' + bundle.departments.length + ' Abteilung(en) exportiert');
}

function downloadJSON(obj, filename) {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: DPZ_MIME });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

function handleImportDrop(e) {
  const file = e.dataTransfer?.files?.[0];
  if (file) processImportFile(file);
}
function handleImportFile(input) {
  const file = input.files?.[0];
  if (file) processImportFile(file);
  input.value = '';
}

function processImportFile(file) {
  const resultEl = document.getElementById('io-import-result');
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const bundle = JSON.parse(ev.target.result);
      // Accept both old .dienstplan format and new .dpz format
      if (!bundle.departments || !Array.isArray(bundle.departments) || !bundle.departments.length) {
        showImportResult(false, '\u274c UngÃ¼ltiges Format â€“ keine Abteilungen gefunden.');
        return;
      }
      saveDeptState(currentDept());
      let added = 0;
      bundle.departments.forEach(d => {
        const newId = 'dept_' + Date.now() + '_' + Math.random().toString(36).slice(2,5);
        // Avoid name collisions
        let finalName = d.name || 'Importiert';
        let suffix = 1;
        while (departments.find(dep => dep.name === finalName)) {
          finalName = (d.name || 'Importiert') + ' (' + (++suffix) + ')';
        }
        departments.push({
          id:         newId,
          name:       finalName,
          color:      d.color || DEPT_COLORS[departments.length % DEPT_COLORS.length],
          employees:  d.employees  || [],
          shifts:     d.shifts     || {},
          shiftTypes: d.shiftTypes || JSON.parse(JSON.stringify(DEFAULT_SHIFT_TYPES)),
          settings:   d.settings   || { cols:{vz:true,soll:true,ist:true,diff:true,vmt:true}, footerShifts:{}, hourFactor:7.7 },
          wishes:     d.wishes     || {}
        });
        added++;
      });
      saveLocal();
      renderDeptTabs();
      renderDeptList();
      showImportResult(true, '\u2705 ' + added + ' Abteilung(en) erfolgreich importiert!');
      showToast('\ud83d\udce6 ' + added + ' Abteilung(en) importiert');
    } catch(err) {
      showImportResult(false, '\u274c Fehler: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function showImportResult(ok, msg) {
  const el = document.getElementById('io-import-result');
  if (!el) return;
  el.style.display = 'block';
  el.style.color = ok ? '#34d399' : '#f87171';
  el.textContent = msg;
}

// Render dept list inside modal-depts
function renderDeptList() {
  const container = document.getElementById('dept-list-container');
  if (!container) return;
  saveDeptState(currentDept());
  let html = '<div style="display:flex;flex-direction:column;gap:8px">';
  departments.forEach(dept => {
    const isCurrent = dept.id === currentDeptId;
    const shiftCount = Object.values(dept.shifts || {}).reduce((n, v) => n + Object.keys(v).length, 0);
    const empCount   = (dept.employees || []).length;
    html += '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1px solid '
      + (isCurrent ? 'rgba(91,127,255,0.4)' : 'var(--border)') + ';background:'
      + (isCurrent ? 'rgba(91,127,255,0.07)' : 'var(--glass2)') + '">';
    html += '<input type="color" value="' + dept.color + '" title="Farbe" onchange="changeDeptColor(\'' + dept.id + '\')" style="width:28px;height:28px;border:none;background:transparent;cursor:pointer;border-radius:50%;flex-shrink:0">';
    html += '<div style="flex:1;min-width:0">';
    html += '<input type="text" value="' + escapeHTML(dept.name) + '" title="Name (Enter zum BestÃ¤tigen)"'
      + ' onblur="changeDeptName(\'' + dept.id + '\',this.value)"'
      + ' onkeydown="if(event.key===\'Enter\')this.blur()"'
      + ' style="width:100%;padding:4px 7px;border-radius:6px;border:1px solid var(--border);background:var(--glass2);color:var(--text);font-size:12px;font-weight:600;outline:none">';
    html += '<div style="font-size:10px;color:var(--text3);margin-top:3px">' + empCount + ' MA &nbsp;Â·&nbsp; ' + shiftCount + ' EintrÃ¤ge</div>';
    html += '</div>';
    if (isCurrent) {
      html += '<span style="font-size:10px;color:var(--accent);font-weight:700;padding:2px 8px;background:rgba(91,127,255,0.15);border-radius:10px;white-space:nowrap">AKTIV</span>';
    } else {
      html += '<button onclick="switchDept(\'' + dept.id + '\');closeModal(\'modal-depts\')" '
        + 'style="padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--glass2);color:var(--text2);font-size:11px;cursor:pointer;white-space:nowrap">Ã–ffnen</button>';
    }
    html += '<button onclick="exportDept(\'' + dept.id + '\')" title="Abteilung exportieren (.dpz)"'
      + ' style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--glass2);color:var(--text2);font-size:11px;cursor:pointer;flex-shrink:0">â¬‡</button>';
    html += '<button onclick="deleteDept(\'' + dept.id + '\')" title="Abteilung lÃ¶schen"'
      + ' style="padding:4px 8px;border-radius:6px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.1);color:#f87171;font-size:12px;cursor:pointer;flex-shrink:0">ðŸ—‘</button>';
    html += '</div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

function changeDeptName(id, name) {
  const dept = departments.find(d => d.id === id);
  if (!dept || !name.trim()) return;
  dept.name = name.trim();
  if (id === currentDeptId) document.getElementById('header-dept-name').textContent = dept.name;
  renderDeptTabs();
  saveLocal();
}

// addDepartment is wired to the modal-depts form
function addDepartment() {
  const nameEl  = document.getElementById('new-dept-name');
  const colorEl = document.getElementById('new-dept-color');
  const name    = (nameEl ? nameEl.value : '').trim();
  const color   = colorEl ? colorEl.value : DEPT_COLORS[departments.length % DEPT_COLORS.length];
  if (!name) { if (nameEl) nameEl.focus(); return; }
  const id      = 'dept_' + Date.now();
  const newDept = {
    id, name, color,
    employees:  [],
    shifts:     {},
    shiftTypes: JSON.parse(JSON.stringify(DEFAULT_SHIFT_TYPES)),
    settings:   { cols:{vz:true,soll:true,ist:true,diff:true,vmt:true}, footerShifts:{}, hourFactor:7.7 },
    wishes:     {}
  };
  DEFAULT_SHIFT_TYPES.forEach(st => { newDept.settings.footerShifts[st.id] = true; });
  saveDeptState(currentDept());
  departments.push(newDept);
  if (nameEl) nameEl.value = '';
  saveLocal();
  renderDeptTabs();
  renderDeptList();
  showToast('\u2705 Abteilung "' + name + '" angelegt');
}


// PERSISTENCE â€“ FIREBASE
// =============================================================================
async function saveFirebase() {
  const db = window.__firebaseDB;
  if (!db || !window.__firebaseReady) return false;
  try {
    const { doc, setDoc } = window.__firestoreAPI;
    const appId = window.__firebaseAppId || 'dienstplanprogramm';
    const key = `plan-${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
    await setDoc(doc(db, `artifacts/${appId}/public`, key), { employees, shifts, shiftTypes, settings, wishes, darkMode, currentYear, currentMonth, currentZoom });
    return true;
  } catch(e) { console.error('Firebase save error', e); return false; }
}

async function loadFirebase() {
  const db = window.__firebaseDB;
  if (!db || !window.__firebaseReady) return false;
  try {
    const { doc, getDoc } = window.__firestoreAPI;
    const appId = window.__firebaseAppId || 'dienstplanprogramm';
    const key = `plan-${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
    const snap = await getDoc(doc(db, `artifacts/${appId}/public`, key));
    if (snap.exists()) {
      const d = snap.data();
      if (d.employees)  employees  = d.employees;
      if (d.shifts)     shifts     = d.shifts;
      if (d.shiftTypes) shiftTypes = d.shiftTypes;
      if (d.settings)   settings   = { ...settings, ...d.settings };
      if (d.wishes)     wishes     = d.wishes;
      return true;
    }
  } catch(e) { console.error('Firebase load error', e); }
  return false;
}

function updateSyncBadge(online) {
  const badge = document.getElementById('sync-badge');
  const text  = document.getElementById('sync-text');
  if (online) { badge.className = 'sync-badge online'; text.textContent = 'Cloud-Sync'; }
  else        { badge.className = 'sync-badge offline'; text.textContent = 'Lokal'; }
}

async function saveAll() {
  saveLocal(); // saves all depts + clears unsaved indicator
  const saved = await saveFirebase();
  updateSyncBadge(saved);
  const msg = saved ? 'â˜ï¸ In Cloud gespeichert!' : 'ðŸ’¾ Lokal gespeichert âœ“';
  showToast(msg);
  // Update status in modal-io if it's open
  const statusEl = document.getElementById('io-save-status');
  if (statusEl) {
    statusEl.textContent = 'âœ“ Gespeichert ' + new Date().toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'});
    statusEl.style.color = '#34d399';
  }
}

// =============================================================================
// INIT
// =============================================================================
async function init() {
  // Load persisted data (sets departments, currentDeptId, and working vars)
  loadLocal();

  // Ensure at least one department exists
  if (!departments.length) {
    departments = [makeDefaultDept('dept_1', 'Station A3', DEPT_COLORS[0])];
    currentDeptId = 'dept_1';
    loadDeptState(departments[0]);
  }

  // Update header subtitle
  document.getElementById('header-dept-name').textContent = currentDept().name;

  // Ensure footerShifts initialized
  shiftTypes.forEach(st => {
    if (settings.footerShifts[st.id] === undefined) settings.footerShifts[st.id] = true;
  });

  // Detect device layout and apply responsive mode
  detectDeviceLayout();

  renderDeptTabs();
  render();
  setZoom(currentZoom);

  // Hook openModal to render dept-list when needed
  const _origOpen = window.openModal;
  window.openModal = function(id) {
    _origOpen(id);
    if (id === 'modal-depts') renderDeptList();
    if (id === 'modal-io') {
      const r = document.getElementById('io-import-result');
      if (r) { r.style.display = 'none'; r.textContent = ''; }
    }
  };

  // Try Firebase (optional cloud sync)
  window.addEventListener('firebaseReady', async () => {
    const fb = await loadFirebase();
    updateSyncBadge(fb);
    if (fb) render();
  });

  // Hide loader
  setTimeout(() => {
    document.getElementById('loading').classList.add('hidden');
  }, 600);
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('visible');
  });
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  const inInput = e.target.matches('input,textarea,select');
  const inModal = !!document.querySelector('.modal-overlay.visible');

  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.visible').forEach(m => m.classList.remove('visible'));
    document.getElementById('note-popup').classList.remove('visible');
    document.getElementById('context-menu').classList.remove('visible');
    document.getElementById('emp-context-menu').classList.remove('visible');
    if (focusEmpId) clearFocusMode();
    if (navCell) { navCell = null; document.querySelectorAll('.kbnav-focus').forEach(el => el.classList.remove('kbnav-focus')); }
    if (wishMode) toggleWishMode();
    if (selectedCells.size) clearMultiSel();
    _kbBuffer = ''; document.getElementById('kb-buffer-toast').classList.remove('visible');
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveAll(); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undoAction(); }
  if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || e.key === 'Y')) { e.preventDefault(); redoAction(); }

  // Clipboard Ctrl+C / Ctrl+V
  if ((e.ctrlKey || e.metaKey) && e.key === 'c' && navCell && !inInput) {
    e.preventDefault();
    copyCell(navCell.empId, navCell.ds);
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'v' && navCell && !inInput) {
    e.preventDefault();
    pasteCell(navCell.empId, navCell.ds);
  }

  // Keyboard navigation (arrow keys in table)
  if (!inInput && navCell && ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) {
    e.preventDefault();
    // Shift+Arrow: extend multi-selection
    if (e.shiftKey) {
      selectedCells.add(getSelKey(navCell.empId, navCell.ds));
      updateMultiSelUI();
    }
    moveNavCell(e.key);
    if (e.shiftKey && navCell) {
      selectedCells.add(getSelKey(navCell.empId, navCell.ds));
      updateMultiSelUI();
    }
    return;
  }

  // Space = place selected shift on navCell
  if (!inInput && e.key === ' ' && navCell) {
    e.preventDefault();
    if (!editLocked && !wishMode) {
      pushHistory();
      if (!shifts[navCell.empId]) shifts[navCell.empId] = {};
      const cur = shifts[navCell.empId][navCell.ds];
      if (cur?.type === selectedShift) {
        if (cur.note?.trim()) shifts[navCell.empId][navCell.ds].type = '';
        else delete shifts[navCell.empId][navCell.ds];
      } else {
        shifts[navCell.empId][navCell.ds] = { type: selectedShift, note: cur?.note||'', swap: cur?.swap||false };
      }
      renderTable(); saveLocal();
      moveNavCell('ArrowRight');
    }
    return;
  }

  // Delete key = clear navCell or selection
  if (!inInput && (e.key === 'Delete' || e.key === 'Backspace') && !inModal) {
    if (selectedCells.size > 0) { e.preventDefault(); clearShiftSelection(); return; }
    if (navCell) {
      e.preventDefault();
      if (!editLocked) {
        pushHistory();
        if (shifts[navCell.empId]) delete shifts[navCell.empId][navCell.ds];
        renderTable(); saveLocal();
      }
      return;
    }
  }

  // Single-char global shortcuts (only when not typing in input and no modal)
  if (!inInput && !inModal && !e.ctrlKey && !e.metaKey && !e.altKey) {
    if (e.key === 'p' || e.key === 'P') { togglePanMode(); return; }
    if (e.key === 'w' || e.key === 'W') { toggleWishMode(); return; }
  }

  // Keyboard input buffer for shift shortcuts (letter/digit keys, nav cell active)
  if (!inInput && !inModal && !e.ctrlKey && !e.metaKey && !e.altKey && navCell) {
    if (/^[a-zA-ZÃ¤Ã¶Ã¼Ã„Ã–ÃœÃŸ]$/.test(e.key)) {
      e.preventDefault();
      feedKbBuffer(e.key);
    }
  }
});

// =============================================================================
// PAN MODE (Drag-to-scroll)
// =============================================================================
(function initPan() {
  const tc = document.getElementById('table-container');
  let isPanning = false;
  let startX, startY, scrollLeft, scrollTop;

  tc.addEventListener('mousedown', e => {
    // Middle mouse always pans; left mouse only when pan mode active and not on interactive element
    const isMiddle = e.button === 1;
    const isLeft   = e.button === 0 && panModeActive;
    if (!isMiddle && !isLeft) return;
    if (isLeft && e.target.closest('button,input,select,textarea,.shift-badge,.note-only-chip')) return;
    isPanning = true;
    startX = e.clientX; startY = e.clientY;
    scrollLeft = tc.scrollLeft; scrollTop = tc.scrollTop;
    tc.classList.add('pan-active');
    e.preventDefault();
  });

  window.addEventListener('mousemove', e => {
    if (!isPanning) return;
    tc.scrollLeft = scrollLeft - (e.clientX - startX);
    tc.scrollTop  = scrollTop  - (e.clientY - startY);
  });

  window.addEventListener('mouseup', () => {
    if (!isPanning) return;
    isPanning = false;
    tc.classList.remove('pan-active');
    if (!panModeActive) tc.classList.remove('pan-ready');
  });
})();

function togglePanMode() {
  panModeActive = !panModeActive;
  const btn = document.getElementById('pan-btn');
  const tc  = document.getElementById('table-container');
  btn.classList.toggle('active', panModeActive);
  tc.classList.toggle('pan-ready', panModeActive);
  showToast(panModeActive ? 'âœ‹ Pan-Modus aktiv â€“ Klicken & Ziehen zum Verschieben' : 'âœ‹ Pan-Modus deaktiviert');
}

// =============================================================================
// FOCUS / HIGHLIGHT MODE
// =============================================================================
function toggleFocusMode(empId) {
  if (focusEmpId === empId) {
    clearFocusMode();
    return;
  }
  focusEmpId = empId;
  applyFocusMode();
  const emp = employees.find(e => e.id === empId);
  const _fen = document.getElementById('focus-emp-name'); if(_fen) _fen.textContent = emp ? emp.name : 'â€”';
  document.getElementById('focus-banner').classList.add('visible');
  showToast(`ðŸ‘ï¸ Fokus: ${emp?.name || ''}`);
}

function clearFocusMode() {
  focusEmpId = null;
  document.getElementById('focus-banner').classList.remove('visible');
  document.querySelectorAll('.emp-row').forEach(row => {
    row.classList.remove('focus-dimmed', 'focus-active');
  });
}

function applyFocusMode() {
  if (!focusEmpId) return;
  document.querySelectorAll('.emp-row').forEach(row => {
    const id = row.dataset.empid;
    row.classList.toggle('focus-dimmed', id !== focusEmpId);
    row.classList.toggle('focus-active',  id === focusEmpId);
  });
}

// =============================================================================
// COPY MONTH (Vorlagenmonat)
// =============================================================================
function openCopyMonthModal() {
  const sel = document.getElementById('copy-source-month');
  sel.innerHTML = '';
  // Offer last 12 months
  for (let i = 1; i <= 12; i++) {
    let m = currentMonth - i;
    let y = currentYear;
    while (m < 0)  { m += 12; y--; }
    const opt = document.createElement('option');
    opt.value = `${y}-${m}`;
    opt.textContent = `${MONTHS_DE[m]} ${y}`;
    sel.appendChild(opt);
  }
  const empSel = document.getElementById('copy-source-emp');
  // keep first "__all__" option, rebuild employee options
  while (empSel.options.length > 1) empSel.remove(1);
  employees.forEach(emp => {
    const opt = document.createElement('option');
    opt.value = emp.id;
    opt.textContent = emp.name;
    empSel.appendChild(opt);
  });
  openModal('modal-copy-month');
}

function executeCopyMonth() {
  const [srcY, srcM] = document.getElementById('copy-source-month').value.split('-').map(Number);
  const srcEmpVal = document.getElementById('copy-source-emp').value;
  const withNotes = document.getElementById('copy-with-notes').checked;
  const totalSrc  = daysInMonth(srcY, srcM);
  const totalDst  = daysInMonth(currentYear, currentMonth);
  pushHistory();
  let copied = 0;

  // Map: src day-of-week position â†’ dst day. We align by weekday (Mon=1st workday, etc.)
  // Simpler: copy day-number for day-number if within range
  employees.forEach(emp => {
    if (srcEmpVal !== '__all__' && emp.id !== srcEmpVal) return;
    if (!shifts[emp.id]) shifts[emp.id] = {};
    const maxD = Math.min(totalSrc, totalDst);
    for (let d = 1; d <= maxD; d++) {
      const srcDs = dateStr(srcY, srcM, d);
      const dstDs = dateStr(currentYear, currentMonth, d);
      const srcCell = shifts[emp.id]?.[srcDs];
      const dstCell = shifts[emp.id]?.[dstDs];
      if (!srcCell?.type) continue; // nothing to copy
      if (dstCell?.type) continue; // destination already has a shift
      shifts[emp.id][dstDs] = {
        type: srcCell.type,
        note: withNotes ? (srcCell.note || '') : '',
        swap: false
      };
      copied++;
    }
  });

  closeModal('modal-copy-month');
  renderTable(); saveLocal();
  showToast(`ðŸ“‹ ${copied} Dienste aus ${MONTHS_DE[srcM]} ${srcY} kopiert`);
}

// =============================================================================
// WUNSCH / SPERR â€“ LAYER
// =============================================================================
function toggleWishMode() {
  wishMode = !wishMode;
  document.body.classList.toggle('wish-mode-on', wishMode);
  document.getElementById('wish-mode-btn').classList.toggle('active', wishMode);
  showToast(wishMode
    ? 'ðŸ—“ VerfÃ¼gbarkeits-Modus aktiv â€“ Linksklick: Dienst-Wunsch âœ“  |  Rechtsklick: Sperrtag âœ—  |  ESC: beenden'
    : 'ðŸ—“ Wunschmodus deaktiviert');
}

function handleWishClick(e, empId, ds) {
  if (!wishMode) return false;
  e.preventDefault(); e.stopPropagation();
  if (!wishes[empId]) wishes[empId] = {};

  if (e.type === 'contextmenu' || e.button === 2) {
    // Rechtsklick: Sperrtag-Toggle
    if (wishes[empId][ds] && wishes[empId][ds].type === 'block') {
      delete wishes[empId][ds];
    } else {
      wishes[empId][ds] = { type: 'block' };
    }
    saveWishes();
    renderTable();
  } else {
    // Linksklick: Wunsch-Popup Ã¶ffnen (mit Dienstauswahl)
    openWishPopup(e, empId, ds);
  }
  return true;
}

function openWishPopup(e, empId, ds) {
  // Remove any existing popup
  closeWishPopup();

  const emp = employees.find(x => x.id === empId);
  if (!emp) return;

  const existing = wishes[empId]?.[ds];
  const existingShift = (existing && existing.type === 'wish') ? (existing.shift || '') : '';

  const popup = document.createElement('div');
  popup.id = 'wish-shift-popup';
  popup.className = 'wish-shift-popup';

  const dateObj = new Date(ds);
  const dateLabel = dateObj.toLocaleDateString('de-DE', { weekday:'short', day:'numeric', month:'short' });
  const empShort  = emp.name.split(',')[0].trim();

  // Build shift buttons
  const shiftBtns = shiftTypes.map(st =>
    `<button class="wsp-shift-btn${existingShift===st.id?' active':''}"
      style="background:${st.color};color:${st.textColor||'#fff'}"
      onclick="applyWish('${empId}','${ds}','${st.id}')">${st.id}</button>`
  ).join('');

  popup.innerHTML = `
    <div class="wsp-header">
      <span class="wsp-title">âœ“ Wunsch: ${empShort}</span>
      <span class="wsp-date">${dateLabel}</span>
      <button class="wsp-close" onclick="closeWishPopup()">Ã—</button>
    </div>
    <div class="wsp-body">
      <div class="wsp-label">Welcher Dienst ist gewÃ¼nscht?</div>
      <div class="wsp-shifts">${shiftBtns}</div>
      <div class="wsp-any">
        <button class="wsp-any-btn${existingShift===''&&existing?.type==='wish'?' active':''}"
          onclick="applyWish('${empId}','${ds}','')">Beliebiger Dienst</button>
        ${existing ? `<button class="wsp-del-btn" onclick="clearWish('${empId}','${ds}')">âœ• LÃ¶schen</button>` : ''}
      </div>
    </div>
  `;

  // Position near click
  document.body.appendChild(popup);
  const rect = popup.getBoundingClientRect();
  let x = e.clientX + 8, y = e.clientY + 8;
  if (x + 260 > window.innerWidth)  x = e.clientX - 268;
  if (y + 160 > window.innerHeight) y = e.clientY - 165;
  popup.style.left = x + 'px';
  popup.style.top  = y + 'px';

  // Close on outside click
  setTimeout(() => {
    document.addEventListener('mousedown', outsideWishPopup, { once: false });
  }, 10);
}

function outsideWishPopup(e) {
  const popup = document.getElementById('wish-shift-popup');
  if (popup && !popup.contains(e.target)) closeWishPopup();
}

function closeWishPopup() {
  const p = document.getElementById('wish-shift-popup');
  if (p) p.remove();
  document.removeEventListener('mousedown', outsideWishPopup);
}

function applyWish(empId, ds, shiftId) {
  if (!wishes[empId]) wishes[empId] = {};
  wishes[empId][ds] = { type: 'wish', shift: shiftId };
  saveWishes();
  renderTable();
  closeWishPopup();
}

function clearWish(empId, ds) {
  if (wishes[empId]) delete wishes[empId][ds];
  saveWishes();
  renderTable();
  closeWishPopup();
}

function saveWishes() {
  try { localStorage.setItem('dienstplan-wishes', JSON.stringify(wishes)); } catch(e) {}
}
function loadWishes() {
  try {
    const raw = localStorage.getItem('dienstplan-wishes');
    if (raw) wishes = JSON.parse(raw);
  } catch(e) {}
}

// =============================================================================
// COVERAGE BARS (Besetzungsbalken)
// =============================================================================
function buildCoverageBars(ds, maxCount) {
  // Show bars for the 3 key shifts: FD (blue), SD (amber), ND (purple)
  // Height proportional to count, max = maxCount employees
  const BAR_SHIFTS = [
    { id: 'FD', color: '#60a5fa' },
    { id: 'SD', color: '#fb923c' },
    { id: 'ND', color: '#a78bfa' },
  ];
  const counts = BAR_SHIFTS.map(b => ({
    ...b,
    count: employees.filter(emp => shifts[emp.id]?.[ds]?.type === b.id).length
  }));
  const max = Math.max(maxCount, 1);
  return `<div class="coverage-bars">${
    counts.map(b => {
      const h = Math.max(2, Math.round((b.count / max) * 14));
      const isLow = b.count < 2;
      return `<div class="cov-seg" style="height:${h}px;background:${isLow&&b.count>0?'#f59e0b':isLow?'#ef4444':b.color};opacity:${b.count===0?0.18:0.85}" title="${b.id}: ${b.count}"></div>`;
    }).join('')
  }</div>`;
}

// =============================================================================
// CELL CLIPBOARD
// =============================================================================
function copyCell(empId, ds) {
  const cell = shifts[empId]?.[ds];
  if (!cell?.type) { showToast('ðŸ“‹ Kein Dienst zum Kopieren'); return; }
  cellClipboard = { type: cell.type, note: cell.note || '' };
  const st = shiftTypes.find(s => s.id === cell.type);
  showToast(`ðŸ“‹ Kopiert: ${st?.label || cell.type}`);
  // Update paste button state
  updateContextPasteState();
}

function pasteCell(empId, ds) {
  if (!cellClipboard) { showToast('ðŸ“Œ Nichts in Zwischenablage'); return; }
  if (editLocked) return;
  pushHistory();
  if (!shifts[empId]) shifts[empId] = {};
  shifts[empId][ds] = { type: cellClipboard.type, note: cellClipboard.note, swap: false };
  renderTable(); saveLocal();
  // Flash the pasted cell
  requestAnimationFrame(() => {
    const td = document.querySelector(`tr[data-empid="${empId}"] td[data-ds="${ds}"]`);
    if (td) { td.classList.add('paste-flash'); td.addEventListener('animationend', () => td.classList.remove('paste-flash'), {once:true}); }
  });
}

function updateContextPasteState() {
  const el = document.getElementById('ctx-paste');
  if (el) el.style.opacity = cellClipboard ? '1' : '0.4';
}

// Wire up copy/paste context menu items
document.getElementById('ctx-copy').onclick = () => {
  if (contextTarget) copyCell(contextTarget.empId, contextTarget.ds);
  document.getElementById('context-menu').classList.remove('visible');
};
document.getElementById('ctx-paste').onclick = () => {
  if (contextTarget && cellClipboard) pasteCell(contextTarget.empId, contextTarget.ds);
  document.getElementById('context-menu').classList.remove('visible');
};

// =============================================================================
// KEYBOARD NAVIGATION
// =============================================================================
function setNavCell(empId, ds) {
  document.querySelectorAll('.kbnav-focus').forEach(el => el.classList.remove('kbnav-focus'));
  navCell = { empId, ds };
  const td = document.querySelector(`tr[data-empid="${empId}"] td[data-ds="${ds}"]`);
  if (td) { td.classList.add('kbnav-focus'); td.focus(); }
}

function moveNavCell(key) {
  if (!navCell) return;
  const days = getVisibleDays();
  const empIds = employees.map(e => e.id).filter(id => {
    const row = document.querySelector(`tr[data-empid="${id}"]`);
    return row && !row.classList.contains('filter-hidden');
  });
  const curDayIdx = days.findIndex(d => dateStr(currentYear, currentMonth, d) === navCell.ds);
  const curEmpIdx = empIds.indexOf(navCell.empId);
  let newDay = curDayIdx, newEmp = curEmpIdx;
  if (key === 'ArrowRight') newDay = Math.min(curDayIdx + 1, days.length - 1);
  if (key === 'ArrowLeft')  newDay = Math.max(curDayIdx - 1, 0);
  if (key === 'ArrowDown')  newEmp = Math.min(curEmpIdx + 1, empIds.length - 1);
  if (key === 'ArrowUp')    newEmp = Math.max(curEmpIdx - 1, 0);
  setNavCell(empIds[newEmp], dateStr(currentYear, currentMonth, days[newDay]));
}

// =============================================================================
// EMPLOYEE FILTER
// =============================================================================
function toggleFilterBar() {
  const bar = document.getElementById('emp-filter-bar');
  const isNow = bar.classList.toggle('visible');
  const fb = document.getElementById('filter-btn'); if (fb) fb.classList.toggle('active', isNow);
  if (isNow) setTimeout(() => document.getElementById('emp-filter-input').focus(), 50);
  else { applyEmpFilter(''); document.getElementById('emp-filter-input').value = ''; }
}

function applyEmpFilter(text) {
  empFilter = text.trim().toLowerCase();
  let visible = 0, total = employees.length;
  employees.forEach(emp => {
    const row = document.querySelector(`tr[data-empid="${emp.id}"]`);
    if (!row) return;
    const match = !empFilter ||
      emp.name.toLowerCase().includes(empFilter) ||
      (emp.role || '').toLowerCase().includes(empFilter);
    row.classList.toggle('filter-hidden', !match);
    if (match) visible++;
  });
  const cnt = document.getElementById('filter-count');
  if (cnt) cnt.textContent = empFilter ? `${visible} von ${total}` : '';
}

// =============================================================================
// CSV EXPORT
// =============================================================================
function exportCSV() {
  const holidays = getNRWHolidays(currentYear);
  const days = Array.from({length: daysInMonth(currentYear, currentMonth)}, (_, i) => i + 1);
  const DAYS_SHORT = ['So','Mo','Di','Mi','Do','Fr','Sa'];

  // Header row
  const headers = ['Mitarbeiter', 'Rolle', ...days.map(d => {
    const dow = new Date(currentYear, currentMonth, d).getDay();
    const ds  = dateStr(currentYear, currentMonth, d);
    const isH = !!holidays[ds];
    const isW = dow === 0 || dow === 6;
    return `${d}.${DAYS_SHORT[dow]}${isH?'*':isW?'Â°':''}`;
  }), 'Ist-h', 'Soll-h', 'Diff'];

  const workdays = getWorkdays(currentYear, currentMonth);
  const rows = employees.map(emp => {
    const ist  = calcIst(emp.id, currentYear, currentMonth);
    const soll = calcSoll(emp.vz, workdays, settings.hourFactor);
    const diff = Math.round((ist - soll + (emp.vmt||0)) * 10) / 10;
    const cells = days.map(d => {
      const ds   = dateStr(currentYear, currentMonth, d);
      const cell = shifts[emp.id]?.[ds];
      if (!cell?.type) return '';
      const note = cell.note ? ` (${cell.note})` : '';
      const swap = cell.swap ? ' ðŸ”„' : '';
      return `${cell.type}${note}${swap}`;
    });
    return [emp.name, emp.role || '', ...cells,
      String(ist).replace('.',','),
      String(soll).replace('.',','),
      (diff >= 0 ? '+' : '') + String(diff).replace('.',',')
    ];
  });

  const monthName = MONTHS_DE[currentMonth];
  // Summary rows
  rows.push([]);
  rows.push(['Legende:', '* = Feiertag', 'Â° = Wochenende']);
  const bestshifts = ['FD','SD','ND'];
  bestshifts.forEach(sid => {
    const st = shiftTypes.find(s => s.id === sid);
    const counts = days.map(d => {
      const ds = dateStr(currentYear, currentMonth, d);
      return employees.filter(emp => shifts[emp.id]?.[ds]?.type === sid).length;
    });
    rows.push([(st ? `${st.label} (${st.name})` : sid), '', ...counts.map(String), '', '', '']);
  });

  const csvContent = [headers, ...rows]
    .map(row => row.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(';'))
    .join('\n');

  const BOM = '\uFEFF'; // UTF-8 BOM for Excel
  const blob = new Blob([BOM + csvContent], {type:'text/csv;charset=utf-8;'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `Dienstplan_${monthName}_${currentYear}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast(`â¬‡ CSV exportiert: Dienstplan_${monthName}_${currentYear}.csv`);
}

// =============================================================================
// KI-DIENSTPLANER  â€“  Claude API  (Anthropic Artifact API)
// =============================================================================

function renderAIWeOverview() {
  // Update key status indicator
  const hasKey = !!(localStorage.getItem('dienstplan-ai-key') || '').trim();
  const lbl = document.getElementById('ai-key-label');
  const statusBox = document.getElementById('ai-key-status');
  if (lbl) lbl.textContent = hasKey ? 'âœ“ API-Key hinterlegt' : 'âš  Kein API-Key â€“ bitte unten eintragen';
  if (statusBox) statusBox.style.background = hasKey ? 'rgba(22,163,74,0.09)' : 'rgba(239,68,68,0.09)';
  if (statusBox) statusBox.style.borderColor = hasKey ? 'rgba(22,163,74,0.25)' : 'rgba(239,68,68,0.3)';
  if (lbl) lbl.style.color = hasKey ? '#4ade80' : '#f87171';
  if (!hasKey) {
    // Auto-open the edit area if no key
    const area = document.getElementById('ai-key-edit-area');
    const btn  = document.getElementById('ai-key-edit-btn');
    if (area) area.style.display = 'block';
    if (btn)  btn.textContent = 'schlieÃŸen';
  }

  // Pre-fill saved API key in edit field (masked)
  const keyInput = document.getElementById('ai-api-key');
  if (keyInput && hasKey) keyInput.value = ''; // keep field empty for security, user re-enters if changing

  const grpA    = employees.filter(e => e.weGroup === 'A').map(e => e.name.split(',')[0].trim());
  const grpB = employees.filter(e => e.weGroup === 'B').map(e => e.name.split(',')[0].trim());
  const grpNone = employees.filter(e => !e.weGroup).map(e => e.name.split(',')[0].trim());
  const ge = elId => document.getElementById(elId);
  if (ge('ai-we-a-list'))    ge('ai-we-a-list').textContent    = grpA.length    ? `A (${grpA.length}): ${grpA.join(', ')}` : 'A: â€“';
  if (ge('ai-we-b-list'))    ge('ai-we-b-list').textContent    = grpB.length    ? `B (${grpB.length}): ${grpB.join(', ')}` : 'B: â€“';
  if (ge('ai-we-none-list')) ge('ai-we-none-list').textContent = grpNone.length ? `Ohne Gruppe: ${grpNone.join(', ')}` : '';

  // Populate wish/availability overview
  const monthStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
  const lines = [];
  employees.forEach(emp => {
    const ew = wishes[emp.id] || {};
    Object.entries(ew).forEach(([ds, raw]) => {
      if (!ds.startsWith(monthStr)) return;
      const w = typeof raw === 'string' ? { type: raw, shift: '' } : raw;
      const empShort = emp.name.split(',')[0].trim();
      const dateLabel = new Date(ds).toLocaleDateString('de-DE', { weekday:'short', day:'numeric', month:'numeric' });
      if (w.type === 'block') {
        lines.push(`âœ— ${empShort}: ${dateLabel} â€“ Sperrtag`);
      } else if (w.shift) {
        lines.push(`âœ“ ${empShort}: ${dateLabel} â€“ ${w.shift} (Pflicht)`);
      } else {
        lines.push(`âœ“ ${empShort}: ${dateLabel} â€“ Wunsch (beliebig)`);
      }
    });
  });
  const wishBox = ge('ai-wish-overview');
  const wishList = ge('ai-wish-list');
  if (wishBox && wishList) {
    if (lines.length) {
      wishBox.style.display = 'block';
      wishList.innerHTML = lines.join('<br>');
    } else {
      wishBox.style.display = 'none';
    }
  }
}

function saveAIKey(val) {
  try { localStorage.setItem('dienstplan-ai-key', val.trim()); } catch(e) {}
  // Update status label
  const lbl = document.getElementById('ai-key-label');
  if (lbl) lbl.textContent = val.trim() ? 'âœ“ API-Key hinterlegt' : 'âš  Kein API-Key';
}
function toggleKeyVisibility() {
  const inp = document.getElementById('ai-api-key');
  if (!inp) return;
  inp.type = inp.type === 'password' ? 'text' : 'password';
}
function toggleAIKeyEdit() {
  const area = document.getElementById('ai-key-edit-area');
  const btn  = document.getElementById('ai-key-edit-btn');
  if (!area) return;
  const open = area.style.display === 'none';
  area.style.display = open ? 'block' : 'none';
  if (btn) btn.textContent = open ? 'schlieÃŸen' : 'Ã¤ndern';
}

function aiLog(msg) {
  const el = document.getElementById('ai-log');
  if (!el) return;
  el.classList.add('visible');
  el.textContent += msg + '\n';
  el.scrollTop = el.scrollHeight;
}

function aiProgress(pct) {
  const bar = document.getElementById('ai-progress-bar');
  const fill = document.getElementById('ai-progress-fill');
  if (!bar || !fill) return;
  bar.classList.add('visible');
  fill.style.width = pct + '%';
}

function aiReset() {
  const log = document.getElementById('ai-log');
  const badges = document.getElementById('ai-result-badges');
  const bar = document.getElementById('ai-progress-bar');
  if (log)    { log.classList.remove('visible'); log.textContent = ''; }
  if (badges) { badges.style.display = 'none'; badges.innerHTML = ''; }
  if (bar)    { bar.classList.remove('visible'); document.getElementById('ai-progress-fill').style.width = '0%'; }
}

async function runAIPlanner() {
  const btn = document.getElementById('ai-run-btn');
  btn.disabled = true;
  btn.textContent = 'â³ Plane...';
  aiReset();
  aiProgress(5);
  aiLog('âœ¦ KI-Dienstplanung gestartet...');

  // â”€â”€ file:// detection â€“ CORS blocked in Safari/Firefox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (window.location.protocol === 'file:') {
    aiLog('âš ï¸ WARNUNG: Du Ã¶ffnest diese Datei direkt (file://).');
    aiLog('   Manche Browser blockieren API-Anfragen aus SicherheitsgrÃ¼nden.');
    aiLog('   Bei Problemen: Datei Ã¼ber einen lokalen Webserver Ã¶ffnen.');
    aiLog('   (z.B. VS Code "Live Server" oder: python3 -m http.server 8080)');
    aiLog('   Versuche trotzdem...');
  }

  // â”€â”€ Collect config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rules = {
    minFD:        +document.getElementById('ai-min-fd').value || 2,
    minSD:        +document.getElementById('ai-min-sd').value || 2,
    minND:        +document.getElementById('ai-min-nd').value || 2,
    maxStreak:    +document.getElementById('ai-max-streak').value || 9,
    maxNDPerWeek: +document.getElementById('ai-max-nd').value || 3,
    weBalance:    document.getElementById('ai-we-balance').checked,
    hoursBalance: document.getElementById('ai-hours-balance').checked,
    respectWishes:document.getElementById('ai-respect-wishes').checked,
    mode:         document.getElementById('ai-mode').value,
  };

  const total      = daysInMonth(currentYear, currentMonth);
  const workdays   = getWorkdays(currentYear, currentMonth);
  const holidays   = getNRWHolidays(currentYear);
  const monthLabel = `${MONTHS_DE[currentMonth]} ${currentYear}`;

  aiLog(`ðŸ“… Monat: ${monthLabel}  |  ${total} Tage  |  ${workdays} Arbeitstage`);
  aiLog(`ðŸ‘¥ Mitarbeiter: ${employees.length}  |  Dienste: ${shiftTypes.map(s=>s.id).join(', ')}`);
  aiProgress(15);

  // â”€â”€ Build prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const empList = employees.map(e => {
    const grp = e.weGroup ? ` [WE-Gruppe ${e.weGroup}]` : '';
    const prefs = e.preferences ? ` | PrÃ¤ferenzen: "${e.preferences}"` : '';
    return `- ${e.name} (${e.role}, VZ ${e.vz}%, SOLL ${calcSoll(e.vz, workdays, settings.hourFactor)}h${grp}${prefs})`;
  }).join('\n');

  const shiftList = shiftTypes.map(s =>
    `- ${s.id}: ${s.name} (${s.hours}h)`
  ).join('\n');

  // Existing assignments (for fill-mode)
  let existingInfo = '';
  if (rules.mode === 'fill') {
    const assigned = [];
    employees.forEach(emp => {
      for (let d = 1; d <= total; d++) {
        const ds = dateStr(currentYear, currentMonth, d);
        const c = shifts[emp.id]?.[ds];
        if (c?.type) assigned.push(`${emp.name.split(',')[0].trim()}|${ds}|${c.type}`);
      }
    });
    if (assigned.length) existingInfo = `\nBereits eingetragen (NICHT Ã¤ndern):\n${assigned.slice(0,60).join('\n')}${assigned.length>60?' ...und mehr':''}\n`;
  }

  // WÃ¼nsche
  let wishInfo = '';
  if (rules.respectWishes) {
    const ws = [];
    employees.forEach(emp => {
      const ew = wishes[emp.id] || {};
      Object.entries(ew).forEach(([ds,raw]) => {
        if (!ds.startsWith(`${currentYear}-${String(currentMonth+1).padStart(2,'0')}`)) return;
        // Support both old string format and new object format
        const w = typeof raw === 'string' ? { type: raw, shift: '' } : raw;
        if (w.type === 'block') {
          ws.push(`${emp.name.split(',')[0].trim()}|${ds}|SPERRTAG (darf NICHT arbeiten)`);
        } else if (w.shift) {
          ws.push(`${emp.name.split(',')[0].trim()}|${ds}|PFLICHT-${w.shift} (muss genau diesen Dienst haben)`);
        } else {
          ws.push(`${emp.name.split(',')[0].trim()}|${ds}|WUNSCH (soll arbeiten, Dienst beliebig)`);
        }
      });
    });
    if (ws.length) wishInfo = `\nVerfÃ¼gbarkeiten / WÃ¼nsche / Sperrtage:\n${ws.join('\n')}\nWICHTIG: PFLICHT-EintrÃ¤ge sind bindend â€“ diese Dienste mÃ¼ssen exakt so geplant werden!\n`;
  }

  const prompt = `Du bist ein professioneller Pflegedienstplaner in einer deutschen Klinik.
Erstelle einen vollstÃ¤ndigen Dienstplan fÃ¼r ${monthLabel} (${total} Tage).

== MITARBEITER ==
${empList}

== DIENSTE ==
${shiftList}
X: Frei (0h)
U: Urlaub (0h)

== REGELN ==
1. Mindestbesetzung pro Tag: FDâ‰¥${rules.minFD}, SDâ‰¥${rules.minSD}, NDâ‰¥${rules.minND}
2. Max. ${rules.maxStreak} Arbeitstage am StÃ¼ck, dann mind. 1 freier Tag
3. Nacht (ND): max. ${rules.maxNDPerWeek} NÃ¤chte/Woche pro Person, danach Ruhetag
4. Kein ND direkt gefolgt von FD am nÃ¤chsten Tag (ArbZG Â§5 Ruhezeit â€“ mind. 11h)
5. Wochenend-Gruppen beachten:
   - Gruppe A: arbeitet Wochenenden 1, 3, 5 des Monats (Sa+So); hat Wochenenden 2, 4 FREI
   - Gruppe B: arbeitet Wochenenden 2, 4 des Monats; hat Wochenenden 1, 3, 5 FREI
   - Mitarbeiter ohne Gruppe: frei planbar
   ZÃ¤hle die Wochenenden des Monats in der Reihenfolge (erstes Sa+So = WE1, etc.)
6. IST-Stunden${rules.hoursBalance ? ' mÃ¶glichst nah am SOLL' : ' frei wÃ¤hlbar'} halten
7. Feiertage (NRW) im Monat: ${Object.entries(holidays).filter(([ds])=>ds.startsWith(`${currentYear}-${String(currentMonth+1).padStart(2,'0')}`)).map(([,n])=>n).join(', ')||'keine'}
8. WICHTIG â€“ Individuelle PrÃ¤ferenzen der Mitarbeiter beachten (hinter "PrÃ¤ferenzen:" bei jedem MA):
   - Diese sind keine starren Regeln, aber respektiere sie so gut wie mÃ¶glich
   - Bei Konflikten haben Mindestbesetzung und ArbZG Vorrang
${existingInfo}${wishInfo}

== AUSGABE (NUR JSON, kein anderer Text) ==
Gib AUSSCHLIESSLICH ein JSON-Objekt aus:
{
  "plan": [
    { "emp": "NACHNAME", "date": "YYYY-MM-DD", "shift": "FD" },
    ...
  ],
  "notes": "Kurze Zusammenfassung: Besonderheiten, Hinweise zu unerfÃ¼llten PrÃ¤ferenzen"
}

Plane alle ${employees.length} Mitarbeiter, alle ${total} Tage. Nutze X fÃ¼r freie Tage.
${rules.mode === 'fill' ? 'Lasse bereits eingetragene Zellen unverÃ¤ndert.' : ''}
Antworte NUR mit dem JSON-Objekt, kein Kommentar davor oder danach.`;

  aiLog('ðŸ“¤ Sende Anfrage an Claude (claude-sonnet-4-6)...');
  aiProgress(30);

  // â”€â”€ API Key abrufen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const apiKey = (localStorage.getItem('dienstplan-ai-key') || '').trim();
  if (!apiKey) {
    aiLog('âŒ Kein API-Key gefunden!');
    aiLog('   â†’ Klicke oben auf "Ã¤ndern" und gib deinen Anthropic API-Key ein');
    aiLog('   â†’ Keys erstellen: console.anthropic.com/keys');
    btn.disabled = false;
    btn.textContent = 'âœ¦ Jetzt planen';
    aiProgress(0);
    return;
  }
  aiLog('ðŸ”‘ API-Key gefunden (' + apiKey.length + ' Zeichen)');

  // â”€â”€ API-Aufruf â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let planData;
  try {
    aiLog('ðŸŒ Verbinde mit api.anthropic.com...');
    let resp;
    try {
      resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-6',
          max_tokens: 8000,
          messages: [{ role: 'user', content: prompt }]
        })
      });
    } catch(fetchErr) {
      const ferr = (fetchErr && fetchErr.message) ? fetchErr.message : String(fetchErr);
      if (ferr === 'Script error.' || ferr === 'Script error') {
        aiLog('âŒ Fehler: Browser blockiert die Anfrage (CORS / file://)');
        aiLog('');
        aiLog('ðŸ’¡ LÃ–SUNG: Ã–ffne die Datei Ã¼ber einen lokalen Webserver:');
        aiLog('   VS Code: Rechtsklick â†’ "Open with Live Server"');
        aiLog('   Terminal: python3 -m http.server 8080');
        aiLog('   Dann: http://localhost:8080/dienstplan-pro.html');
      } else {
        aiLog('âŒ Netzwerkfehler: ' + ferr);
        aiLog('   PrÃ¼fe Internetverbindung und ob api.anthropic.com erreichbar ist.');
      }
      btn.disabled = false;
      btn.textContent = 'âœ¦ Erneut versuchen';
      aiProgress(0);
      return;
    }

    aiProgress(65);
    aiLog('ðŸ“¥ HTTP ' + resp.status + ' ' + resp.statusText);

    if (!resp.ok) {
      let errBody = '';
      try { errBody = await resp.text(); } catch(_) {}
      let errMsg = 'API-Fehler ' + resp.status;
      try {
        const errJSON = JSON.parse(errBody);
        errMsg += ': ' + (errJSON.error?.message || errBody.slice(0, 300));
      } catch(_) {
        if (errBody) errMsg += ': ' + errBody.slice(0, 300);
      }
      if (resp.status === 401) errMsg += '  [API-Key ungÃ¼ltig/abgelaufen]';
      else if (resp.status === 403) errMsg += '  [Zugriff verweigert]';
      else if (resp.status === 404) errMsg += '  [Modell nicht gefunden â€“ falscher Model-String?]';
      else if (resp.status === 429) errMsg += '  [Rate-Limit â€“ kurz warten und erneut versuchen]';
      else if (resp.status === 400) errMsg += '  [UngÃ¼ltige Anfrage â€“ Prompt eventuell zu lang]';
      else if (resp.status === 500) errMsg += '  [Serverfehler bei Anthropic]';
      throw new Error(errMsg);
    }

    const data = await resp.json();
    const raw = (data.content || []).map(b => b.text || '').join('');
    if (!raw.trim()) throw new Error('API antwortete mit leerem Inhalt');
    aiLog('âœ… Antwort: ' + raw.length + ' Zeichen empfangen');
    aiProgress(75);

    // JSON aus der Antwort extrahieren (markdown-fences ignorieren)
    const clean = raw.replace(/```json/gi, '').replace(/```/g, '').trim();
    const jStart = clean.indexOf('{');
    const jEnd   = clean.lastIndexOf('}');
    if (jStart < 0 || jEnd < 0) {
      aiLog('âš  Antwort-Anfang: ' + raw.slice(0, 300));
      throw new Error('Kein JSON-Objekt in der Antwort gefunden');
    }
    try {
      planData = JSON.parse(clean.slice(jStart, jEnd + 1));
    } catch(jsonErr) {
      aiLog('âš  JSON-Anfang: ' + clean.slice(jStart, jStart + 200));
      throw new Error('JSON-Parse-Fehler: ' + jsonErr.message);
    }
    if (!Array.isArray(planData.plan)) {
      throw new Error('UngÃ¼ltige Antwortstruktur: kein "plan"-Array gefunden');
    }
    aiLog('âœ… Plan erhalten: ' + planData.plan.length + ' EintrÃ¤ge');
  } catch(e) {
    const msg = (e && e.message) ? e.message : String(e);
    aiLog('âŒ ' + msg);
    btn.disabled = false;
    btn.textContent = 'âœ¦ Erneut versuchen';
    aiProgress(0);
    return;
  }

  // â”€â”€ Apply plan to shifts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  aiProgress(80);
  aiLog('ðŸ“ Trage Dienste ein...');
  pushHistory();

  let applied = 0, skipped = 0, unknown = 0;
  const entries = planData.plan || [];

  entries.forEach(entry => {
    const { emp: empName, date, shift: shiftId } = entry;
    if (!empName || !date || !shiftId) return;

    // Find employee by name substring match
    const emp = employees.find(e =>
      e.name.toUpperCase().includes(empName.toUpperCase().trim()) ||
      empName.toUpperCase().trim().includes(e.name.split(',')[0].toUpperCase().trim())
    );
    if (!emp) { unknown++; return; }

    // Fill-mode: skip if already set
    if (rules.mode === 'fill' && shifts[emp.id]?.[date]?.type) { skipped++; return; }

    // Validate shift type
    const st = shiftTypes.find(s => s.id === shiftId);
    if (!st && shiftId !== 'X' && shiftId !== 'U') { unknown++; return; }

    if (!shifts[emp.id]) shifts[emp.id] = {};
    if (shiftId === 'X') {
      // For free days, only clear if no note
      const cur = shifts[emp.id][date];
      if (cur && cur.note?.trim()) { skipped++; return; }
      delete shifts[emp.id][date];
    } else {
      const cur = shifts[emp.id][date];
      shifts[emp.id][date] = { type: shiftId, note: cur?.note || '', swap: false };
    }
    applied++;
  });

  aiProgress(95);
  renderTable();
  saveLocal();
  aiProgress(100);

  // â”€â”€ Show result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  aiLog(`\nâœ… Fertig! ${applied} Dienste eingetragen, ${skipped} Ã¼bersprungen.`);
  if (planData.notes) aiLog(`ðŸ’¬ ${planData.notes}`);

  const badges = document.getElementById('ai-result-badges');
  badges.style.display = 'flex';
  badges.innerHTML = `
    <span class="ai-result-badge ok">âœ… ${applied} Dienste</span>
    ${skipped ? `<span class="ai-result-badge warn">â­ ${skipped} Ã¼bersprungen</span>` : ''}
    ${unknown ? `<span class="ai-result-badge warn">âš ï¸ ${unknown} unbekannt</span>` : ''}
  `;

  btn.disabled = false;
  btn.textContent = 'âœ¦ Erneut planen';
  showToast(`âœ¦ KI-Plan: ${applied} Dienste eingetragen`);
}

// =============================================================================
// DEVICE / LAYOUT MANAGEMENT
// =============================================================================

function detectDeviceLayout() {
  // Don't override manual selection
  if (document.body.dataset.layoutManual) return;
  const w = window.innerWidth;
  const hasTouch = navigator.maxTouchPoints > 1 || ('ontouchstart' in window);
  let layout;
  if (w >= 1400 && !hasTouch) layout = 'desktop';
  else if (w >= 1100) layout = 'compact';
  else if (w >= 800)  layout = 'tablet';
  else                layout = 'mobile';
  applyLayout(layout, false, true); // silent=true on auto-detect
}

function applyLayout(layout, manual, silent) {
  document.body.dataset.layout = layout;
  if (manual) {
    document.body.dataset.layoutManual = '1';
  } else {
    delete document.body.dataset.layoutManual;
  }
  // Update toggle button icon
  const btn = document.getElementById('layout-toggle-btn');
  if (btn) btn.dataset.layout = layout;
  // Show/hide overflow drawer trigger on mobile
  const drawerBtn = document.getElementById('overflow-drawer-btn');
  if (drawerBtn) drawerBtn.style.display = layout === 'mobile' ? 'flex' : 'none';
  // Close drawer when switching away from mobile
  if (layout !== 'mobile') closeOverflowDrawer();
  // Sync undo/redo state in drawer
  updateUndoRedoBtns();
  if (!silent) {
    showToast({
      desktop: 'ðŸ–¥ Desktop-Ansicht',
      compact: 'ðŸ’» Kompakte Ansicht',
      tablet:  'ðŸ“± Tablet-Ansicht',
      mobile:  'ðŸ“Ÿ Mobil-Ansicht'
    }[layout] || layout);
  }
}

const LAYOUTS = ['desktop','compact','tablet','mobile'];
function cycleLayout() {
  const current = document.body.dataset.layout || 'desktop';
  const next = LAYOUTS[(LAYOUTS.indexOf(current) + 1) % LAYOUTS.length];
  applyLayout(next, true);
}

function toggleOverflowDrawer() {
  const drawer = document.getElementById('header-overflow-drawer');
  drawer.classList.toggle('open');
}
function closeOverflowDrawer() {
  document.getElementById('header-overflow-drawer')?.classList.remove('open');
}

// Listen for window resize â†’ re-detect auto layout
window.addEventListener('resize', () => {
  if (!document.body.dataset.layoutManual) detectDeviceLayout();
});



// =============================================================================
// NEUE FEATURES â€“ Schichtmuster, SchnellprÃ¼fung, Meldewesen
// =============================================================================

// â”€â”€ 1. Wechselschicht-Muster automatisch eintragen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FÃ¼llt eine 2-Wochen-Rotation (FD/SD/ND/FD...) fÃ¼r einen Mitarbeiter
function applyShiftPattern(empId, patternName) {
  if (!empId || editLocked) return;
  const emp = employees.find(e => e.id === empId);
  if (!confirm(`Schichtmuster "${patternName}" fÃ¼r ${emp?.name || 'MA'} anwenden?\nBestehende Dienste im ${MONTHS_DE[currentMonth]} werden Ã¼berschrieben.`)) return;

  const patterns = {
    'FD-SD-wechsel': ['FD','FD','FD','FD','FD','X','X', 'SD','SD','SD','SD','SD','X','X'],
    'ND-Block':      ['ND','ND','ND','X','X','X','X', 'ND','ND','ND','X','X','X','X'],
    'FD-Rotation':   ['FD','SD','FD','SD','FD','X','X', 'FD','SD','FD','SD','FD','X','X'],
    'Vollrotation':  ['FD','FD','SD','SD','ND','X','X', 'FD','FD','SD','SD','ND','X','X'],
  };
  const pat = patterns[patternName];
  if (!pat) { showToast('âŒ Muster nicht gefunden'); return; }

  pushHistory();
  if (!shifts[empId]) shifts[empId] = {};
  const total = daysInMonth(currentYear, currentMonth);
  const startDate = new Date(currentYear, currentMonth, 1);
  const startWday = startDate.getDay() === 0 ? 6 : startDate.getDay() - 1; // Mon=0

  // Build a pattern starting from Monday before month start
  for (let d = 1; d <= total; d++) {
    const date = new Date(currentYear, currentMonth, d);
    const wday = date.getDay() === 0 ? 6 : date.getDay() - 1;
    // absolute day offset from month start
    const absDay = d - 1;
    // Position in the 14-day cycle (adjust so week starts on Monday)
    const patIdx = ((absDay + startWday) % 14 + 14) % 14;
    const shiftId = pat[patIdx];
    const ds = dateStr(currentYear, currentMonth, d);
    const cur = shifts[empId][ds];
    if (shiftId === 'X') {
      // Only clear if no note
      if (cur && !cur.note?.trim()) delete shifts[empId][ds];
    } else {
      const st = shiftTypes.find(s => s.id === shiftId);
      if (st) shifts[empId][ds] = { type: shiftId, note: cur?.note || '', swap: false };
    }
  }
  renderTable(); saveLocal();
  showToast(`âœ… Muster "${patternName}" eingetragen`);
  document.getElementById('emp-context-menu').classList.remove('visible');
}

// â”€â”€ 2. Feiertagsautomatik â€“ Urlaub/Frei auf Feiertage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function markHolidaysAsFrei() {
  if (editLocked) return;
  const hols = getNRWHolidays(currentYear);
  const total = daysInMonth(currentYear, currentMonth);
  pushHistory();
  let count = 0;
  for (let d = 1; d <= total; d++) {
    const ds = dateStr(currentYear, currentMonth, d);
    if (hols[ds]) {
      employees.forEach(emp => {
        if (!shifts[emp.id]) shifts[emp.id] = {};
        const cur = shifts[emp.id][ds];
        // Only mark if cell is empty
        if (!cur || !cur.type) {
          shifts[emp.id][ds] = { type: 'X', note: hols[ds], swap: false };
          count++;
        }
      });
    }
  }
  renderTable(); saveLocal();
  showToast(count ? `ðŸ– ${count} Feiertag-EintrÃ¤ge gesetzt` : 'Keine leeren Feiertage gefunden');
}

// â”€â”€ 3. Monatsabschluss-Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runMonthCheck() {
  const total   = daysInMonth(currentYear, currentMonth);
  const workdays = getWorkdays(currentYear, currentMonth);
  const hols    = getNRWHolidays(currentYear);
  const issues  = [];

  employees.forEach(emp => {
    const soll = calcSoll(emp.vz, workdays, settings.hourFactor);
    const ist  = calcIst(emp.id, currentYear, currentMonth);
    const diff = ist - soll;

    // Check uncovered weekend days
    let unplanned = 0;
    for (let d = 1; d <= total; d++) {
      const ds = dateStr(currentYear, currentMonth, d);
      const wk = isWeekend(currentYear, currentMonth, d);
      if (!wk && !hols[ds]) {
        const c = shifts[emp.id]?.[ds];
        if (!c || !c.type) unplanned++;
      }
    }
    if (unplanned > 3) issues.push({ emp: emp.name, type: 'LÃ¼cken', detail: `${unplanned} ungeplante Werktage` });
    if (diff < -15)    issues.push({ emp: emp.name, type: 'Minus',  detail: `${Math.abs(diff).toFixed(1)}h Minusstunden` });
    if (diff > 15)     issues.push({ emp: emp.name, type: 'Plus',   detail: `${diff.toFixed(1)}h Ãœberstunden` });
  });

  const cont = document.getElementById('stats-content');
  let html = '';
  if (issues.length === 0) {
    html = '<div style="text-align:center;padding:24px;color:#10b981;font-weight:600;font-size:14px">âœ… Keine Probleme gefunden â€“ Monat sieht gut aus!</div>';
  } else {
    html += `<div style="font-size:12px;font-weight:700;color:var(--helios-red);margin-bottom:12px;letter-spacing:0.5px">âš ï¸ ${issues.length} HINWEIS${issues.length>1?'E':''}</div>`;
    html += '<table class="stats-table"><thead><tr><th>Mitarbeiter</th><th>Kategorie</th><th>Detail</th></tr></thead><tbody>';
    issues.forEach(iss => {
      const color = iss.type === 'LÃ¼cken' ? 'var(--text)' : iss.type === 'Minus' ? '#f97316' : '#e30613';
      html += `<tr><td style="font-weight:600">${escapeHTML(iss.emp)}</td><td style="color:${color};font-weight:600">${iss.type}</td><td>${iss.detail}</td></tr>`;
    });
    html += '</tbody></table>';
  }
  return html;
}

// â”€â”€ 4. Extend employee context menu with shift patterns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// (Wired via renderEmpContextMenu override)
function showEmpContextMenuWithPatterns(e, empId) {
  // Just call the standard function - patterns accessible via 2nd context menu
  handleEmpContextMenu(e, empId);
}



// =============================================================================
// EMPLOYEE HOVER TOOLTIP
// =============================================================================
let _empTipTimer = null;
const _empTip = () => document.getElementById('emp-tooltip');

function showEmpTooltip(e, empId) {
  clearTimeout(_empTipTimer);
  const emp = employees.find(x => x.id === empId);
  if (!emp) return;

  // CRITICAL: capture rect NOW â€“ e.currentTarget becomes null after event returns
  const rect = e.currentTarget.getBoundingClientRect();

  _empTipTimer = setTimeout(() => {
    const tip = _empTip();
    if (!tip) return;

    // Compute stats
    const workdays = getWorkdays(currentYear, currentMonth);
    const soll = calcSoll(emp.vz, workdays, settings.hourFactor);
    const ist  = calcIst(emp.id, currentYear, currentMonth);
    const diff = Math.round((ist - soll + (emp.vmt||0)) * 10) / 10;
    const diffSign = diff >= 0 ? '+' : '';
    const diffClass = diff > 0 ? 'positive' : diff < 0 ? 'negative' : '';

    // Shift breakdown for current month
    const total = daysInMonth(currentYear, currentMonth);
    const shiftCounts = {};
    for (let d = 1; d <= total; d++) {
      const ds = dateStr(currentYear, currentMonth, d);
      const c = shifts[emp.id]?.[ds];
      if (c?.type) shiftCounts[c.type] = (shiftCounts[c.type] || 0) + 1;
    }

    // Fill tooltip
    document.getElementById('emp-tt-name').textContent  = emp.name;
    document.getElementById('emp-tt-role').textContent  = emp.role;
    document.getElementById('emp-tt-vz').textContent    = emp.vz + '%';
    document.getElementById('emp-tt-we').textContent    = emp.weGroup ? 'Gruppe ' + emp.weGroup : 'Keine';
    document.getElementById('emp-tt-hours').textContent = ist + ' / ' + soll + ' h';
    const diffEl = document.getElementById('emp-tt-diff');
    diffEl.textContent  = diffSign + diff + ' h';
    diffEl.className = 'emp-tt-stat-val ' + diffClass;

    // Shift badges
    const badgesEl = document.getElementById('emp-tt-shift-badges');
    const topShifts = Object.entries(shiftCounts)
      .sort((a,b) => b[1]-a[1])
      .slice(0, 8);
    if (topShifts.length > 0) {
      badgesEl.style.display = 'flex';
      badgesEl.innerHTML = topShifts.map(([id, cnt]) => {
        const st = shiftTypes.find(s => s.id === id);
        const bg = st ? st.bg : '#888';
        const col = st ? st.color : '#fff';
        return `<span class="emp-tt-badge" style="background:${bg};color:${col}">${id} Ã—${cnt}</span>`;
      }).join('');
    } else {
      badgesEl.style.display = 'none';
      badgesEl.innerHTML = '';
    }

    // Preferences
    const prefsWrap = document.getElementById('emp-tt-prefs-wrap');
    if (emp.preferences) {
      prefsWrap.style.display = 'block';
      document.getElementById('emp-tt-prefs').textContent = emp.preferences;
    } else {
      prefsWrap.style.display = 'none';
    }

    // Position using pre-captured rect
    tip.style.left = (rect.right + 8) + 'px';
    tip.style.top  = rect.top + 'px';
    tip.classList.add('visible');

    // Check viewport overflow â†’ flip
    requestAnimationFrame(() => {
      const tipRect = tip.getBoundingClientRect();
      if (tipRect.right > window.innerWidth - 12) {
        tip.style.left = (rect.left - tipRect.width - 8) + 'px';
      }
      if (tipRect.bottom > window.innerHeight - 12) {
        tip.style.top = Math.max(8, window.innerHeight - tipRect.height - 12) + 'px';
      }
    });
  }, 350);
}

function hideEmpTooltip() {
  clearTimeout(_empTipTimer);
  const tip = _empTip();
  if (tip) tip.classList.remove('visible');
}

// =============================================================================
// CUSTOM SHORTCUTS MANAGEMENT
// =============================================================================
let _currentShiftsTab = 'types';

function switchShiftsTab(tab) {
  _currentShiftsTab = tab;
  const panels = { types: 'shifts-panel-types', shortcuts: 'shifts-panel-shortcuts' };
  const btns   = { types: 'shifts-tab-types', shortcuts: 'shifts-tab-shortcuts' };
  Object.keys(panels).forEach(t => {
    const panel = document.getElementById(panels[t]);
    const btn   = document.getElementById(btns[t]);
    if (!panel || !btn) return;
    const active = t === tab;
    panel.style.display = active ? 'block' : 'none';
    btn.style.background = active ? 'var(--teal)' : 'var(--glass2)';
    btn.style.color = active ? 'white' : 'var(--text2)';
    btn.style.borderBottom = active ? '2px solid var(--teal)' : '2px solid transparent';
  });
}

function renderShortcutsPanel() {
  // Show built-in shortcuts as read-only chips
  const builtinEl = document.getElementById('builtin-shortcuts-display');
  if (builtinEl) {
    const builtins = [
      {k:'fd/frÃ¼h', v:'FD'},{k:'sd/spÃ¤t', v:'SD'},{k:'nd/nacht', v:'ND'},
      {k:'zd/zwischen', v:'ZD'},{k:'st', v:'ST'},{k:'lt', v:'LT'},
      {k:'u/urlaub', v:'U'},{k:'k/krank', v:'K'},{k:'x/frei', v:'X'},{k:'fb/fort', v:'FB'}
    ];
    builtinEl.innerHTML = builtins.map(b => {
      const st = shiftTypes.find(s => s.id === b.v);
      const bg = st ? st.bg : '#888';
      const col = st ? st.color : '#fff';
      return `<span style="display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:11px;background:var(--surface2);border:1px solid var(--border);color:var(--text2)">
        <code style="font-family:monospace;font-weight:700;color:var(--teal)">${b.k}</code>
        <span style="color:var(--text3)">â†’</span>
        <span style="background:${bg};color:${col};padding:1px 6px;border-radius:4px;font-size:10px;font-weight:700">${b.v}</span>
      </span>`;
    }).join('');
  }

  // Render editable custom shortcuts
  const container = document.getElementById('custom-shortcuts-list');
  if (!container) return;
  container.innerHTML = '';

  const entries = Object.entries(customShortcuts);
  if (entries.length === 0) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:8px 0">Noch keine eigenen KÃ¼rzel definiert.</div>';
  }

  entries.forEach(([key, shiftId]) => {
    const row = document.createElement('div');
    row.className = 'shortcut-row';
    row.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:8px';

    const st = shiftTypes.find(s => s.id === shiftId);
    const shiftOptions = shiftTypes.map(s =>
      `<option value="${s.id}" ${s.id === shiftId ? 'selected' : ''}>${s.label} â€“ ${s.name}</option>`
    ).join('');

    row.innerHTML = `
      <div style="display:flex;align-items:center;gap:4px;flex:1">
        <span style="font-size:11px;color:var(--text3);white-space:nowrap">Eingabe:</span>
        <input type="text" class="sc-key-inp" value="${escapeHTML(key)}" maxlength="20"
          placeholder="z.B. fr"
          style="width:80px;padding:5px 8px;border-radius:6px;border:1.5px solid var(--border);background:var(--glass2);font-family:monospace;font-size:12px;font-weight:700;color:var(--teal)">
        <span style="font-size:11px;color:var(--text3)">â†’</span>
        <select class="sc-val-inp"
          style="flex:1;padding:5px 8px;border-radius:6px;border:1.5px solid var(--border);background:var(--glass2);font-size:12px;color:var(--text)">
          ${shiftOptions}
        </select>
        ${st ? `<span style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:22px;border-radius:5px;background:${st.bg};color:${st.color};font-size:11px;font-weight:700">${st.label}</span>` : ''}
      </div>
      <button onclick="this.closest('.shortcut-row').remove()" title="LÃ¶schen"
        style="width:28px;height:28px;border-radius:7px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.06);color:#ef4444;cursor:pointer;display:flex;align-items:center;justify-content:center">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    `;
    // Live-update the shift badge when dropdown changes
    row.querySelector('.sc-val-inp').addEventListener('change', function() {
      const newSt = shiftTypes.find(s => s.id === this.value);
      const badge = row.querySelector('[style*="min-width:28px"]');
      if (badge && newSt) {
        badge.style.background = newSt.bg;
        badge.style.color = newSt.color;
        badge.textContent = newSt.label;
      }
    });
    container.appendChild(row);
  });
}

function addCustomShortcut() {
  customShortcuts['neu' + Object.keys(customShortcuts).length] = shiftTypes[0]?.id || 'FD';
  renderShortcutsPanel();
  switchShiftsTab('shortcuts');
  // Focus last input
  setTimeout(() => {
    const inputs = document.querySelectorAll('.sc-key-inp');
    if (inputs.length) inputs[inputs.length - 1].focus();
  }, 50);
}

function _syncCustomShortcutsFromDOM() {
  const rows = document.querySelectorAll('.shortcut-row');
  customShortcuts = {};
  rows.forEach(row => {
    const key = row.querySelector('.sc-key-inp')?.value?.toLowerCase()?.trim();
    const val = row.querySelector('.sc-val-inp')?.value?.trim();
    if (key && val && key.length > 0) {
      customShortcuts[key] = val;
    }
  });
}

init();
</script>

<!-- Multi-selection floating action bar -->
<div id="multi-sel-bar" class="multi-sel-bar" style="display:none">
  <span class="multi-sel-badge" id="multi-sel-count">0 Zellen</span>
  <span style="color:rgba(255,255,255,0.5)">ausgewÃ¤hlt â€“</span>
  <button class="multi-sel-action primary" onclick="applyShiftToSelection()">âœ“ Dienst eintragen</button>
  <button class="multi-sel-action" onclick="clearShiftSelection()">â¬œ Leeren</button>
  <button class="multi-sel-action danger" onclick="deleteSelection()">ðŸ—‘ Alle lÃ¶schen</button>
  <button class="multi-sel-action" onclick="clearMultiSel()" style="opacity:0.6" title="Auswahl aufheben (Esc)">âœ•</button>
</div>

<!-- Keyboard input buffer -->
<div id="kb-buffer-toast"></div>

<!-- Employee hover tooltip -->
<div id="emp-tooltip">
  <div class="emp-tt-card">
    <div class="emp-tt-header">
      <div class="emp-tt-name" id="emp-tt-name">â€”</div>
      <div class="emp-tt-role" id="emp-tt-role">â€”</div>
    </div>
    <div class="emp-tt-body">
      <div class="emp-tt-stat">
        <div class="emp-tt-stat-label">Stellenanteil</div>
        <div class="emp-tt-stat-val" id="emp-tt-vz">â€”</div>
      </div>
      <div class="emp-tt-stat">
        <div class="emp-tt-stat-label">WE-Gruppe</div>
        <div class="emp-tt-stat-val" id="emp-tt-we">â€”</div>
      </div>
      <div class="emp-tt-stat">
        <div class="emp-tt-stat-label">IST / SOLL</div>
        <div class="emp-tt-stat-val" id="emp-tt-hours">â€”</div>
      </div>
      <div class="emp-tt-stat">
        <div class="emp-tt-stat-label">Differenz</div>
        <div class="emp-tt-stat-val" id="emp-tt-diff">â€”</div>
      </div>
    </div>
    <div class="emp-tt-badges" id="emp-tt-shift-badges"></div>
    <div class="emp-tt-prefs" id="emp-tt-prefs-wrap" style="display:none">
      <div class="emp-tt-prefs-label">âœ¦ KI-PrÃ¤ferenzen</div>
      <div id="emp-tt-prefs">â€”</div>
    </div>
  </div>
</div>
</body>
</html>
